<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√îTE - Word Bomb 2.0</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="dictionary.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
</head>
<body>
    <div style="width: 100%;">
        <div class="dashboard">
            
            <!-- PANNEAU LAT√âRAL -->
            <div class="panel-side">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="margin:0; font-size: clamp(1rem, 3vw, 1.2rem);">SALLE</h3>
                    <span id="room-code" class="mono" style="color:var(--accent); font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 800;">...</span>
                </div>
                <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin-bottom: 15px;">

                <!-- CONFIGURATION H√îTE -->
                <div id="host-config" style="margin-bottom: 15px;">
                    <div class="settings-title">üëë Configuration H√¥te</div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">L'h√¥te joue</span>
                            <span class="setting-label-sub">Participer √† la partie</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="host-plays-check" onchange="toggleHostPlays()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="host-player-setup" style="display: none; margin-top: 12px; padding: clamp(10px, 2vw, 12px); background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3);">
                        <input type="text" id="host-name" placeholder="Votre pseudo" maxlength="12" value="H√îTE" style="margin-bottom: 10px; font-size: clamp(0.85rem, 2vw, 0.9rem); padding: 10px;">
                        
                        <label style="display: block; margin-bottom: 6px; font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-muted);">Avatar :</label>
                        <div class="picker-grid" id="host-emoji-picker" style="margin-bottom: 10px;">
                            <!-- Rempli par JS -->
                        </div>
                        
                        <label style="display: block; margin-bottom: 6px; font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-muted);">Couleur :</label>
                        <div class="picker-grid" id="host-color-picker">
                            <!-- Rempli par JS -->
                        </div>
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin-bottom: 15px;">

                <!-- MODE DE JEU -->
                <div id="config-panel">
                    <div class="settings-title">üéÆ Mode de Jeu</div>
                    
                    <div class="mode-selector" id="mode-selector">
                        <div class="mode-option selected" data-mode="classic" onclick="selectMode('classic')">
                            <div class="mode-icon">‚ö°</div>
                            <div class="mode-name">Classique</div>
                            <div class="mode-desc">Syllabes vari√©es</div>
                        </div>
                        <div class="mode-option" data-mode="fast" onclick="selectMode('fast')">
                            <div class="mode-icon">üöÄ</div>
                            <div class="mode-name">Rapide</div>
                            <div class="mode-desc">Temps r√©duit</div>
                        </div>
                        <div class="mode-option" data-mode="survival" onclick="selectMode('survival')">
                            <div class="mode-icon">üíÄ</div>
                            <div class="mode-name">Survie</div>
                            <div class="mode-desc">Une seule vie</div>
                        </div>
                        <div class="mode-option" data-mode="marathon" onclick="selectMode('marathon')">
                            <div class="mode-icon">üèÉ</div>
                            <div class="mode-name">Marathon</div>
                            <div class="mode-desc">Points, pas d'√©lim.</div>
                        </div>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin: 15px 0;">

                    <div class="settings-title">‚öôÔ∏è Param√®tres</div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Vies</span>
                            <span class="setting-label-sub">Nombre de vies par joueur</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                            <input type="range" min="1" max="5" value="2" id="lives-range" oninput="updateSettings('lives', this.value)">
                            <span id="lbl-lives" style="min-width: 20px; font-weight: 700; color: var(--primary);">2</span>
                        </div>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Temps</span>
                            <span class="setting-label-sub">Dur√©e du chronom√®tre</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                            <input type="range" min="5" max="60" value="20" id="time-range" oninput="updateSettings('startTime', this.value)">
                            <span id="lbl-time" style="min-width: 35px; font-weight: 700; color: var(--primary);">20s</span>
                        </div>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin: 15px 0;">

                    <div class="settings-title">üé® Fonctionnalit√©s</div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Chat</span>
                            <span class="setting-label-sub">Messages entre joueurs</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="chat-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">R√©actions</span>
                            <span class="setting-label-sub">Emojis de r√©action</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="reactions-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Sons</span>
                            <span class="setting-label-sub">Effets sonores</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="sounds-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin: 15px 0;">
                
                <!-- LISTE DES JOUEURS -->
                <div style="flex:1; overflow:hidden; display:flex; flex-direction:column; min-height: 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items: center;">
                        <span style="font-weight: 600; font-size: clamp(0.85rem, 2vw, 0.9rem);">JOUEURS (<span id="p-count">0</span>)</span>
                        <span style="font-size:clamp(0.7rem, 1.8vw, 0.75rem); opacity:0.5;">PING</span>
                    </div>
                    <div id="lobby-list" style="flex:1; overflow-y:auto;">
                        <!-- Rempli par JS -->
                    </div>
                </div>

                <button class="btn success" id="start-btn" onclick="startGame()" disabled style="margin-top: 15px;">
                    LANCER LA PARTIE
                </button>
            </div>

            <!-- PANNEAU PRINCIPAL -->
            <div class="panel-main">
                
                <!-- √âCRAN D'ATTENTE -->
                <div id="wait-screen" style="text-align:center; width: 100%;">
                    <div style="font-size: clamp(3.5rem, 10vw, 5rem); margin-bottom: 20px;" class="pulse">üí£</div>
                    <h1 style="margin-bottom: 10px; font-size: clamp(1.5rem, 5vw, 2.5rem);">EN ATTENTE DE JOUEURS</h1>
                    <p style="color:var(--text-muted); font-size: clamp(1rem, 3vw, 1.2rem); margin-bottom: 40px; line-height: 1.5;">
                        Code de la salle : <span id="wait-room-code" class="mono" style="color: var(--accent); font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 800;">XXXX</span>
                    </p>

                    <!-- Affichage de tous les joueurs en attente -->
                    <div id="waiting-players-display" style="max-width: 800px; margin: 0 auto;">
                        <!-- Rempli par JS -->
                    </div>

                    <div style="margin-top: 40px; padding: clamp(15px, 3vw, 20px); background: rgba(0, 0, 0, 0.2); border-radius: 12px; max-width: 600px; margin-left: auto; margin-right: auto;">
                        <h3 style="margin-bottom: 15px; color: var(--primary); font-size: clamp(1rem, 3vw, 1.2rem);">Comment jouer ?</h3>
                        <ul style="text-align: left; color: var(--text-muted); line-height: 1.8; font-size: clamp(0.85rem, 2vw, 0.95rem); padding-left: 20px;">
                            <li>Trouvez un mot contenant la syllabe affich√©e</li>
                            <li>Tapez votre r√©ponse avant la fin du chrono</li>
                            <li>Chaque mot ne peut √™tre utilis√© qu'une fois</li>
                            <li>Perdez une vie si vous ne r√©pondez pas √† temps</li>
                            <li>Le dernier joueur en vie gagne !</li>
                        </ul>
                    </div>
                </div>

                <!-- √âCRAN DE JEU -->
                <div id="game-screen" style="display:none; width:100%; height:100%; flex-direction:column; align-items:center; justify-content:center;">
                    
                    <h2 id="turn-indicator" style="letter-spacing: 2px; color: var(--primary); margin-bottom: 20px; font-size: clamp(1rem, 3vw, 1.5rem);">TOUR DE...</h2>
                    
                    <div class="syllable-box" id="syllable-display">---</div>

                    <div class="timer-track">
                        <div class="timer-fill" id="timer-bar"></div>
                    </div>

                    <div class="grid-container" id="game-grid"></div>
                </div>

                <!-- INPUT H√îTE (si l'h√¥te joue) -->
                <div id="host-input-overlay">
                    <input type="text" id="host-word" placeholder="Votre mot..." autocomplete="off">
                    <button class="btn" style="width:auto; padding: 12px 24px;" onclick="hostSubmit()">ENVOYER</button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Configuration
        const AVAILABLE_EMOJIS = ['üëë', 'üî•', '‚ö°', 'üåü', 'üéØ', 'üöÄ', 'üíé', 'ü¶Ñ', 'üêâ', 'üéÆ', 'üé®', 'üé≠', 'üé™', 'üé∏', '‚öΩ', 'üèÄ', 'üé≥', 'üé≤', 'üÉè', 'üéπ'];
        const AVAILABLE_COLORS = ['#ef4444', '#f59e0b', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e'];

        let hostEmoji = 'üëë';
        let hostColor = '#6366f1';

        // LOGIQUE H√îTE
        const ROOM_ID = Math.random().toString(36).substring(2, 6).toUpperCase();
        document.getElementById('room-code').innerText = ROOM_ID;
        document.getElementById('wait-room-code').innerText = ROOM_ID;

        // Configuration
        let settings = { 
            lives: 2, 
            startTime: 20,
            mode: 'classic',
            chatEnabled: true,
            reactionsEnabled: true,
            soundsEnabled: true
        };

        let state = {
            status: 'LOBBY',
            players: {},
            queue: [],
            turnIdx: 0,
            syllable: "",
            usedWords: new Set(),
            timeLeft: 0,
            maxTime: 0,
            currentRound: 0
        };

        let timerInt;
        let pingInt;
        let DICTIONARY = new Set();

        window.addEventListener('dictionaryReady', () => {
            DICTIONARY = window.DICTIONARY_DATA;
            console.log('‚úÖ Dictionnaire pr√™t pour le jeu:', DICTIONARY.size, 'mots');
        });

        if(window.DICTIONARY_DATA && window.DICTIONARY_DATA.size > 0) {
            DICTIONARY = window.DICTIONARY_DATA;
        }

        // PeerJS
        const peer = new Peer("WB2-HOST-" + ROOM_ID);
        
        peer.on('open', (id) => {
            console.log('üéÆ Host Ready:', id);
            gsap.from('#wait-screen', {opacity: 0, y: 30, duration: 0.8, ease: 'power3.out'});
        });
        
        peer.on('connection', (conn) => {
            conn.on('open', () => {
                conn.send({type: 'WELCOME', settings});
                
                conn.on('data', (data) => {
                    handleData(conn.peer, data, conn);
                });

                conn.on('close', () => {
                    if(state.players[conn.peer]) {
                        delete state.players[conn.peer];
                        updateLobbyUI();
                        if(state.status === 'PLAYING') {
                            updateGameGrid();
                            checkWinCondition();
                        }
                    }
                });
            });
        });

        function handleData(id, data, conn) {
            if(data.type === 'JOIN') {
                if(state.status !== 'LOBBY') {
                    conn.send({type: 'ERROR', msg: 'Partie en cours'});
                    return;
                }
                state.players[id] = {
                    id, 
                    name: data.name.substring(0, 12), 
                    emoji: data.emoji || 'üòé',
                    color: data.color || '#6366f1',
                    lives: settings.lives, 
                    alive: true, 
                    conn, 
                    ping: 0, 
                    isHost: false
                };
                updateLobbyUI();
                broadcastLobbyUpdate();
                
                gsap.from(`#lobby-player-${id}`, {x: -50, opacity: 0, duration: 0.5, ease: 'back.out(1.7)'});
            }

            if(data.type === 'PONG') {
                const now = Date.now();
                const latency = now - data.ts;
                if(state.players[id]) {
                    state.players[id].ping = latency;
                    updatePingUI(id);
                }
            }

            if(data.type === 'WORD') {
                processWord(id, data.word);
            }
        }

        function toggleHostPlays() {
            const isChecked = document.getElementById('host-plays-check').checked;
            const setupDiv = document.getElementById('host-player-setup');
            
            if(isChecked) {
                setupDiv.style.display = 'block';
                gsap.from(setupDiv, {height: 0, opacity: 0, duration: 0.3});
            } else {
                gsap.to(setupDiv, {
                    height: 0, 
                    opacity: 0, 
                    duration: 0.3,
                    onComplete: () => {
                        setupDiv.style.display = 'none';
                    }
                });
            }
        }

        function initHostPickers() {
            const emojiPicker = document.getElementById('host-emoji-picker');
            const colorPicker = document.getElementById('host-color-picker');

            AVAILABLE_EMOJIS.forEach((emoji, idx) => {
                const div = document.createElement('div');
                div.className = 'picker-item' + (emoji === 'üëë' ? ' selected' : '');
                div.textContent = emoji;
                div.onclick = () => selectHostEmoji(emoji, div);
                emojiPicker.appendChild(div);
            });

            AVAILABLE_COLORS.forEach((color, idx) => {
                const div = document.createElement('div');
                div.className = 'picker-item color-picker-item' + (color === '#6366f1' ? ' selected' : '');
                div.style.backgroundColor = color;
                div.onclick = () => selectHostColor(color, div);
                colorPicker.appendChild(div);
            });
        }

        function selectHostEmoji(emoji, element) {
            hostEmoji = emoji;
            document.querySelectorAll('#host-emoji-picker .picker-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            gsap.from(element, {scale: 0.7, duration: 0.2, ease: 'back.out(2)'});
        }

        function selectHostColor(color, element) {
            hostColor = color;
            document.querySelectorAll('#host-color-picker .picker-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            gsap.from(element, {scale: 0.7, duration: 0.2, ease: 'back.out(2)'});
        }

        function selectMode(mode) {
            settings.mode = mode;
            document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
            
            switch(mode) {
                case 'fast':
                    document.getElementById('time-range').value = 10;
                    updateSettings('startTime', 10);
                    break;
                case 'survival':
                    document.getElementById('lives-range').value = 1;
                    updateSettings('lives', 1);
                    break;
                case 'marathon':
                    document.getElementById('lives-range').value = 99;
                    updateSettings('lives', 99);
                    break;
                default:
                    document.getElementById('time-range').value = 20;
                    document.getElementById('lives-range').value = 2;
                    updateSettings('startTime', 20);
                    updateSettings('lives', 2);
            }
            
            gsap.from(`.mode-option[data-mode="${mode}"]`, {scale: 0.9, duration: 0.2, ease: 'back.out(2)'});
        }

        function startGame() {
            settings.chatEnabled = document.getElementById('chat-enabled').checked;
            settings.reactionsEnabled = document.getElementById('reactions-enabled').checked;
            settings.soundsEnabled = document.getElementById('sounds-enabled').checked;

            const hostPlays = document.getElementById('host-plays-check').checked;
            if(hostPlays) {
                const hostName = document.getElementById('host-name').value.trim() || 'H√îTE';
                state.players['HOST'] = {
                    id: 'HOST', 
                    name: hostName, 
                    emoji: hostEmoji,
                    color: hostColor,
                    lives: settings.lives, 
                    alive: true, 
                    conn: null, 
                    ping: 0, 
                    isHost: true
                };
            }

            const playerCount = Object.keys(state.players).length;
            if(playerCount < 2) {
                alert("Il faut au moins 2 joueurs pour commencer !");
                return;
            }

            state.status = 'PLAYING';
            state.queue = Object.keys(state.players);
            state.usedWords.clear();
            state.currentRound = 0;
            
            document.getElementById('start-btn').disabled = true;
            document.getElementById('wait-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('config-panel').style.opacity = '0.5';
            document.getElementById('config-panel').style.pointerEvents = 'none';

            gsap.from('#game-screen', {opacity: 0, scale: 0.95, duration: 0.8, ease: 'power3.out'});

            if(hostPlays) {
                document.getElementById('host-input-overlay').style.display = 'flex';
                gsap.from('#host-input-overlay', {y: 50, opacity: 0, duration: 0.5, delay: 0.3});
                
                document.getElementById('host-word').addEventListener('keydown', e => {
                    if(e.key === 'Enter') hostSubmit();
                });
            }

            broadcast({type: 'GAME_START', players: cleanPlayerList()});
            updateGameGrid();

            startPingLoop();
            
            setTimeout(() => {
                nextTurn();
            }, 1000);
        }

        function nextTurn() {
            if(checkWinCondition()) return;

            let attempts = 0;
            do {
                state.turnIdx = (state.turnIdx + 1) % state.queue.length;
                attempts++;
                if(attempts > 100) {
                    console.error('Boucle infinie d√©tect√©e');
                    return;
                }
            } while (!state.players[state.queue[state.turnIdx]].alive);

            state.currentRound++;
            const activeId = state.queue[state.turnIdx];
            const activePlayer = state.players[activeId];
            
            state.syllable = generateSyllable();
            state.maxTime = settings.startTime;
            state.timeLeft = state.maxTime;

            updateGameUI(activeId);

            broadcast({
                type: 'NEW_TURN', 
                player: activeId, 
                playerName: activePlayer.name,
                syllable: state.syllable, 
                maxTime: state.maxTime,
                round: state.currentRound
            });

            broadcast({
                type: 'PLAYERS_UPDATE',
                players: cleanPlayerList()
            });

            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                state.timeLeft -= 0.1;
                updateTimerVisual();
                
                if(Math.round(state.timeLeft * 10) % 10 === 0) {
                     broadcast({type: 'SYNC_TIME', time: state.timeLeft});
                }

                if(state.timeLeft <= 0) {
                    clearInterval(timerInt);
                    punishPlayer(activeId);
                }
            }, 100);
        }

        function processWord(pid, wordRaw) {
            if(state.status !== 'PLAYING') return;
            if(state.queue[state.turnIdx] !== pid) return;

            const word = wordRaw.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            let error = null;

            if(!word.includes(state.syllable)) {
                error = `Syllabe "${state.syllable}" manquante !`;
            } else if(state.usedWords.has(word)) {
                error = "D√©j√† utilis√© !";
            } else if(DICTIONARY.size === 0) {
                error = "Dictionnaire non charg√©";
            } else if(!DICTIONARY.has(word)) {
                error = "Inconnu au bataillon";
            }

            if(error) {
                sendTo(pid, {type: 'FEEDBACK', valid: false, msg: error});
                gsap.to("#syllable-display", {x:10, yoyo:true, repeat:3, duration:0.05});
            } else {
                clearInterval(timerInt);
                state.usedWords.add(word);
                sendTo(pid, {type: 'FEEDBACK', valid: true});
                
                gsap.to("#syllable-display", {
                    scale:1.3, 
                    color: '#10b981',
                    yoyo:true, 
                    repeat:1, 
                    duration:0.15,
                    onComplete: () => {
                        gsap.set("#syllable-display", {color: 'var(--text-main)'});
                    }
                });
                
                setTimeout(nextTurn, 800);
            }
        }

        function punishPlayer(pid) {
            const p = state.players[pid];
            if(!p) return;

            p.lives--;
            broadcast({type: 'HIT', player: pid, lives: p.lives});
            
            const card = document.getElementById(`card-${pid}`);
            if(card) {
                gsap.to(card, {
                    x: -5,
                    yoyo: true,
                    repeat: 5,
                    duration: 0.08,
                    ease: 'power1.inOut'
                });
            }
            
            if(p.lives <= 0) {
                p.alive = false;
                broadcast({type: 'ELIMINATED', player: pid});
                
                if(card) {
                    gsap.to(card, {
                        opacity: 0.4,
                        filter: 'grayscale(1)',
                        scale: 0.95,
                        duration: 0.5
                    });
                }
            }

            updateGameGrid();
            
            if(!checkWinCondition()) {
                setTimeout(nextTurn, 1500);
            }
        }

        function checkWinCondition() {
            const alive = Object.values(state.players).filter(p => p.alive);
            
            if(alive.length === 1) {
                handleWin(alive[0].id);
                return true;
            } else if(alive.length === 0) {
                handleWin(null);
                return true;
            }
            return false;
        }

        function handleWin(winnerId) {
            clearInterval(timerInt);
            clearInterval(pingInt);
            state.status = 'END';
            
            const wName = winnerId ? state.players[winnerId].name : "PERSONNE";
            document.getElementById('syllable-display').innerText = "üèÜ";
            document.getElementById('turn-indicator').innerText = "VICTOIRE DE " + wName.toUpperCase();
            
            gsap.from('#syllable-display', {
                scale: 0,
                rotation: 720,
                duration: 1,
                ease: 'back.out(1.7)'
            });
            
            broadcast({type: 'GAME_OVER', winner: wName});
        }

        function generateSyllable() {
            const syls = ["AR", "BO", "CH", "DI", "EN", "FR", "GR", "JU", "KI", "LI", "MA", "NO", "ON", "PA", "QU", "RE", "SI", "TI", "UR", "VI", "WA", "TER", "PRO", "CON", "AN", "BLE", "TION", "MENT"];
            return syls[Math.floor(Math.random() * syls.length)];
        }

        function hostSubmit() {
            const el = document.getElementById('host-word');
            if(el.value.trim()) {
                processWord('HOST', el.value);
                el.value = '';
            }
        }

        function updateSettings(key, val) {
            settings[key] = parseInt(val);
            if(key === 'lives') {
                document.getElementById('lbl-lives').innerText = val;
            }
            if(key === 'startTime') {
                document.getElementById('lbl-time').innerText = val + 's';
            }
            
            if(state.status === 'LOBBY') {
                broadcast({type: 'SETTINGS_UPDATE', settings});
            }
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobby-list');
            const waitingDisplay = document.getElementById('waiting-players-display');
            
            list.innerHTML = "";
            waitingDisplay.innerHTML = "";
            
            let count = 0;
            const allPlayers = [];
            
            Object.values(state.players).forEach(p => {
                if(p.isHost) return;
                count++;
                allPlayers.push(p);
                
                const div = document.createElement('div');
                div.id = `lobby-player-${p.id}`;
                div.className = 'lobby-player-item';
                div.innerHTML = `
                    <div class="lobby-player-avatar" style="border-color: ${p.color};">
                        ${p.emoji}
                    </div>
                    <div class="lobby-player-info">
                        <div class="lobby-player-name">${p.name}</div>
                        <div class="lobby-player-ping" id="ping-${p.id}" style="color: ${getPingColor(p.ping)}">
                            ${p.ping ? p.ping + 'ms' : '...'}
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
            
            if(allPlayers.length > 0) {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid-container';
                gridDiv.style.maxHeight = 'none';
                
                allPlayers.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'player-card';
                    card.style.animation = 'slideInRight 0.5s ease-out';
                    card.innerHTML = `
                        <div class="p-color-badge" style="background-color: ${p.color};"></div>
                        <div class="p-avatar">${p.emoji}</div>
                        <div class="p-name">${p.name}</div>
                        <div style="font-size: clamp(0.7rem, 1.8vw, 0.75rem); color: var(--text-muted); margin-top: 5px;">
                            ${p.ping ? p.ping + 'ms' : 'Connexion...'}
                        </div>
                    `;
                    gridDiv.appendChild(card);
                });
                
                waitingDisplay.appendChild(gridDiv);
            }
            
            document.getElementById('p-count').innerText = count;
            document.getElementById('start-btn').disabled = count < 1;
        }

        function broadcastLobbyUpdate() {
            broadcast({
                type: 'LOBBY_UPDATE',
                players: cleanPlayerList()
            });
        }

        function updatePingUI(id) {
            const el = document.getElementById(`ping-${id}`);
            if(el && state.players[id]) {
                el.innerText = state.players[id].ping + "ms";
                el.style.color = getPingColor(state.players[id].ping);
            }
        }

        function updateGameGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = "";
            
            state.queue.forEach(pid => {
                const p = state.players[pid];
                if(!p) return;
                
                const div = document.createElement('div');
                div.className = `player-card ${!p.alive ? 'eliminated' : ''}`;
                div.id = `card-${pid}`;
                div.innerHTML = `
                    <div class="p-color-badge" style="background-color: ${p.color};"></div>
                    <div class="p-ping" style="color:${getPingColor(p.ping)}">${p.isHost ? 'üëë' : p.ping + 'ms'}</div>
                    <div class="p-avatar">${p.emoji}</div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-lives">${p.lives > 0 ? "‚ù§Ô∏è".repeat(Math.min(p.lives, 5)) : "üíÄ"}</div>
                `;
                grid.appendChild(div);
            });
        }

        function updateGameUI(activePid) {
            document.getElementById('syllable-display').innerText = state.syllable;
            const pName = state.players[activePid].name;
            document.getElementById('turn-indicator').innerText = `TOUR DE ${pName.toUpperCase()}`;
            
            document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active'));
            const c = document.getElementById(`card-${activePid}`);
            if(c) {
                c.classList.add('active');
                gsap.from(c, {scale: 0.95, duration: 0.3, ease: 'back.out(2)'});
            }

            if(activePid === 'HOST') {
                setTimeout(() => {
                    document.getElementById('host-word').focus();
                }, 100);
            }
        }

        function updateTimerVisual() {
            const pct = Math.max(0, (state.timeLeft / state.maxTime) * 100);
            document.getElementById('timer-bar').style.width = pct + "%";
        }

        function getPingColor(ms) {
            if(ms < 50) return "var(--success)";
            if(ms < 150) return "var(--warning)";
            return "var(--danger)";
        }

        function sendTo(pid, msg) {
            if(pid === 'HOST') return;
            const p = state.players[pid];
            if(p && p.conn) p.conn.send(msg);
        }

        function broadcast(msg) {
            Object.values(state.players).forEach(p => {
                if(!p.isHost && p.conn) p.conn.send(msg);
            });
        }

        function cleanPlayerList() {
            return Object.values(state.players).map(p => ({
                id: p.id, 
                name: p.name, 
                emoji: p.emoji, 
                color: p.color,
                lives: p.lives, 
                alive: p.alive,
                ping: p.ping
            }));
        }

        function startPingLoop() {
            pingInt = setInterval(() => {
                const now = Date.now();
                broadcast({type: 'PING', ts: now});
            }, 2000);
        }

        initHostPickers();

        gsap.from('.panel-side', {x: -50, opacity: 0, duration: 0.8, ease: 'power3.out', delay: 0.2});
        gsap.from('.panel-main', {x: 50, opacity: 0, duration: 0.8, ease: 'power3.out', delay: 0.2});
    </script>
</body>
</html>
