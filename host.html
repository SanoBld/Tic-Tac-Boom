<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>HOST - Word Bomb</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="dictionary.js"></script>
</head>
<body>
    <div class="header-info">
        <div class="room-badge">CODE: <span id="room-code" style="color:white; font-weight:900;">...</span></div>
        <div id="player-count">0 JOUEURS</div>
    </div>

    <div class="container" id="main-container">
        
        <div id="lobby-panel" class="card">
            <h2>CONFIGURATION</h2>
            
            <div style="text-align: left; margin: 20px 0;">
                <label style="display:block; margin-bottom:5px; color:var(--text-muted); font-size:0.9rem;">VIES PAR JOUEUR : <span id="disp-lives" style="color:white">2</span></label>
                <input type="range" min="1" max="10" value="2" style="width:100%; accent-color:var(--primary)" oninput="settings.lives = parseInt(this.value); document.getElementById('disp-lives').innerText=this.value">
                
                <label style="display:block; margin-top:15px; margin-bottom:5px; color:var(--text-muted); font-size:0.9rem;">CHRONO INITIAL : <span id="disp-time" style="color:white">20s</span></label>
                <input type="range" min="5" max="60" value="20" style="width:100%; accent-color:var(--accent)" oninput="settings.startTime = parseInt(this.value); document.getElementById('disp-time').innerText=this.value + 's'">

                <div style="margin-top: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 0.9rem;">üéÆ L'H√¥te participe ?</span>
                    <input type="checkbox" id="host-plays-check" style="width: 20px; height: 20px; accent-color: var(--success);">
                </div>
            </div>

            <div id="dict-status" style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 10px;">Chargement dictionnaire...</div>
            <button class="btn" id="start-btn" onclick="launchGame()" disabled>LANCER LA PARTIE</button>
        </div>

        <div id="game-ui" style="display:none; width: 100%; flex-direction: column; align-items: center;">
            
            <h3 id="turn-info" style="opacity: 0.7; letter-spacing: 2px;">EN ATTENTE</h3>
            
            <div class="syllable-display" id="syllable" data-text="---">---</div>
            
            <div class="timer-wrap">
                <div class="timer-text" id="timer-text">0.0s</div>
                <div class="timer-bar" id="timer-bar"></div>
            </div>

            <div class="grid-wrapper">
                <div class="grid" id="players-grid">
                    </div>
            </div>
        </div>
    </div>

    <div id="host-input-area">
        <input type="text" id="host-word-input" placeholder="Votre mot..." style="max-width: 300px; margin: 0;" autocomplete="off">
        <button class="btn" style="width: auto; margin: 0;" onclick="hostSubmit()">OK</button>
    </div>

    <script>
        // --- ETAT GLOBAL ---
        const settings = { lives: 2, startTime: 20 };
        const STATE = { LOBBY: 0, PLAYING: 1, END: 2 };
        let currentState = STATE.LOBBY;
        
        // Donn√©es jeu
        let dictionary = new Set();
        let usedWords = new Set();
        let players = {}; // id -> {name, emoji, lives, alive, conn}
        let turnQueue = [];
        let currentTurnIdx = 0;
        let currentSyllable = "";
        
        // Timers
        let gameTimer;
        let timeLeft = 0;
        let maxTime = 0;
        let broadcastInterval;

        // PeerJS
        const ROOM_ID = Math.random().toString(36).substring(2, 6).toUpperCase();
        document.getElementById('room-code').innerText = ROOM_ID;
        const peer = new Peer("WB-HOST-" + ROOM_ID);

        // --- INITIALISATION ---

        // 1. Charger Dictionnaire Local
        window.addEventListener('dictionaryReady', () => {
    if(window.DICTIONARY_DATA && window.DICTIONARY_DATA.length > 0) {
        dictionary = new Set(window.DICTIONARY_DATA);
        document.getElementById('dict-status').innerText = `‚úÖ ${dictionary.size} mots pr√™ts.`;
        document.getElementById('dict-status').style.color = "var(--success)";
        document.getElementById('start-btn').disabled = false;
    }
});

        // 2. Gestion R√©seau
        peer.on('connection', (conn) => {
            conn.on('open', () => {
                conn.send({type: 'WELCOME', settings: settings});
                
                conn.on('data', (data) => {
                    if(data.type === 'JOIN') handleJoin(conn.peer, data, conn);
                    if(data.type === 'WORD') handleWordAttempt(conn.peer, data.word);
                    if(data.type === 'REACTION') showReaction(data.emoji);
                });
            });
        });

        function handleJoin(id, data, conn) {
            if(currentState !== STATE.LOBBY) {
                conn.send({type: 'ERROR', msg: 'Partie en cours'});
                return;
            }
            players[id] = {
                id: id,
                name: data.name.substring(0,10),
                emoji: data.emoji,
                lives: settings.lives,
                alive: true,
                conn: conn, // null si c'est l'h√¥te
                isHost: false
            };
            renderGrid();
            updateCounts();
        }

        // --- BOUCLE DE JEU ---

        function launchGame() {
            // Ajouter l'h√¥te comme joueur si demand√©
            const hostPlays = document.getElementById('host-plays-check').checked;
            if(hostPlays) {
                players['HOST'] = {
                    id: 'HOST', name: 'H√îTE', emoji: 'üëë',
                    lives: settings.lives, alive: true,
                    conn: null, isHost: true
                };
                document.getElementById('host-input-area').classList.add('visible');
                // Focus input h√¥te
                document.getElementById('host-word-input').addEventListener('keydown', (e) => {
                    if(e.key === 'Enter') hostSubmit();
                });
            }

            if(Object.keys(players).length < 2 && !hostPlays) {
               // En mode dev, on peut commenter √ßa, mais mieux vaut 2 joueurs
               // return alert("Il faut au moins 2 joueurs !"); 
            }

            currentState = STATE.PLAYING;
            usedWords.clear();
            turnQueue = Object.keys(players); // M√©langer si besoin
            
            // UI Switch
            document.getElementById('lobby-panel').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            
            broadcast({type: 'GAME_START'});
            renderGrid();

            // Boucle de sync (envoie temps + info active player toutes les 200ms)
            broadcastInterval = setInterval(syncClients, 200);

            nextTurn();
        }

        function nextTurn() {
            // Trouver le prochain vivant
            let loops = 0;
            do {
                currentTurnIdx = (currentTurnIdx + 1) % turnQueue.length;
                loops++;
            } while (!players[turnQueue[currentTurnIdx]].alive && loops < turnQueue.length * 2);

            const activePid = turnQueue[currentTurnIdx];
            const survivors = turnQueue.filter(p => players[p].alive);

            // Condition Victoire
            if(survivors.length <= 1 && turnQueue.length > 1) {
                endGame(survivors[0]);
                return;
            }

            // Setup Tour
            currentSyllable = generateSyllable();
            // Le temps diminue au fur et √† mesure que les mots sont trouv√©s (max -50%)
            maxTime = Math.max(5, settings.startTime * Math.pow(0.98, usedWords.size));
            timeLeft = maxTime;

            // UI Locale
            updateTurnUI(activePid);
            
            // Broadcast "Nouveau Tour" pour eventuels sons/vibrations
            broadcast({type: 'NEW_TURN', player: activePid, syllable: currentSyllable});

            // Input H√¥te ?
            const hostInput = document.getElementById('host-word-input');
            if(activePid === 'HOST') {
                hostInput.disabled = false;
                hostInput.value = '';
                hostInput.focus();
                hostInput.style.borderColor = "var(--primary)";
            } else {
                hostInput.disabled = true;
                hostInput.style.borderColor = "#333";
            }

            // Lancer Chrono
            if(gameTimer) clearInterval(gameTimer);
            gameTimer = setInterval(() => {
                timeLeft -= 0.1;
                updateTimerUI();
                
                if(timeLeft <= 0) {
                    clearInterval(gameTimer);
                    punishPlayer(activePid);
                }
            }, 100);
        }

        // --- LOGIQUE MOTS ---

        function handleWordAttempt(pid, rawWord) {
            // S√©curit√©: est-ce son tour ?
            if(turnQueue[currentTurnIdx] !== pid) return;
            if(currentState !== STATE.PLAYING) return;

            const word = rawWord.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            let error = null;
            
            if(!word.includes(currentSyllable)) error = "Syllabe manquante";
            else if(usedWords.has(word)) error = "D√©j√† utilis√©";
            else if(!dictionary.has(word)) error = "Pas dans le dico";

            if(error) {
                // Feedback N√©gatif
                sendTo(pid, {type: 'FEEDBACK', valid: false, msg: error});
                shakeUI();
            } else {
                // Feedback Positif + Tour Suivant
                clearInterval(gameTimer);
                usedWords.add(word);
                sendTo(pid, {type: 'FEEDBACK', valid: true});
                
                // Petite anim victoire
                gsap.to("#syllable", {scale: 1.2, duration: 0.1, yoyo: true, repeat: 1});
                
                setTimeout(nextTurn, 500);
            }
        }

        function hostSubmit() {
            const input = document.getElementById('host-word-input');
            handleWordAttempt('HOST', input.value);
            input.value = ''; // clean pour UX
        }

        function punishPlayer(pid) {
            players[pid].lives--;
            shakeUI(true); // Grosse secousse
            
            if(players[pid].lives <= 0) {
                players[pid].alive = false;
                sendTo(pid, {type: 'ELIMINATED'});
            } else {
                sendTo(pid, {type: 'HIT', lives: players[pid].lives});
            }
            
            renderGrid();
            setTimeout(nextTurn, 1500);
        }

        function endGame(winnerId) {
            clearInterval(gameTimer);
            clearInterval(broadcastInterval);
            currentState = STATE.END;

            const wName = winnerId ? players[winnerId].name : "PERSONNE";
            document.getElementById('turn-info').innerText = "VICTOIRE";
            document.getElementById('syllable').innerText = "üèÜ";
            document.getElementById('syllable').setAttribute('data-text', 'üèÜ');
            
            broadcast({type: 'GAME_OVER', winner: wName});
            
            // Reload auto apr√®s 10s
            setTimeout(() => location.reload(), 10000);
        }

        // --- UTILS & RENDERING ---

        function generateSyllable() {
            // Simple pour l'exemple. 
            const syls = ["AR", "BO", "CH", "DI", "EN", "FR", "GR", "JU", "KI", "LI", "MA", "NO", "ON", "PA", "QU", "RE", "SI", "TI", "UR", "VI", "WA"];
            return syls[Math.floor(Math.random() * syls.length)];
        }

        function updateTurnUI(pid) {
            const p = players[pid];
            document.getElementById('turn-info').innerText = `TOUR DE ${p.name.toUpperCase()}`;
            const sEl = document.getElementById('syllable');
            sEl.innerText = currentSyllable;
            sEl.setAttribute('data-text', currentSyllable);
            
            // Highlight grille
            renderGrid();
        }

        function updateTimerUI() {
            const pct = Math.max(0, (timeLeft / maxTime) * 100);
            document.getElementById('timer-bar').style.width = pct + "%";
            document.getElementById('timer-text').innerText = Math.ceil(timeLeft) + "s";
        }

        function renderGrid() {
            const container = document.getElementById('players-grid');
            container.innerHTML = "";
            const activeId = currentState === STATE.PLAYING ? turnQueue[currentTurnIdx] : null;

            turnQueue.forEach(pid => {
                const p = players[pid];
                // Ne pas afficher si d√©connect√© avant start (optionnel)
                
                const div = document.createElement('div');
                div.className = `p-card ${p.alive ? '' : 'is-dead'} ${pid === activeId ? 'is-active' : ''}`;
                
                let hearts = "‚ù§Ô∏è".repeat(p.lives);
                if(!p.alive) hearts = "üíÄ";

                div.innerHTML = `
                    <div class="p-avatar">${p.emoji}</div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-lives">${hearts}</div>
                `;
                container.appendChild(div);
            });
        }

        function updateCounts() {
            document.getElementById('player-count').innerText = Object.keys(players).length + " JOUEURS";
        }

        function shakeUI(hard = false) {
            const intensity = hard ? 20 : 5;
            gsap.fromTo("#main-container", {x:-intensity}, {x:intensity, duration:0.05, repeat:5, yoyo:true});
        }

        function showReaction(emoji) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.className = 'float-emoji';
            el.style.left = (10 + Math.random()*80) + "%";
            el.style.top = "80%";
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 2600);
        }

        // --- NETWORKING HELPERS ---
        function sendTo(pid, msg) {
            if(pid === 'HOST') return; // Rien √† envoyer r√©seau, c'est local
            if(players[pid] && players[pid].conn) players[pid].conn.send(msg);
        }

        function broadcast(msg) {
            Object.values(players).forEach(p => {
                if(!p.isHost && p.conn) p.conn.send(msg);
            });
        }
        
        // Fonction critique : synchroniser l'√©tat vers les mobiles
        function syncClients() {
            if(currentState !== STATE.PLAYING) return;
            const data = {
                type: 'SYNC',
                time: Math.ceil(timeLeft),
                maxTime: maxTime,
                activePlayerId: turnQueue[currentTurnIdx],
                count: Object.keys(players).length
            };
            broadcast(data);
        }
    </script>
</body>
</html>