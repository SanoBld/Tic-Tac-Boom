<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>H√îTE - Word Bomb 2.0</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="dictionary.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
</head>
<body>
    <div class="container" style="max-width: 100%; padding: 0;">
        <div class="dashboard">
            
            <div class="panel-side">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0">ROOM: <span id="room-code" class="mono" style="color:var(--accent)">...</span></h3>
                </div>
                <hr style="border:0; border-top:1px solid var(--glass-border); width:100%;">

                <div id="config-panel">
                    <h4 style="margin:10px 0; color:var(--primary-light)">PARAM√àTRES</h4>
                    
                    <div class="setting-row">
                        <span>Vies (<span id="lbl-lives">2</span>)</span>
                        <input type="range" min="1" max="5" value="2" oninput="updateSettings('lives', this.value)">
                    </div>
                    
                    <div class="setting-row" style="margin-top:10px">
                        <span>Temps (<span id="lbl-time">20</span>s)</span>
                        <input type="range" min="5" max="60" value="20" oninput="updateSettings('startTime', this.value)">
                    </div>

                    <div class="setting-row" style="margin-top:15px">
                        <span>H√¥te Joue ?</span>
                        <label class="switch">
                            <input type="checkbox" id="host-plays-check">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--glass-border); width:100%;">
                
                <div style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span>JOUEURS (<span id="p-count">0</span>)</span>
                        <span style="font-size:0.8rem; opacity:0.5">PING</span>
                    </div>
                    <div id="lobby-list" style="flex:1; overflow-y:auto; font-size:0.9rem;">
                        </div>
                </div>

                <button class="btn success" id="start-btn" onclick="startGame()" disabled>LANCER LA PARTIE</button>
            </div>

            <div class="panel-main">
                
                <div id="wait-screen" style="text-align:center;">
                    <h2>EN ATTENTE DE JOUEURS...</h2>
                    <p style="color:var(--text-muted)">Connectez-vous avec le code √† gauche</p>
                </div>

                <div id="game-screen" style="display:none; width:100%; height:100%; flex-direction:column; align-items:center; justify-content:center;">
                    
                    <h2 id="turn-indicator" style="letter-spacing: 2px; color: var(--primary-light)">TOUR DE...</h2>
                    
                    <div class="syllable-box" id="syllable-display">---</div>

                    <div class="timer-track">
                        <div class="timer-fill" id="timer-bar"></div>
                    </div>

                    <div class="grid-container" id="game-grid"></div>
                </div>

                <div id="host-input-overlay" style="position:absolute; bottom:20px; background:var(--bg-dark); padding:15px; border-radius:12px; border:1px solid var(--primary); display:none; gap:10px; box-shadow: 0 -10px 40px rgba(0,0,0,0.5);">
                    <input type="text" id="host-word" placeholder="Taper mot..." autocomplete="off">
                    <button class="btn" style="width:auto;" onclick="hostSubmit()">OK</button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- LOGIQUE H√îTE ---
        const ROOM_ID = Math.random().toString(36).substring(2, 6).toUpperCase();
        document.getElementById('room-code').innerText = ROOM_ID;

        // Configuration
        let settings = { lives: 2, startTime: 20 };
        let state = {
            status: 'LOBBY', // LOBBY, PLAYING, END
            players: {}, // id -> {name, emoji, lives, alive, conn, ping}
            queue: [],
            turnIdx: 0,
            syllable: "",
            usedWords: new Set(),
            timeLeft: 0,
            maxTime: 0
        };

        let timerInt;
        let pingInt;

        // PeerJS
        const peer = new Peer("WB2-HOST-" + ROOM_ID);
        
        peer.on('open', (id) => console.log('Host Ready:', id));
        
        peer.on('connection', (conn) => {
            conn.on('open', () => {
                // Initial Data
                conn.send({type: 'WELCOME', settings});
                
                conn.on('data', (data) => {
                    handleData(conn.peer, data, conn);
                });

                conn.on('close', () => {
                    if(state.players[conn.peer]) {
                        delete state.players[conn.peer];
                        updateLobbyUI();
                        updateGameGrid(); // Si en jeu
                    }
                });
            });
        });

        // Gestion des Messages
        function handleData(id, data, conn) {
            // JOIN
            if(data.type === 'JOIN') {
                if(state.status !== 'LOBBY') {
                    conn.send({type: 'ERROR', msg: 'Partie en cours'});
                    return;
                }
                state.players[id] = {
                    id, name: data.name.substring(0, 12), emoji: data.emoji,
                    lives: settings.lives, alive: true, conn, ping: 0, isHost: false
                };
                updateLobbyUI();
            }

            // PONG (Latence)
            if(data.type === 'PONG') {
                const now = Date.now();
                const latency = now - data.ts;
                if(state.players[id]) state.players[id].ping = latency;
                updatePingUI(id); // Optimisation: update seulement le texte du ping
            }

            // WORD ATTEMPT
            if(data.type === 'WORD') {
                processWord(id, data.word);
            }
        }

        // --- GAME LOOP ---

        function startGame() {
            // Ajouter Host si coch√©
            const hostPlays = document.getElementById('host-plays-check').checked;
            if(hostPlays) {
                state.players['HOST'] = {
                    id: 'HOST', name: 'H√îTE (Moi)', emoji: 'üëë',
                    lives: settings.lives, alive: true, conn: null, ping: 0, isHost: true
                };
                document.getElementById('host-input-overlay').style.display = 'flex';
                document.getElementById('host-word').addEventListener('keydown', e => {
                    if(e.key === 'Enter') hostSubmit();
                });
            }

            if(Object.keys(state.players).length < 2 && !hostPlays) return alert("Pas assez de joueurs !");

            state.status = 'PLAYING';
            state.queue = Object.keys(state.players); // Shuffle possible ici
            state.usedWords.clear();
            
            // UI Switch
            document.getElementById('start-btn').disabled = true;
            document.getElementById('wait-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('config-panel').style.opacity = '0.5';
            document.getElementById('config-panel').style.pointerEvents = 'none';

            broadcast({type: 'GAME_START', players: cleanPlayerList()});
            updateGameGrid();

            startPingLoop(); // Commence √† mesurer la latence
            nextTurn();
        }

        function nextTurn() {
            // Trouver le prochain joueur vivant
            let loops = 0;
            do {
                state.turnIdx = (state.turnIdx + 1) % state.queue.length;
                loops++;
            } while (!state.players[state.queue[state.turnIdx]].alive && loops < state.queue.length * 2);

            const activeId = state.queue[state.turnIdx];
            const survivors = state.queue.filter(p => state.players[p].alive);

            // Victoire ?
            if(survivors.length <= 1 && state.queue.length > 1) {
                handleWin(survivors[0]);
                return;
            }

            // Setup Tour
            state.syllable = generateSyllable();
            state.maxTime = Math.max(3, settings.startTime * Math.pow(0.98, state.usedWords.size));
            state.timeLeft = state.maxTime;

            // UI
            updateGameUI(activeId);
            broadcast({type: 'NEW_TURN', player: activeId, syllable: state.syllable, maxTime: state.maxTime});

            // Input Host Focus
            if(activeId === 'HOST') {
                document.getElementById('host-word').disabled = false;
                document.getElementById('host-word').focus();
            } else {
                document.getElementById('host-word').disabled = true;
            }

            // Timer
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                state.timeLeft -= 0.1;
                updateTimerVisual();
                
                // Sync Timer aux clients toutes les sec (pour recalibrer)
                if(Math.round(state.timeLeft * 10) % 10 === 0) {
                     broadcast({type: 'SYNC_TIME', time: state.timeLeft});
                }

                if(state.timeLeft <= 0) {
                    clearInterval(timerInt);
                    punishPlayer(activeId);
                }
            }, 100);
        }

        function processWord(pid, wordRaw) {
            // V√©rifications basiques
            if(state.status !== 'PLAYING') return;
            if(state.queue[state.turnIdx] !== pid) return;

            const word = wordRaw.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            let error = null;

            if(!word.includes(state.syllable)) error = `Syllabe "${state.syllable}" manquante !`;
            else if(state.usedWords.has(word)) error = "D√©j√† utilis√© !";
            else if(!window.DICTIONARY.has(word)) error = "Inconnu au bataillon";

            if(error) {
                sendTo(pid, {type: 'FEEDBACK', valid: false, msg: error});
                gsap.to(".syllable-box", {x:10, yoyo:true, repeat:3, duration:0.05});
            } else {
                // Success
                clearInterval(timerInt);
                state.usedWords.add(word);
                sendTo(pid, {type: 'FEEDBACK', valid: true});
                gsap.to("#syllable-display", {scale:1.4, yoyo:true, repeat:1, duration:0.1});
                
                setTimeout(nextTurn, 500); // Petit d√©lai pour voir la validation
            }
        }

        function punishPlayer(pid) {
            const p = state.players[pid];
            p.lives--;
            broadcast({type: 'HIT', player: pid, lives: p.lives});
            
            if(p.lives <= 0) {
                p.alive = false;
                broadcast({type: 'ELIMINATED', player: pid});
            }

            updateGameGrid();
            setTimeout(nextTurn, 1500);
        }

        function handleWin(winnerId) {
            clearInterval(timerInt);
            clearInterval(pingInt);
            state.status = 'END';
            
            const wName = winnerId ? state.players[winnerId].name : "PERSONNE";
            document.getElementById('syllable-display').innerText = "üèÜ";
            document.getElementById('turn-indicator').innerText = "VICTOIRE DE " + wName;
            
            broadcast({type: 'GAME_OVER', winner: wName});
        }

        // --- UTILS ---
        function generateSyllable() {
            const syls = ["AR", "BO", "CH", "DI", "EN", "FR", "GR", "JU", "KI", "LI", "MA", "NO", "ON", "PA", "QU", "RE", "SI", "TI", "UR", "VI", "WA", "TER", "PRO", "CON"];
            return syls[Math.floor(Math.random() * syls.length)];
        }

        function hostSubmit() {
            const el = document.getElementById('host-word');
            processWord('HOST', el.value);
            el.value = '';
        }

        // --- UPDATE UI ---
        function updateSettings(key, val) {
            settings[key] = parseInt(val);
            if(key === 'lives') document.getElementById('lbl-lives').innerText = val;
            if(key === 'startTime') document.getElementById('lbl-time').innerText = val;
            
            // Envoyer maj aux clients dans le lobby
            if(state.status === 'LOBBY') broadcast({type: 'SETTINGS_UPDATE', settings});
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobby-list');
            list.innerHTML = "";
            let count = 0;
            
            Object.values(state.players).forEach(p => {
                if(p.isHost) return; // Pas afficher l'h√¥te dans la liste d'attente
                count++;
                const div = document.createElement('div');
                div.style.padding = "8px";
                div.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
                div.style.display = "flex"; div.style.justifyContent = "space-between";
                div.innerHTML = `
                    <span>${p.emoji} ${p.name}</span>
                    <span id="ping-${p.id}" class="mono" style="color:${getPingColor(p.ping)}">${p.ping}ms</span>
                `;
                list.appendChild(div);
            });
            document.getElementById('p-count').innerText = count;
            document.getElementById('start-btn').disabled = count < 1 && !document.getElementById('host-plays-check').checked;
        }

        function updatePingUI(id) {
            const el = document.getElementById(`ping-${id}`);
            if(el) {
                el.innerText = state.players[id].ping + "ms";
                el.style.color = getPingColor(state.players[id].ping);
            }
        }

        function updateGameGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = "";
            state.queue.forEach(pid => {
                const p = state.players[pid];
                const div = document.createElement('div');
                div.className = `player-card ${!p.alive ? 'eliminated' : ''}`;
                div.id = `card-${pid}`;
                div.innerHTML = `
                    <div class="p-ping" style="color:${getPingColor(p.ping)}">${p.isHost ? 'H' : p.ping + 'ms'}</div>
                    <div class="p-avatar">${p.emoji}</div>
                    <div class="p-name">${p.name}</div>
                    <div class="p-lives">${"‚ù§Ô∏è".repeat(p.lives)}</div>
                `;
                grid.appendChild(div);
            });
        }

        function updateGameUI(activePid) {
            document.getElementById('syllable-display').innerText = state.syllable;
            const pName = state.players[activePid].name;
            document.getElementById('turn-indicator').innerText = `TOUR DE ${pName}`;
            
            // Highlight active card
            document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active'));
            const c = document.getElementById(`card-${activePid}`);
            if(c) c.classList.add('active');
        }

        function updateTimerVisual() {
            const pct = Math.max(0, (state.timeLeft / state.maxTime) * 100);
            document.getElementById('timer-bar').style.width = pct + "%";
        }

        function getPingColor(ms) {
            if(ms < 50) return "var(--success)";
            if(ms < 150) return "var(--warning)";
            return "var(--danger)";
        }

        // --- NETWORKING ---
        function sendTo(pid, msg) {
            if(pid === 'HOST') return;
            const p = state.players[pid];
            if(p && p.conn) p.conn.send(msg);
        }

        function broadcast(msg) {
            Object.values(state.players).forEach(p => {
                if(!p.isHost && p.conn) p.conn.send(msg);
            });
        }

        function cleanPlayerList() {
            // Envoie une liste l√©g√®re aux clients pour affichage
            return Object.values(state.players).map(p => ({
                id: p.id, name: p.name, emoji: p.emoji, lives: p.lives, alive: p.alive
            }));
        }

        // Boucle Ping : Envoie un timestamp √† tous, ils r√©pondent, on calcule le RTT
        function startPingLoop() {
            pingInt = setInterval(() => {
                const now = Date.now();
                broadcast({type: 'PING', ts: now});
            }, 2000); // Toutes les 2s
        }

    </script>
</body>
</html>