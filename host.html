<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√îTE - Tic Tac Boom</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="dictionary.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
</head>
<body>
    <div style="width: 100%;">
        <div class="dashboard">
            
            <!-- PANNEAU LAT√âRAL -->
            <div class="panel-side">
                <!-- CODE DE PARTIE EN GRAND -->
                <div style="background: rgba(99, 102, 241, 0.15); padding: 20px; border-radius: 12px; border: 2px solid var(--primary); margin-bottom: 20px; text-align: center;">
                    <div style="font-size: clamp(0.75rem, 2vw, 0.85rem); color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">üéØ CODE DE LA PARTIE</div>
                    <div id="room-code" class="mono" style="color:var(--accent); font-size: clamp(2.5rem, 6vw, 3.5rem); font-weight: 800; letter-spacing: 0.2em; margin-bottom: 12px; text-shadow: 0 0 20px rgba(236, 72, 153, 0.5);">...</div>
                    <button class="btn secondary" onclick="copyRoomCode()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span id="copy-icon">üìã</span> <span id="copy-text">COPIER LE CODE</span>
                    </button>
                </div>

                <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin-bottom: 15px;">

                <!-- CONFIGURATION H√îTE -->
                <div id="host-config" style="margin-bottom: 15px;">
                    <div class="settings-title">üëë Configuration H√¥te</div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">L'h√¥te joue</span>
                            <span class="setting-label-sub">Participer √† la partie</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="host-plays-check" onchange="toggleHostPlays()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Mode √©conomie d'√©nergie</span>
                            <span class="setting-label-sub">R√©duire les animations</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="power-save-mode" onchange="togglePowerSave()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div id="host-player-setup" style="display: none; margin-top: 12px; padding: clamp(10px, 2vw, 12px); background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3);">
                        <input type="text" id="host-name" placeholder="Votre pseudo" maxlength="12" value="H√îTE" style="margin-bottom: 10px; font-size: clamp(0.85rem, 2vw, 0.9rem); padding: 10px;">
                        
                        <label style="display: block; margin-bottom: 6px; font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-muted);">Avatar :</label>
                        <div class="picker-grid" id="host-emoji-picker" style="margin-bottom: 10px;">
                            <!-- Rempli par JS -->
                        </div>
                        
                        <label style="display: block; margin-bottom: 6px; font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-muted);">Couleur :</label>
                        <div class="picker-grid" id="host-color-picker">
                            <!-- Rempli par JS -->
                        </div>
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin-bottom: 15px;">

                <!-- MODE DE JEU -->
                <div id="config-panel">
                    <div class="settings-title">üéÆ Mode de Jeu</div>
                    
                    <div class="mode-selector" id="mode-selector">
                        <div class="mode-option selected" data-mode="classic" onclick="selectMode('classic')">
                            <div class="mode-icon">‚ö°</div>
                            <div class="mode-name">Classique</div>
                            <div class="mode-desc">Syllabes vari√©es</div>
                        </div>
                        <div class="mode-option" data-mode="fast" onclick="selectMode('fast')">
                            <div class="mode-icon">üöÄ</div>
                            <div class="mode-name">Rapide</div>
                            <div class="mode-desc">Temps r√©duit</div>
                        </div>
                        <div class="mode-option" data-mode="survival" onclick="selectMode('survival')">
                            <div class="mode-icon">üíÄ</div>
                            <div class="mode-name">Survie</div>
                            <div class="mode-desc">Une seule vie</div>
                        </div>
                        <div class="mode-option" data-mode="marathon" onclick="selectMode('marathon')">
                            <div class="mode-icon">üèÉ</div>
                            <div class="mode-name">Marathon</div>
                            <div class="mode-desc">Points, pas d'√©lim.</div>
                        </div>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin: 15px 0;">

                    <div class="settings-title">‚öôÔ∏è Param√®tres</div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Vies (Tous les joueurs)</span>
                            <span class="setting-label-sub">Nombre de vies par joueur</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                            <input type="range" min="1" max="5" value="2" id="lives-range" oninput="updateSettings('lives', this.value)">
                            <span id="lbl-lives" style="min-width: 20px; font-weight: 700; color: var(--primary);">2</span>
                        </div>
                    </div>
                    
                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Temps</span>
                            <span class="setting-label-sub">Dur√©e du chronom√®tre</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                            <input type="range" min="5" max="60" value="20" id="time-range" oninput="updateSettings('startTime', this.value)">
                            <span id="lbl-time" style="min-width: 35px; font-weight: 700; color: var(--primary);">20s</span>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Difficult√© syllabes</span>
                            <span class="setting-label-sub">Complexit√© des syllabes</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                            <select id="syllable-difficulty" onchange="updateSettings('syllableDifficulty', this.value)" style="background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: white; padding: 8px; font-weight: 600;">
                                <option value="easy">Facile</option>
                                <option value="normal" selected>Normal</option>
                                <option value="hard">Difficile</option>
                                <option value="expert">Expert</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Longueur syllabes</span>
                            <span class="setting-label-sub">Nombre de caract√®res</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
                            <select id="syllable-length" onchange="updateSettings('syllableLength', this.value)" style="background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); border-radius: 8px; color: white; padding: 8px; font-weight: 600;">
                                <option value="short">Courtes (2)</option>
                                <option value="medium" selected>Moyennes (2-3)</option>
                                <option value="long">Longues (3-4)</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Mots interdits r√©p√©t√©s</span>
                            <span class="setting-label-sub">Un mot = une seule utilisation</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="unique-words" checked onchange="updateSettings('uniqueWords', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin: 15px 0;">

                    <div class="settings-title">üé® Fonctionnalit√©s</div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Voir mots adversaires</span>
                            <span class="setting-label-sub">Animation mots tombants</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="show-words" checked onchange="updateSettings('showWords', this.checked)">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Chat</span>
                            <span class="setting-label-sub">Messages entre joueurs</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="chat-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">R√©actions</span>
                            <span class="setting-label-sub">Emojis de r√©action</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="reactions-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="setting-row">
                        <div class="setting-label">
                            <span class="setting-label-main">Sons</span>
                            <span class="setting-label-sub">Effets sonores</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="sounds-enabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <hr style="border:0; border-top:1px solid var(--glass-border); width:100%; margin: 15px 0;">
                
                <!-- LISTE DES JOUEURS -->
                <div style="flex:1; overflow:hidden; display:flex; flex-direction:column; min-height: 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items: center;">
                        <span style="font-weight: 600; font-size: clamp(0.85rem, 2vw, 0.9rem);">JOUEURS (<span id="p-count">0</span>)</span>
                        <span style="font-size:clamp(0.7rem, 1.8vw, 0.75rem); opacity:0.5;">PING</span>
                    </div>
                    <div id="lobby-list" style="flex:1; overflow-y:auto;">
                        <!-- Rempli par JS -->
                    </div>
                </div>

                <button class="btn success" id="start-btn" onclick="startGame()" disabled style="margin-top: 15px;">
                    LANCER LA PARTIE
                </button>
            </div>

            <!-- PANNEAU PRINCIPAL -->
            <div class="panel-main">
                
                <!-- VUE D'ATTENTE -->
                <div id="waiting-view" style="width:100%; max-width:800px;">
                    <div style="text-align:center; margin-bottom:30px;">
                        <div class="bomb-icon-animated" style="font-size: clamp(4rem, 12vw, 6rem);">üí£</div>
                        <h1 style="margin-bottom: 1rem;">EN ATTENTE DES JOUEURS</h1>
                        <p style="color: var(--text-muted); font-size: clamp(0.9rem, 2.5vw, 1rem);">
                            Partagez le code <span class="mono" style="color: var(--accent); font-weight: 700;" id="code-display-2">XXXX</span> avec vos amis
                        </p>
                    </div>

                    <!-- R√àGLES DYNAMIQUES -->
                    <div id="dynamic-rules" style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: left;">
                        <h3 style="margin-bottom: 15px; text-align: center;">üìñ R√àGLES DE CETTE PARTIE</h3>
                        <div id="rules-content" style="font-size: clamp(0.85rem, 2vw, 0.9rem); color: var(--text-muted); line-height: 1.8;">
                            <!-- Rempli dynamiquement par JS -->
                        </div>
                    </div>

                    <div id="waiting-players-display" style="min-height:200px;">
                        <p style="color: var(--text-muted); text-align:center; font-size: clamp(0.85rem, 2vw, 0.9rem);">
                            Aucun joueur connect√© pour le moment...
                        </p>
                    </div>
                </div>

                <!-- VUE DE JEU -->
                <div id="game-view" style="display:none; width:100%; max-width:1000px; position:relative;">
                    <div style="text-align:center; margin-bottom:25px;">
                        <div id="turn-indicator" style="font-size: clamp(0.9rem, 2.5vw, 1.1rem); color:var(--text-muted); margin-bottom:10px;">TOUR DE ...</div>
                        <div class="syllable-box" id="syllable-display">...</div>
                        <div class="timer-track">
                            <div class="timer-fill" id="timer-bar"></div>
                        </div>
                    </div>

                    <!-- Zone pour mots tombants -->
                    <div id="falling-words-container" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden; z-index: 100;">
                        <!-- Les mots appara√Ætront ici -->
                    </div>

                    <div class="grid-container" id="game-grid">
                        <!-- Rempli par JS -->
                    </div>

                    <!-- HISTORIQUE DES MOTS -->
                    <div id="words-history" style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 12px; max-height: 150px; overflow-y: auto;">
                        <h4 style="margin-bottom: 10px; font-size: clamp(0.85rem, 2vw, 0.9rem); color: var(--text-muted);">üìú HISTORIQUE DES MOTS</h4>
                        <div id="history-list" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-muted);">Aucun mot jou√© pour l'instant</span>
                        </div>
                    </div>
                </div>

                <!-- VUE GAME OVER -->
                <div id="gameover-view" style="display:none; text-align:center; width:100%; max-width:600px;">
                    <div style="font-size: clamp(4rem, 12vw, 6rem); margin-bottom: 20px;">üèÜ</div>
                    <h1 style="margin-bottom: 1rem;">PARTIE TERMIN√âE</h1>
                    <div id="winner-display" style="font-size: clamp(1.5rem, 4vw, 2rem); color: var(--accent); margin-bottom: 30px; font-weight: 700;">
                        Vainqueur : ...
                    </div>

                    <!-- Historique final -->
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 12px;">
                        <h3 style="margin-bottom: 15px;">üìä STATISTIQUES DE LA PARTIE</h3>
                        <div id="game-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <!-- Rempli par JS -->
                        </div>
                    </div>

                    <button class="btn" onclick="location.reload()">NOUVELLE PARTIE</button>
                </div>

                <!-- Input overlay pour l'h√¥te s'il joue -->
                <div id="host-input-overlay">
                    <input type="text" id="host-word" placeholder="Votre mot..." autocomplete="off">
                    <button class="btn" onclick="submitHostWord()">VALIDER</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // EMOJIS √âTENDUS AVEC PLUS D'ANIMAUX
        const AVAILABLE_EMOJIS = [
            'üòé', 'üî•', '‚ö°', 'üåü', 'üéØ', 'üöÄ', 'üíé', 'üëë', 'ü¶Ñ', 'üêâ', 
            'üéÆ', 'üé®', 'üé≠', 'üé™', 'üé∏', '‚öΩ', 'üèÄ', 'üé≥', 'üé≤', 'üÉè',
            'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ',
            'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü',
            'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã',
            'üêå', 'üêû', 'üêú', 'ü¶ó', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ',
            'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨',
            'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò',
            'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'ü¶¨', 'üêÉ', 'üêÇ', 'üêÑ'
        ];

        const AVAILABLE_COLORS = [
            '#ef4444', '#f59e0b', '#eab308', '#22c55e', '#06b6d4',
            '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e',
            '#14b8a6', '#84cc16', '#f97316', '#a855f7', '#64748b'
        ];

        let peer, myPeerId;
        let connections = [];
        let pingInt;
        let timerInt;
        let powerSaveMode = false;
        let wordsHistory = [];

        const state = {
            players: {},
            settings: {
                mode: 'classic',
                lives: 2,
                startTime: 20,
                syllableDifficulty: 'normal',
                syllableLength: 'medium',
                uniqueWords: true,
                showWords: true
            },
            syllable: '',
            queue: [],
            activePlayer: null,
            timeLeft: 0,
            maxTime: 20,
            usedWords: new Set()
        };

        let hostPlayer = {
            emoji: AVAILABLE_EMOJIS[0],
            color: AVAILABLE_COLORS[0],
            enabled: false
        };

        function copyRoomCode() {
            const code = myPeerId;
            navigator.clipboard.writeText(code).then(() => {
                document.getElementById('copy-icon').innerText = '‚úÖ';
                document.getElementById('copy-text').innerText = 'CODE COPI√â !';
                setTimeout(() => {
                    document.getElementById('copy-icon').innerText = 'üìã';
                    document.getElementById('copy-text').innerText = 'COPIER LE CODE';
                }, 2000);
            });
        }

        function togglePowerSave() {
            powerSaveMode = document.getElementById('power-save-mode').checked;
            if(powerSaveMode) {
                // D√©sactiver certaines animations
                gsap.globalTimeline.timeScale(0.1);
            } else {
                gsap.globalTimeline.timeScale(1);
            }
        }

        function updateDynamicRules() {
            const mode = state.settings.mode;
            const lives = state.settings.lives;
            const time = state.settings.startTime;
            const difficulty = state.settings.syllableDifficulty;
            const unique = state.settings.uniqueWords;
            const showWords = state.settings.showWords;

            let modeText = '';
            switch(mode) {
                case 'classic': modeText = 'Mode Classique - Syllabes vari√©es'; break;
                case 'fast': modeText = 'Mode Rapide - Temps r√©duit de moiti√©'; break;
                case 'survival': modeText = 'Mode Survie - Une seule vie'; break;
                case 'marathon': modeText = 'Mode Marathon - Pas d\'√©limination, le plus de points gagne'; break;
            }

            let diffText = '';
            switch(difficulty) {
                case 'easy': diffText = 'Syllabes simples'; break;
                case 'normal': diffText = 'Syllabes normales'; break;
                case 'hard': diffText = 'Syllabes complexes'; break;
                case 'expert': diffText = 'Syllabes tr√®s difficiles'; break;
            }

            const rulesHTML = `
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div><strong>üéÆ Mode :</strong> ${modeText}</div>
                    <div><strong>‚ù§Ô∏è Vies :</strong> ${lives} vie(s) par joueur</div>
                    <div><strong>‚è±Ô∏è Temps :</strong> ${time} secondes par tour</div>
                    <div><strong>üéØ Difficult√© :</strong> ${diffText}</div>
                    <div><strong>üìù Mots uniques :</strong> ${unique ? 'Activ√© (un mot ne peut √™tre utilis√© qu\'une fois)' : 'D√©sactiv√©'}</div>
                    <div><strong>üëÅÔ∏è Mots visibles :</strong> ${showWords ? 'Activ√© (vous verrez les mots des adversaires)' : 'D√©sactiv√©'}</div>
                </div>
            `;

            document.getElementById('rules-content').innerHTML = rulesHTML;
        }

        window.addEventListener('dictionaryReady', initHost);
        loadFullDictionary();

        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let code = '';
            for(let i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function initHost() {
            const roomCode = generateRoomCode();
            myPeerId = roomCode;
            
            peer = new Peer(roomCode, {debug: 0});
            
            peer.on('open', id => {
                console.log('‚úÖ Serveur PeerJS connect√©. ID:', id);
                document.getElementById('room-code').innerText = myPeerId;
                document.getElementById('code-display-2').innerText = myPeerId;
                updateDynamicRules();
            });

            peer.on('connection', conn => {
                console.log('üîó Nouvelle connexion:', conn.peer);
                
                conn.on('open', () => {
                    const pid = conn.peer;
                    
                    if(state.players[pid]) {
                        console.warn('‚ö†Ô∏è Joueur d√©j√† connect√©:', pid);
                        return;
                    }

                    state.players[pid] = {
                        id: pid,
                        conn: conn,
                        name: '...',
                        emoji: 'üë§',
                        color: '#6366f1',
                        lives: state.settings.lives,
                        alive: true,
                        ping: 0,
                        isHost: false
                    };

                    conn.send({type: 'CONNECTED', id: pid, settings: state.settings});
                    updateLobbyUI();
                });

                conn.on('data', data => handleMessage(conn.peer, data));
                conn.on('close', () => handleDisconnect(conn.peer));
                conn.on('error', err => console.error('‚ùå Erreur conn:', err));
            });

            peer.on('error', err => {
                console.error('‚ùå Erreur peer:', err);
                let errorMsg = 'Erreur de connexion';
                if(err.type === 'unavailable-id') {
                    errorMsg = 'Code salle d√©j√† utilis√©';
                } else if(err.type === 'network') {
                    errorMsg = 'Erreur r√©seau';
                } else if(err.type === 'server-error') {
                    errorMsg = 'Erreur serveur PeerJS';
                } else if(err.type === 'socket-error') {
                    errorMsg = 'Erreur de connexion au serveur';
                }
                alert(`‚ùå ${errorMsg}. Veuillez r√©essayer.`);
            });
        }

        function initHostPickers() {
            const ePicker = document.getElementById('host-emoji-picker');
            const cPicker = document.getElementById('host-color-picker');

            AVAILABLE_EMOJIS.slice(0, 20).forEach(e => {
                const div = document.createElement('div');
                div.className = 'picker-item';
                if(e === hostPlayer.emoji) div.classList.add('selected');
                div.innerText = e;
                div.onclick = () => {
                    ePicker.querySelectorAll('.picker-item').forEach(d => d.classList.remove('selected'));
                    div.classList.add('selected');
                    hostPlayer.emoji = e;
                };
                ePicker.appendChild(div);
            });

            AVAILABLE_COLORS.forEach(c => {
                const div = document.createElement('div');
                div.className = 'picker-item color-picker-item';
                div.style.backgroundColor = c;
                if(c === hostPlayer.color) div.classList.add('selected');
                div.onclick = () => {
                    cPicker.querySelectorAll('.picker-item').forEach(d => d.classList.remove('selected'));
                    div.classList.add('selected');
                    hostPlayer.color = c;
                };
                cPicker.appendChild(div);
            });
        }

        function toggleHostPlays() {
            const enabled = document.getElementById('host-plays-check').checked;
            hostPlayer.enabled = enabled;
            document.getElementById('host-player-setup').style.display = enabled ? 'block' : 'none';

            if(enabled) {
                const name = document.getElementById('host-name').value || 'H√îTE';
                state.players['HOST'] = {
                    id: 'HOST',
                    name: name,
                    emoji: hostPlayer.emoji,
                    color: hostPlayer.color,
                    lives: state.settings.lives,
                    alive: true,
                    isHost: true,
                    ping: 0
                };
            } else {
                delete state.players['HOST'];
            }

            updateLobbyUI();
            broadcastLobbyUpdate();
        }

        function selectMode(mode) {
            state.settings.mode = mode;
            document.querySelectorAll('.mode-option').forEach(o => o.classList.remove('selected'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
            
            if(mode === 'fast') {
                state.settings.startTime = 10;
                document.getElementById('time-range').value = 10;
                document.getElementById('lbl-time').innerText = '10s';
            }
            if(mode === 'survival') {
                state.settings.lives = 1;
                document.getElementById('lives-range').value = 1;
                document.getElementById('lbl-lives').innerText = '1';
            }

            updateSettings();
            updateDynamicRules();
        }

        function updateSettings(key, val) {
            if(key) {
                if(key === 'startTime' || key === 'lives') {
                    state.settings[key] = parseInt(val);
                } else if(key === 'uniqueWords' || key === 'showWords') {
                    state.settings[key] = val;
                } else {
                    state.settings[key] = val;
                }

                if(key === 'lives') {
                    document.getElementById('lbl-lives').innerText = val;
                }
                if(key === 'startTime') {
                    document.getElementById('lbl-time').innerText = val + 's';
                }
            }

            broadcast({type: 'SETTINGS_UPDATE', settings: state.settings});
            updateDynamicRules();
        }

        function handleMessage(pid, data) {
            if(data.type === 'JOIN') {
                state.players[pid].name = data.name;
                state.players[pid].emoji = data.emoji;
                state.players[pid].color = data.color;
                updateLobbyUI();
                broadcastLobbyUpdate();
            }

            if(data.type === 'PONG') {
                const rtt = Date.now() - data.ts;
                state.players[pid].ping = rtt;
                updatePingUI(pid);
                // Renvoyer le ping au joueur
                sendTo(pid, {type: 'PING_UPDATE', ping: rtt});
            }

            if(data.type === 'WORD') {
                handleWord(pid, data.word);
            }
        }

        function handleWord(pid, rawWord) {
            if(!state.activePlayer || state.activePlayer !== pid) return;

            const word = rawWord.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            if(!word.includes(state.syllable)) {
                sendTo(pid, {type: 'FEEDBACK', valid: false, msg: `Syllabe "${state.syllable}" manquante !`});
                return;
            }

            if(state.settings.uniqueWords && state.usedWords.has(word)) {
                sendTo(pid, {type: 'FEEDBACK', valid: false, msg: 'Mot d√©j√† utilis√© !'});
                return;
            }

            if(!window.DICTIONARY_DATA.has(word)) {
                sendTo(pid, {type: 'FEEDBACK', valid: false, msg: 'Mot inconnu !'});
                return;
            }

            // Mot valide
            clearInterval(timerInt);
            state.usedWords.add(word);
            wordsHistory.push({player: state.players[pid].name, word: word, color: state.players[pid].color});
            updateWordsHistory();

            sendTo(pid, {type: 'FEEDBACK', valid: true});

            // Afficher le mot tombant
            if(state.settings.showWords) {
                showFallingWord(word, state.players[pid].name, state.players[pid].color);
            }

            setTimeout(() => nextTurn(), 1500);
        }

        function showFallingWord(word, playerName, color) {
            // Cr√©er une notification dans le coin sup√©rieur droit
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${color};
                border-radius: 12px;
                box-shadow: 0 4px 15px ${color}60, 0 2px 8px rgba(0,0,0,0.3);
                border: 2px solid rgba(255,255,255,0.3);
                z-index: 10000;
                pointer-events: none;
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 280px;
            `;
            notification.innerHTML = `
                <div style="
                    width: 40px;
                    height: 40px;
                    background: rgba(255,255,255,0.2);
                    border-radius: 8px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 1.2rem;
                    font-weight: 800;
                    color: white;
                    flex-shrink: 0;
                ">‚úì</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: clamp(0.85rem, 2vw, 0.95rem); font-weight: 700; color: white; margin-bottom: 2px;">${playerName}</div>
                    <div style="font-size: clamp(0.75rem, 1.8vw, 0.85rem); color: rgba(255,255,255,0.9); font-weight: 500;">${word}</div>
                </div>
            `;
            document.body.appendChild(notification);

            // Animation d'apparition
            if(!powerSaveMode) {
                gsap.from(notification, {
                    x: 100,
                    opacity: 0,
                    duration: 0.4,
                    ease: 'back.out(1.7)'
                });
                // Disparition apr√®s 2.5s
                gsap.to(notification, {
                    opacity: 0,
                    x: 100,
                    duration: 0.3,
                    delay: 2.5,
                    ease: 'power2.in',
                    onComplete: () => notification.remove()
                });
            } else {
                setTimeout(() => notification.remove(), 2500);
            }

            // Broadcast aux joueurs
            broadcast({
                type: 'WORD_ANIMATION',
                word: word,
                playerName: playerName,
                color: color
            });
        }

        function updateWordsHistory() {
            const historyEl = document.getElementById('history-list');
            if(wordsHistory.length === 0) {
                historyEl.innerHTML = '<span style="font-size: clamp(0.75rem, 2vw, 0.8rem); color: var(--text-muted);">Aucun mot jou√©</span>';
                return;
            }

            historyEl.innerHTML = wordsHistory.slice(-20).reverse().map(h => 
                `<span style="padding: 4px 10px; background: rgba(0,0,0,0.3); border-radius: 6px; font-size: clamp(0.75rem, 2vw, 0.85rem); border: 1px solid ${h.color};">
                    <span style="color: ${h.color};">${h.player}:</span> ${h.word}
                </span>`
            ).join('');
        }

        function handleDisconnect(pid) {
            console.log('üëã D√©connexion:', pid);
            delete state.players[pid];
            state.queue = state.queue.filter(p => p !== pid);
            updateLobbyUI();
            broadcastLobbyUpdate();
        }

        function kickPlayer(pid) {
            if(!confirm(`Voulez-vous vraiment exclure ${state.players[pid].name} de la partie ?`)) {
                return;
            }
            
            console.log('‚õî Exclusion du joueur:', pid);
            
            // Envoyer un message au joueur pour le d√©connecter
            sendTo(pid, {type: 'KICKED', message: 'Vous avez √©t√© exclu de la partie par l\'h√¥te'});
            
            // Fermer la connexion
            if(state.players[pid] && state.players[pid].conn) {
                state.players[pid].conn.close();
            }
            
            // Supprimer le joueur de l'√©tat
            delete state.players[pid];
            state.queue = state.queue.filter(p => p !== pid);
            
            updateLobbyUI();
            broadcastLobbyUpdate();
        }

        function updateLobbyUI() {
            const list = document.getElementById('lobby-list');
            const waitingDisplay = document.getElementById('waiting-players-display');
            
            list.innerHTML = "";
            waitingDisplay.innerHTML = "";
            
            let count = 0;
            const allPlayers = [];
            
            Object.values(state.players).forEach(p => {
                if(p.isHost) return;
                count++;
                allPlayers.push(p);
                
                const div = document.createElement('div');
                div.id = `lobby-player-${p.id}`;
                div.className = 'lobby-player-item';
                div.innerHTML = `
                    <div class="lobby-player-avatar" style="border-color: ${p.color};">
                        ${p.emoji}
                    </div>
                    <div class="lobby-player-info">
                        <div class="lobby-player-name" style="color: ${p.color};">${p.name}</div>
                        <div class="lobby-player-ping" id="ping-${p.id}" style="color: ${getPingColor(p.ping)}">
                            ${p.ping ? p.ping + 'ms' : '...'}
                        </div>
                    </div>
                    <button onclick="kickPlayer('${p.id}')" style="background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; flex-shrink: 0; min-height: 32px;" title="Exclure ce joueur">
                        ‚ùå
                    </button>
                `;
                list.appendChild(div);
            });
            
            if(allPlayers.length > 0 || hostPlayer.enabled) {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'grid-container';
                gridDiv.style.maxHeight = 'none';
                
                if(hostPlayer.enabled) {
                    const hostCard = document.createElement('div');
                    hostCard.className = 'player-card';
                    hostCard.innerHTML = `
                        <div class="p-color-badge" style="background-color: ${hostPlayer.color};"></div>
                        <div class="p-avatar">${hostPlayer.emoji}</div>
                        <div class="p-name" style="color: ${hostPlayer.color};">${document.getElementById('host-name').value || 'H√îTE'} üëë</div>
                    `;
                    gridDiv.appendChild(hostCard);
                }

                allPlayers.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'player-card';
                    card.style.animation = 'slideInRight 0.5s ease-out';
                    card.innerHTML = `
                        <div class="p-color-badge" style="background-color: ${p.color};"></div>
                        <div class="p-avatar">${p.emoji}</div>
                        <div class="p-name" style="color: ${p.color};">${p.name}</div>
                        <div style="font-size: clamp(0.7rem, 1.8vw, 0.75rem); color: var(--text-muted); margin-top: 5px;">
                            ${p.ping ? p.ping + 'ms' : 'Connexion...'}
                        </div>
                    `;
                    gridDiv.appendChild(card);
                });
                
                waitingDisplay.appendChild(gridDiv);
            }
            
            document.getElementById('p-count').innerText = count + (hostPlayer.enabled ? 1 : 0);
            // Minimum 2 joueurs (ou 1 joueur + h√¥te)
            const totalPlayers = count + (hostPlayer.enabled ? 1 : 0);
            document.getElementById('start-btn').disabled = totalPlayers < 2;
        }

        function broadcastLobbyUpdate() {
            broadcast({
                type: 'LOBBY_UPDATE',
                players: cleanPlayerList()
            });
        }

        function updatePingUI(id) {
            const el = document.getElementById(`ping-${id}`);
            if(el && state.players[id]) {
                el.innerText = state.players[id].ping + "ms";
                el.style.color = getPingColor(state.players[id].ping);
            }
        }

        function updateGameGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = "";
            
            state.queue.forEach(pid => {
                const p = state.players[pid];
                if(!p) return;
                
                const div = document.createElement('div');
                div.className = `player-card ${!p.alive ? 'eliminated' : ''}`;
                div.id = `card-${pid}`;
                div.innerHTML = `
                    <div class="p-color-badge" style="background-color: ${p.color};"></div>
                    <div class="p-ping" style="color:${getPingColor(p.ping)}">${p.isHost ? 'üëë' : p.ping + 'ms'}</div>
                    <div class="p-avatar">${p.emoji}</div>
                    <div class="p-name" style="color: ${p.color};">${p.name}</div>
                    <div class="p-lives">${p.lives > 0 ? "‚ù§Ô∏è".repeat(Math.min(p.lives, 5)) : "üíÄ"}</div>
                `;
                grid.appendChild(div);
            });
        }

        function updateGameUI(activePid) {
            document.getElementById('syllable-display').innerText = state.syllable;
            const pName = state.players[activePid].name;
            document.getElementById('turn-indicator').innerText = `TOUR DE ${pName.toUpperCase()}`;
            
            document.querySelectorAll('.player-card').forEach(c => c.classList.remove('active'));
            const c = document.getElementById(`card-${activePid}`);
            if(c) {
                c.classList.add('active');
                if(!powerSaveMode) {
                    gsap.from(c, {scale: 0.95, duration: 0.3, ease: 'back.out(2)'});
                }
            }

            if(activePid === 'HOST') {
                setTimeout(() => {
                    document.getElementById('host-word').focus();
                }, 100);
            }
        }

        function updateTimerVisual() {
            const pct = Math.max(0, (state.timeLeft / state.maxTime) * 100);
            document.getElementById('timer-bar').style.width = pct + "%";
        }

        function getPingColor(ms) {
            if(ms < 50) return "var(--success)";
            if(ms < 150) return "var(--warning)";
            return "var(--danger)";
        }

        function sendTo(pid, msg) {
            if(pid === 'HOST') return;
            const p = state.players[pid];
            if(p && p.conn) p.conn.send(msg);
        }

        function broadcast(msg) {
            Object.values(state.players).forEach(p => {
                if(!p.isHost && p.conn) p.conn.send(msg);
            });
        }

        function cleanPlayerList() {
            return Object.values(state.players).map(p => ({
                id: p.id, 
                name: p.name, 
                emoji: p.emoji, 
                color: p.color,
                lives: p.lives, 
                alive: p.alive,
                ping: p.ping
            }));
        }

        function startPingLoop() {
            pingInt = setInterval(() => {
                const now = Date.now();
                broadcast({type: 'PING', ts: now});
            }, 2000);
        }

        function startGame() {
            // D√©sactiver le bouton et masquer la configuration
            document.getElementById('start-btn').disabled = true;
            document.getElementById('start-btn').innerText = 'PARTIE EN COURS...';
            document.getElementById('config-panel').style.display = 'none';
            document.getElementById('host-config').style.display = 'none';
            
            document.getElementById('waiting-view').style.display = 'none';
            document.getElementById('game-view').style.display = 'block';

            state.queue = Object.keys(state.players).filter(pid => state.players[pid].alive);
            state.usedWords.clear();
            wordsHistory = [];

            broadcast({type: 'GAME_START'});
            startPingLoop();
            nextTurn();

            if(!powerSaveMode) {
                gsap.from('#game-view', {opacity: 0, scale: 0.95, duration: 0.6, ease: 'power3.out'});
            }
        }

        function nextTurn() {
            const aliveQueue = state.queue.filter(pid => state.players[pid] && state.players[pid].alive);
            
            if(aliveQueue.length === 0) {
                endGame('Aucun survivant');
                return;
            }
            
            if(aliveQueue.length === 1) {
                endGame(state.players[aliveQueue[0]].name);
                return;
            }

            state.activePlayer = aliveQueue[0];
            state.queue.push(state.queue.shift());
            
            state.syllable = generateSyllable();
            state.maxTime = state.settings.startTime;
            state.timeLeft = state.maxTime;

            updateGameGrid();
            updateGameUI(state.activePlayer);

            broadcast({
                type: 'NEW_TURN',
                syllable: state.syllable,
                activePlayer: state.activePlayer,
                duration: state.maxTime,
                players: cleanPlayerList()
            });

            if(state.activePlayer === 'HOST') {
                document.getElementById('host-input-overlay').style.display = 'flex';
                document.getElementById('host-word').value = '';
            } else {
                document.getElementById('host-input-overlay').style.display = 'none';
            }

            startTimer();
        }

        function generateSyllable() {
            const difficulty = state.settings.syllableDifficulty;
            const length = state.settings.syllableLength;

            let syls = [];
            
            if(length === 'short') {
                syls = ["AR", "BO", "CH", "LA", "MA", "PA", "RE", "SI", "ON", "EN"];
            } else if(length === 'medium') {
                syls = ["AR", "BO", "CH", "DI", "EN", "LA", "MA", "NO", "ON", "PA", "RE", "SI", "TI", "VI", "FR", "GR"];
            } else {
                syls = ["TER", "PRO", "CON", "AN", "BLE", "TION", "MENT", "EUR"];
            }

            if(difficulty === 'easy') {
                syls = syls.slice(0, Math.ceil(syls.length / 2));
            } else if(difficulty === 'hard') {
                syls = [...syls, "QU", "PH", "TH", "GN"];
            } else if(difficulty === 'expert') {
                syls = ["QU", "PH", "TH", "GN", "SCH", "TION", "EUR", "MENT", "BLE"];
            }

            return syls[Math.floor(Math.random() * syls.length)];
        }

        function startTimer() {
            clearInterval(timerInt);
            const start = Date.now();
            
            timerInt = setInterval(() => {
                const elapsed = (Date.now() - start) / 1000;
                state.timeLeft = Math.max(0, state.maxTime - elapsed);
                updateTimerVisual();

                if(state.timeLeft <= 0) {
                    clearInterval(timerInt);
                    playerLoseLife(state.activePlayer);
                }
            }, 100);
        }

        function playerLoseLife(pid) {
            const p = state.players[pid];
            if(!p) return;

            p.lives--;
            
            broadcast({type: 'HIT', player: pid, lives: p.lives});

            if(p.lives <= 0) {
                p.alive = false;
                broadcast({type: 'ELIMINATED', player: pid});
            }

            updateGameGrid();
            setTimeout(nextTurn, 2000);
        }

        function submitHostWord() {
            const word = document.getElementById('host-word').value;
            handleWord('HOST', word);
        }

        function endGame(winner) {
            clearInterval(timerInt);
            clearInterval(pingInt);

            document.getElementById('game-view').style.display = 'none';
            document.getElementById('gameover-view').style.display = 'block';
            document.getElementById('winner-display').innerText = `üèÜ ${winner}`;

            // Statistiques de la partie
            const stats = document.getElementById('game-stats');
            stats.innerHTML = `
                <div style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">üìù</div>
                    <div style="font-size: 1.2rem; font-weight: 700;">${wordsHistory.length}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Mots jou√©s</div>
                </div>
                <div style="padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                    <div style="font-size: 1.5rem; margin-bottom: 5px;">üë•</div>
                    <div style="font-size: 1.2rem; font-weight: 700;">${Object.keys(state.players).length}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">Joueurs</div>
                </div>
            `;

            broadcast({type: 'GAME_OVER', winner: winner});

            if(!powerSaveMode) {
                gsap.from('#gameover-view', {opacity: 0, scale: 0.9, duration: 0.6, ease: 'back.out(1.5)'});
            }
        }

        // Permettre √† l'h√¥te de valider avec la touche Entr√©e
        document.getElementById('host-word').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                submitHostWord();
            }
        });

        initHostPickers();

        if(!powerSaveMode) {
            gsap.from('.panel-side', {x: -50, opacity: 0, duration: 0.8, ease: 'power3.out', delay: 0.2});
            gsap.from('.panel-main', {x: 50, opacity: 0, duration: 0.8, ease: 'power3.out', delay: 0.2});
        }
    </script>
</body>
</html>
