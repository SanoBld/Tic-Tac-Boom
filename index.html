<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üí£ Tic Tac Boom - Jeu Multijoueur</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Outfit:wght@700;800;900&display=swap" rel="stylesheet">

    <style>
:root {
    --bg: #0a0c14;
    --bg-elevated: #121420;
    --bg-card: #181b28;
    --primary: #6b7280;
    --primary-dark: #4b5563;
    --secondary: #9ca3af;
    --accent: #ff3d71;
    --text: #e8ecf5;
    --text-dim: #8a92a6;
    --border: rgba(255, 255, 255, 0.06);
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

[data-theme="light"] {
    --bg: #f8f9fa;
    --bg-elevated: #ffffff;
    --bg-card: #ffffff;
    --text: #1a1d23;
    --text-dim: #6c757d;
    --border: rgba(0, 0, 0, 0.1);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.3s, color 0.3s;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(107, 114, 128, 0.03), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(146, 254, 157, 0.03), transparent 50%);
    pointer-events: none;
    z-index: 0;
}

.container {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

h1, h2, h3 {
    font-family: 'Outfit', sans-serif;
}

.btn {
    padding: 12px 28px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    position: relative;
    overflow: hidden;
}

.btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    transform: translate(-50%, -50%);
    transition: width 0.6s, height 0.6s;
}

.btn:active::before {
    width: 300px;
    height: 300px;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
}

.btn-secondary {
    background: var(--bg-card);
    color: var(--text);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    border-color: var(--primary);
    transform: translateY(-1px);
}

.btn-danger {
    background: var(--accent);
    color: white;
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(255, 61, 113, 0.4);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

.input {
    width: 100%;
    padding: 14px 18px;
    font-size: 15px;
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: inherit;
    transition: all 0.3s;
}

.input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.1);
    transform: translateY(-1px);
}

.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow);
    transition: all 0.3s;
}

.screen {
    display: none;
    min-height: 100vh;
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
}

.screen.active {
    display: block;
    animation: fadeIn 0.4s forwards;
}

@keyframes fadeIn {
    to {
        opacity: 1;
    }
}

/* Home */
#home {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 20px;
}

.home-content {
    max-width: 600px;
}

.title {
    font-size: 64px;
    margin-bottom: 16px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.subtitle {
    font-size: 20px;
    color: var(--text-dim);
    margin-bottom: 40px;
}

.actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 32px;
}

.username-box {
    background: var(--bg-elevated);
    padding: 24px;
    border-radius: 16px;
    margin-bottom: 32px;
    transition: all 0.3s;
}

.status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    margin-top: 16px;
}

.status.loading {
    background: rgba(251, 191, 36, 0.1);
    color: #fbbf24;
}

.status.ready {
    background: rgba(146, 254, 157, 0.1);
    color: var(--secondary);
}

.spinner {
    width: 14px;
    height: 14px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.settings-btn {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s;
    z-index: 100;
}

.settings-btn:hover {
    transform: rotate(90deg);
    border-color: var(--primary);
}

/* Config */
#config .config-wrap {
    max-width: 900px;
    margin: 40px auto;
}

.config-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.option {
    margin-bottom: 20px;
}

.option label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-dim);
    margin-bottom: 8px;
}

.range-group {
    display: flex;
    align-items: center;
    gap: 12px;
}

.range {
    flex: 1;
    height: 6px;
    -webkit-appearance: none;
    background: var(--bg-elevated);
    border-radius: 3px;
}

.range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
}

.range::-webkit-slider-thumb:hover {
    transform: scale(1.2);
}

.range-val {
    min-width: 40px;
    padding: 4px 12px;
    background: var(--primary);
    color: white;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
}

.radio-group {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.radio-btn input {
    display: none;
}

.radio-btn label {
    display: block;
    padding: 10px 16px;
    background: var(--bg-elevated);
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
}

.radio-btn input:checked + label {
    background: rgba(107, 114, 128, 0.1);
    border-color: var(--primary);
    color: var(--primary);
    transform: scale(1.05);
}

.code-big {
    font-size: 40px;
    font-family: 'Outfit', monospace;
    letter-spacing: 6px;
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, rgba(107, 114, 128, 0.1), rgba(146, 254, 157, 0.1));
    border: 2px solid var(--primary);
    border-radius: 12px;
    margin-bottom: 16px;
}

/* Lobby */
.lobby-wrap {
    max-width: 900px;
    margin: 40px auto;
    text-align: center;
}

.lobby-code {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 32px;
    background: var(--bg-card);
    border: 2px solid var(--primary);
    border-radius: 12px;
    font-size: 28px;
    font-family: 'Outfit', monospace;
    letter-spacing: 4px;
    margin: 20px 0;
}

.players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 16px;
    margin: 24px 0;
}

.player {
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    animation: pop 0.3s ease-out;
    transition: all 0.3s;
}

@keyframes pop {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.player.host {
    border-color: var(--primary);
}

.player-avatar {
    font-size: 40px;
    margin-bottom: 8px;
}

.player-name {
    font-weight: 600;
    word-break: break-word;
}

.player-ping {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
    font-size: 11px;
    color: var(--text-dim);
    margin-top: 4px;
}

.wifi-icon {
    font-size: 14px;
}

.wifi-good { color: #10b981; }
.wifi-medium { color: #f59e0b; }
.wifi-bad { color: #ef4444; }

.badge {
    display: inline-block;
    padding: 2px 8px;
    background: var(--primary);
    color: white;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    margin-top: 4px;
}

/* Game */
#game .game-wrap {
    height: calc(100vh - 40px);
    display: flex;
    flex-direction: column;
    padding: 20px;
}

.game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-card);
    border-radius: 12px;
    padding: 16px 24px;
    margin-bottom: 20px;
}

.stats {
    display: flex;
    gap: 24px;
}

.stat {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
    font-family: 'Outfit', sans-serif;
}

.game-content {
    flex: 1;
    display: grid;
    grid-template-columns: 220px 1fr 220px;
    gap: 20px;
    min-height: 0;
}

.sidebar {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 16px;
    overflow-y: auto;
}

.sidebar-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
}

.game-players .player {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: var(--bg-elevated);
    border: 2px solid var(--border);
    border-radius: 10px;
    margin-bottom: 10px;
    position: relative;
    transition: all 0.3s;
}

.game-players .player.active {
    border-color: var(--primary);
    box-shadow: 0 0 20px rgba(107, 114, 128, 0.2);
    transform: scale(1.02);
}

.game-players .player.out {
    opacity: 0.3;
    filter: grayscale(1);
}

.arrow {
    position: absolute;
    left: -25px;
    font-size: 20px;
    animation: bounce 0.6s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(-5px); }
}

.arena {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 30px;
    background: var(--bg-card);
    border-radius: 16px;
    padding: 40px;
    position: relative;
}

.bomb-wrap {
    text-align: center;
}

.bomb {
    font-size: 100px;
    display: block;
    margin-bottom: 20px;
    animation: float 2s ease-in-out infinite;
    transition: all 0.3s;
}

.bomb.critical {
    animation: shake 0.2s infinite, glow 0.5s infinite alternate;
}

@keyframes shake {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    25% { transform: translate(-3px, 0) rotate(-5deg); }
    50% { transform: translate(3px, 0) rotate(5deg); }
    75% { transform: translate(-3px, 0) rotate(-5deg); }
}

@keyframes glow {
    from { filter: drop-shadow(0 0 10px rgba(255, 61, 113, 0.5)); }
    to { filter: drop-shadow(0 0 30px rgba(255, 61, 113, 0.8)); }
}

.syllable {
    font-size: 56px;
    font-weight: 800;
    font-family: 'Outfit', sans-serif;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 6px;
}

.game-mode-indicator {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 8px 16px;
    background: rgba(107, 114, 128, 0.1);
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dim);
}

.timer-wrap {
    width: 100%;
    max-width: 400px;
}

.timer-bar {
    height: 10px;
    background: var(--bg-elevated);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 8px;
}

.timer-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--secondary), var(--primary), var(--accent));
    border-radius: 10px;
    transition: width 0.1s linear;
}

.timer-text {
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    font-family: 'Outfit', monospace;
}

.input-area {
    width: 100%;
    max-width: 500px;
    transition: all 0.3s;
}

.input-area.hide {
    display: none;
}

.turn-msg {
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 16px;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.02); }
}

.input-group {
    display: flex;
    gap: 12px;
}

.status-msg {
    text-align: center;
    font-size: 15px;
    color: var(--text-dim);
}

.words-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.word {
    padding: 5px 10px;
    background: var(--bg-elevated);
    border-radius: 6px;
    font-size: 13px;
    animation: slideInWord 0.3s;
}

@keyframes slideInWord {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.active {
    display: flex;
    animation: fadeIn 0.3s;
}

.modal-content {
    max-width: 450px;
    width: 100%;
    animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-elevated);
    border: none;
    border-radius: 8px;
    color: var(--text-dim);
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.modal-close:hover {
    background: var(--accent);
    color: white;
    transform: rotate(90deg);
}

/* Settings Modal */
#settings-modal .settings-option {
    margin-bottom: 20px;
}

.toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: var(--bg-elevated);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.toggle:hover {
    background: var(--bg-card);
}

.toggle-switch {
    width: 44px;
    height: 24px;
    background: var(--border);
    border-radius: 12px;
    position: relative;
    transition: all 0.3s;
}

.toggle-switch.active {
    background: var(--primary);
}

.toggle-switch::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    background: white;
    border-radius: 50%;
    top: 3px;
    left: 3px;
    transition: all 0.3s;
}

.toggle-switch.active::after {
    left: 23px;
}

/* Victory */
.victory {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.victory.active {
    display: flex;
    animation: fadeIn 0.5s;
}

.victory-content {
    text-align: center;
    max-width: 600px;
    animation: victoryBounce 0.6s;
}

@keyframes victoryBounce {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
}

.victory-icon {
    font-size: 100px;
    margin-bottom: 20px;
    animation: rotate 2s ease-in-out infinite;
}

@keyframes rotate {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
}

.victory-title {
    font-size: 44px;
    margin-bottom: 16px;
}

.victory-winner {
    font-size: 28px;
    color: var(--text-dim);
    margin-bottom: 40px;
}

/* Notif */
.notif {
    position: fixed;
    top: 20px;
    right: 20px;
    max-width: 380px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    display: flex;
    gap: 12px;
    animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1500;
}

@keyframes slideIn {
    from { transform: translateX(100px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.notif-icon {
    font-size: 20px;
}

.notif-content {
    flex: 1;
}

.notif-title {
    font-weight: 600;
    margin-bottom: 4px;
}

.notif-msg {
    font-size: 14px;
    color: var(--text-dim);
}

.notif.success { border-left: 4px solid #10b981; }
.notif.error { border-left: 4px solid var(--accent); }
.notif.info { border-left: 4px solid var(--primary); }

/* Responsive */
@media (max-width: 1024px) {
    .config-grid {
        grid-template-columns: 1fr;
    }
    
    .game-content {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        max-height: 200px;
    }
    
    .stats {
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .title {
        font-size: 44px;
    }
    
    .actions {
        grid-template-columns: 1fr;
    }
    
    .players-grid {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    }
    
    .code-big {
        font-size: 28px;
    }
    
    .bomb {
        font-size: 70px;
    }
    
    .syllable {
        font-size: 40px;
    }
    
    .game-header {
        flex-direction: column;
        gap: 12px;
    }
    
    .arena {
        padding: 20px;
    }
    
    .input-area {
        padding-bottom: env(safe-area-inset-bottom);
    }
}

/* Keyboard-aware adjustments for mobile */
@media (max-width: 768px) {
    body.keyboard-visible .arena {
        padding-top: 10px;
        padding-bottom: 10px;
    }
    
    body.keyboard-visible .bomb {
        font-size: 50px;
    }
    
    body.keyboard-visible .syllable {
        font-size: 32px;
    }
    
    body.keyboard-visible .game-header {
        padding: 8px 16px;
    }
}

.hide {
    display: none !important;
}

.mb-4 { margin-bottom: 16px; }
.mt-4 { margin-top: 16px; }
.text-center { text-align: center; }
.flex { display: flex; }
.gap-4 { gap: 16px; }

/* Player orbit visualization (for 30 players) */
@keyframes orbitPulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 1; }
}
    </style>
</head>
<body>

<button class="settings-btn" onclick="Game.toggleSettings()">‚öôÔ∏è</button>

<div id="home" class="screen active">
    <div class="home-content">
        <h1 class="title">üí£ Tic Tac Boom</h1>
        <p class="subtitle">Jeu de mots explosif multijoueur</p>
        
        <div class="username-box">
            <label style="display: block; margin-bottom: 12px; font-weight: 500;">Votre pseudo</label>
            <input type="text" id="username" class="input" placeholder="Entrez votre pseudo..." maxlength="15">
            <div class="text-center mt-4">
                <span id="dict-status" class="status loading">
                    <span class="spinner"></span>
                    <span>Chargement du dictionnaire...</span>
                </span>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="Game.showCreate()">
                <span>üéÆ Cr√©er une partie</span>
            </button>
            <button class="btn btn-secondary" onclick="Game.showJoin()">
                <span>üö™ Rejoindre</span>
            </button>
        </div>
        
        <p style="font-size: 14px; color: var(--text-dim);">
            Jusqu'√† 30 joueurs ‚Ä¢ Trouvez des mots avant l'explosion !
        </p>
    </div>
</div>

<div id="config" class="screen">
    <div class="container">
        <div class="config-wrap">
            <div class="card mb-4">
                <h2 style="margin-bottom: 8px;">Configuration de la Partie</h2>
                <p style="color: var(--text-dim); font-size: 14px;">Personnalisez votre exp√©rience de jeu</p>
            </div>
            
            <div class="config-grid">
                <div class="card">
                    <h3 style="margin-bottom: 20px; font-size: 18px;">‚öôÔ∏è Param√®tres</h3>
                    
                    <div class="option">
                        <label>Vies par joueur</label>
                        <div class="range-group">
                            <input type="range" class="range" id="lives" min="1" max="5" value="3" oninput="Game.updateRange('lives')">
                            <span class="range-val" id="lives-val">3</span>
                        </div>
                    </div>
                    
                    <div class="option">
                        <label>Temps initial (secondes)</label>
                        <div class="range-group">
                            <input type="range" class="range" id="timer" min="5" max="30" value="15" oninput="Game.updateRange('timer')">
                            <span class="range-val" id="timer-val">15</span>
                        </div>
                    </div>
                    
                    <div class="option">
                        <label>Difficult√©</label>
                        <div class="radio-group">
                            <div class="radio-btn">
                                <input type="radio" id="easy" name="diff" value="easy">
                                <label for="easy">üòä Facile</label>
                            </div>
                            <div class="radio-btn">
                                <input type="radio" id="medium" name="diff" value="medium" checked>
                                <label for="medium">üòê Moyen</label>
                            </div>
                            <div class="radio-btn">
                                <input type="radio" id="hard" name="diff" value="hard">
                                <label for="hard">üòà Dur</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option">
                        <label>Mode de jeu</label>
                        <div class="radio-group">
                            <div class="radio-btn">
                                <input type="radio" id="classic" name="mode" value="classic" checked>
                                <label for="classic">üéØ Classique</label>
                            </div>
                            <div class="radio-btn">
                                <input type="radio" id="expert" name="mode" value="expert">
                                <label for="expert">üéì Expert</label>
                            </div>
                            <div class="radio-btn">
                                <input type="radio" id="survival" name="mode" value="survival">
                                <label for="survival">‚ö° Survival</label>
                            </div>
                            <div class="radio-btn">
                                <input type="radio" id="thematic" name="mode" value="thematic">
                                <label for="thematic">üé® Th√©matique</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="option" id="theme-option" style="display: none;">
                        <label>Th√®me</label>
                        <select id="theme-select" class="input">
                            <option value="animaux">üêæ Animaux</option>
                            <option value="pays">üåç Pays</option>
                            <option value="objets">üî® Objets</option>
                            <option value="nourriture">üçî Nourriture</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <div class="card mb-4">
                        <h3 style="margin-bottom: 16px; font-size: 18px;">üîë Code</h3>
                        <div class="code-big" id="config-code">XXXX</div>
                        <button class="btn btn-secondary" style="width: 100%;" onclick="Game.copyCode()">
                            üìã Copier le code
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px; font-size: 18px;">
                            üë• Joueurs (<span id="config-count">1</span>/30)
                        </h3>
                        <div id="config-players"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4" style="justify-content: center;">
                <button class="btn btn-primary" id="start-btn" onclick="Game.start()" disabled>
                    üöÄ Lancer la partie
                </button>
                <button class="btn btn-danger" onclick="Game.cancel()">
                    ‚ùå Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<div id="lobby" class="screen">
    <div class="container">
        <div class="lobby-wrap">
            <h2 class="mb-4">Salon d'Attente</h2>
            <div class="lobby-code" id="lobby-code">XXXX</div>
            <p style="color: var(--text-dim); margin-bottom: 24px;">
                En attente du d√©marrage de la partie...
            </p>
            
            <div class="card mb-4">
                <h3 class="mb-4">
                    Joueurs (<span id="lobby-count">0</span>/30)
                </h3>
                <div class="players-grid" id="lobby-players"></div>
            </div>
            
            <button class="btn btn-danger" onclick="Game.leave()">
                Quitter la partie
            </button>
        </div>
    </div>
</div>

<div id="game" class="screen">
    <div class="game-wrap">
        <div class="game-header">
            <div class="stats">
                <div class="stat">
                    <span class="stat-label">Code</span>
                    <span class="stat-value" id="game-code">XXXX</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Joueurs</span>
                    <span class="stat-value" id="game-count">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Mots</span>
                    <span class="stat-value" id="game-words">0</span>
                </div>
            </div>
            <button class="btn btn-danger" onclick="Game.leave()">Quitter</button>
        </div>
        
        <div class="game-content">
            <div class="sidebar">
                <h4 class="sidebar-title">Joueurs</h4>
                <div id="game-players" class="game-players"></div>
            </div>
            
            <div class="arena">
                <div class="game-mode-indicator" id="game-mode-indicator">Mode Classique</div>
                
                <div class="bomb-wrap">
                    <span class="bomb" id="bomb">üí£</span>
                    <div class="syllable" id="syl">...</div>
                </div>
                
                <div class="timer-wrap">
                    <div class="timer-bar">
                        <div class="timer-fill" id="timer-fill"></div>
                    </div>
                    <div class="timer-text" id="timer-text">0.0s</div>
                </div>
                
                <div class="input-area hide" id="input-area">
                    <div class="turn-msg">üî• √Ä VOUS DE JOUER ! üî•</div>
                    <div class="input-group">
                        <input type="text" id="word" class="input" placeholder="Votre mot..." style="text-transform: uppercase;">
                        <button class="btn btn-primary" onclick="Game.submit()">‚úì</button>
                    </div>
                </div>
                
                <div class="status-msg" id="game-status">En attente...</div>
            </div>
            
            <div class="sidebar">
                <h4 class="sidebar-title">Mots trouv√©s</h4>
                <div class="words-wrap" id="used-words"></div>
            </div>
        </div>
    </div>
</div>

<div id="join-modal" class="modal">
    <div class="modal-content card">
        <div class="modal-header">
            <h3>Rejoindre une partie</h3>
            <button class="modal-close" onclick="Game.closeJoin()">√ó</button>
        </div>
        <div class="mb-4">
            <label style="display: block; margin-bottom: 8px; font-size: 14px;">Code du salon</label>
            <input type="text" id="join-code" class="input" placeholder="Ex: ABCD" maxlength="4" style="text-transform: uppercase;">
        </div>
        <button class="btn btn-primary" style="width: 100%;" onclick="Game.join()">
            Rejoindre
        </button>
    </div>
</div>

<div id="settings-modal" class="modal">
    <div class="modal-content card">
        <div class="modal-header">
            <h3>Param√®tres</h3>
            <button class="modal-close" onclick="Game.toggleSettings()">√ó</button>
        </div>
        
        <div class="settings-option">
            <div class="toggle" onclick="Game.toggleTheme()">
                <span>üåì Th√®me sombre</span>
                <div class="toggle-switch" id="theme-toggle"></div>
            </div>
        </div>
        
        <div class="settings-option">
            <label style="display: block; margin-bottom: 8px; font-size: 14px;">üîä Volume</label>
            <div class="range-group">
                <input type="range" class="range" id="volume" min="0" max="100" value="50" oninput="Game.updateVolume()">
                <span class="range-val" id="volume-val">50</span>
            </div>
        </div>
        
        <div class="settings-option">
            <div class="toggle" onclick="Game.togglePowerSave()">
                <span>üîã Mode √©conomie d'√©nergie</span>
                <div class="toggle-switch" id="power-toggle"></div>
            </div>
        </div>
        
        <div class="settings-option">
            <div class="toggle" onclick="Game.toggleNetStats()">
                <span>üìä Statistiques r√©seau</span>
                <div class="toggle-switch" id="stats-toggle"></div>
            </div>
        </div>
    </div>
</div>

<div id="victory" class="victory">
    <div class="victory-content">
        <div class="victory-icon">üèÜ</div>
        <h2 class="victory-title">VICTOIRE !</h2>
        <p class="victory-winner" id="winner">Gagnant</p>
        <button class="btn btn-primary" onclick="Game.home()">
            Retour au menu
        </button>
    </div>
</div>

<script>
// ==================== √âTAT GLOBAL ET CONFIGURATION ====================
const Game = {
    state: {
        user: '',
        peer: null,
        id: null,
        host: false,
        code: '',
        conn: null,
        game: null,
        dict: new Set(),
        settings: {
            theme: 'dark',
            volume: 50,
            powerSave: false,
            showNetStats: false
        },
        eventListeners: new Map(),
        isExploding: false, // Protection contre race conditions
        lastSync: Date.now()
    },
    
    // Syllabes par difficult√©
    syl: {
        easy: ['BA', 'BE', 'BI', 'BO', 'BU', 'CA', 'CO', 'DA', 'DE', 'DI', 'DO', 'FA', 'FE', 'FI', 'FO', 'GA', 'GO', 'LA', 'LE', 'LI', 'LO', 'MA', 'ME', 'MI', 'MO', 'NA', 'NE', 'NI', 'NO', 'PA', 'PE', 'PI', 'PO', 'RA', 'RE', 'RI', 'RO', 'SA', 'SE', 'SI', 'SO', 'TA', 'TE', 'TI', 'TO', 'VA', 'VE', 'VI', 'VO'],
        medium: ['AN', 'EN', 'IN', 'ON', 'UN', 'OU', 'OI', 'AI', 'AU', 'EU', 'IL', 'AR', 'ER', 'IR', 'OR', 'UR', 'CH', 'PH', 'QU', 'TR', 'BR', 'CR', 'DR', 'FR', 'GR', 'PR', 'BL', 'CL', 'FL', 'GL', 'PL'],
        hard: ['TION', 'MENT', 'ABLE', 'ANCE', 'ENCE', 'ESSE', 'ETTE', 'ISME', 'ISTE', 'EUR', 'AGE', 'OIRE', 'IEUX']
    },
    
    // Th√®mes pour le mode th√©matique
    themes: {
        animaux: ['CHAT', 'CHIEN', 'LION', 'TIGRE', 'ELEPHANT', 'GIRAFE', 'ZEBRE', 'SINGE', 'OURS', 'LOUP', 'AIGLE', 'SERPENT'],
        pays: ['FRANCE', 'ESPAGNE', 'ITALIE', 'ALLEMAGNE', 'JAPON', 'CHINE', 'BRESIL', 'CANADA', 'AUSTRALIE', 'MEXIQUE'],
        objets: ['TABLE', 'CHAISE', 'LAMPE', 'TELEPHONE', 'ORDINATEUR', 'LIVRE', 'STYLO', 'CISEAUX', 'MARTEAU'],
        nourriture: ['PAIN', 'FROMAGE', 'POMME', 'BANANE', 'PIZZA', 'PATES', 'SALADE', 'GATEAU', 'CHOCOLAT']
    },
    
    // ==================== INITIALISATION ====================
    init() {
        // Charger le pseudo sauvegard√©
        const saved = localStorage.getItem('ttb_user');
        if (saved) {
            this.state.user = this.sanitize(saved);
            document.getElementById('username').value = this.state.user;
        }
        
        // Charger les param√®tres
        const settings = localStorage.getItem('ttb_settings');
        if (settings) {
            this.state.settings = { ...this.state.settings, ...JSON.parse(settings) };
            this.applySettings();
        }
        
        // Event listeners avec nettoyage
        this.addEventListener(document.getElementById('username'), 'input', (e) => {
            this.state.user = this.sanitize(e.target.value.trim());
            localStorage.setItem('ttb_user', this.state.user);
        });
        
        this.addEventListener(document.getElementById('word'), 'keypress', (e) => {
            if (e.key === 'Enter') this.submit();
        });
        
        this.addEventListener(document.getElementById('join-code'), 'keypress', (e) => {
            if (e.key === 'Enter') this.join();
        });
        
        // Gestion du clavier mobile
        const wordInput = document.getElementById('word');
        this.addEventListener(wordInput, 'focus', () => {
            document.body.classList.add('keyboard-visible');
            setTimeout(() => {
                wordInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        });
        
        this.addEventListener(wordInput, 'blur', () => {
            document.body.classList.remove('keyboard-visible');
        });
        
        // Gestion des modes de jeu
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            this.addEventListener(radio, 'change', (e) => {
                document.getElementById('theme-option').style.display = 
                    e.target.value === 'thematic' ? 'block' : 'none';
            });
        });
        
        // Chargement du dictionnaire et initialisation PeerJS
        this.loadDict();
        this.initPeer();
    },
    
    // ==================== GESTION DES EVENT LISTENERS ====================
    addEventListener(element, event, handler) {
        if (!element) return;
        
        const key = `${element.id || 'anon'}_${event}`;
        
        // Nettoyer l'ancien listener si existant
        if (this.state.eventListeners.has(key)) {
            const oldHandler = this.state.eventListeners.get(key);
            element.removeEventListener(event, oldHandler);
        }
        
        element.addEventListener(event, handler);
        this.state.eventListeners.set(key, handler);
    },
    
    cleanup() {
        // Nettoyer tous les event listeners
        this.state.eventListeners.forEach((handler, key) => {
            const [id, event] = key.split('_');
            const element = document.getElementById(id);
            if (element) {
                element.removeEventListener(event, handler);
            }
        });
        this.state.eventListeners.clear();
        
        // Nettoyer les intervalles
        if (this.state.game?.interval) {
            clearInterval(this.state.game.interval);
            this.state.game.interval = null;
        }
        
        if (this.state.game?.pingInterval) {
            clearInterval(this.state.game.pingInterval);
            this.state.game.pingInterval = null;
        }
    },
    
    // ==================== SANITISATION XSS ====================
    sanitize(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML.replace(/[<>'"]/g, '');
    },
    
    // ==================== CHARGEMENT DU DICTIONNAIRE ====================
    async loadDict() {
        const st = document.getElementById('dict-status');
        try {
            st.className = 'status loading';
            st.innerHTML = '<span class="spinner"></span><span>Chargement...</span>';
            
            // Chargement depuis l'API Lexique.org
            const res = await fetch('https://www.lexique.org/databases/Lexique383/Lexique383.tsv');
            const txt = await res.text();
            const lines = txt.split('\n');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const cols = line.split('\t');
                if (cols.length > 0) {
                    const word = cols[0].toUpperCase().trim();
                    // Validation stricte : mots de 3+ lettres, lettres fran√ßaises uniquement
                    if (word.length >= 3 && /^[A-Z√Ä√Ç√Ñ√Ü√á√â√à√ä√ã√è√é√î≈í√ô√õ√ú]+$/.test(word)) {
                        this.state.dict.add(word);
                    }
                }
            }
            
            st.className = 'status ready';
            st.innerHTML = `<span>‚úì</span><span>${this.state.dict.size.toLocaleString()} mots charg√©s</span>`;
        } catch (e) {
            console.error('Erreur dictionnaire:', e);
            st.className = 'status ready';
            st.innerHTML = '<span>‚ö†</span><span>Mode hors-ligne</span>';
            this.loadFallback();
        }
    },
    
    loadFallback() {
        // Dictionnaire de secours
        const words = [
            'MAISON', 'VOITURE', 'CHAT', 'CHIEN', 'TABLE', 'ORDINATEUR', 'TELEPHONE', 
            'FENETRE', 'PORTE', 'SOLEIL', 'LUNE', 'ETOILE', 'ARBRE', 'FLEUR', 'RIVIERE', 
            'MONTAGNE', 'PLAGE', 'VILLE', 'BONJOUR', 'BONSOIR', 'MERCI', 'PARDON',
            'ELEPHANT', 'GIRAFE', 'LION', 'TIGRE', 'OURS', 'AIGLE', 'SERPENT',
            'FRANCE', 'ESPAGNE', 'ITALIE', 'ALLEMAGNE', 'JAPON', 'CHINE', 'BRESIL'
        ];
        words.forEach(w => this.state.dict.add(w));
    },
    
    // ==================== INITIALISATION PEERJS ====================
    initPeer() {
        const id = 'ttb-' + Math.random().toString(36).substr(2, 12);
        this.state.peer = new Peer(id, {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            },
            debug: 0
        });
        
        this.state.peer.on('open', (id) => {
            this.state.id = id;
            console.log('Peer connect√©:', id);
        });
        
        this.state.peer.on('connection', (conn) => {
            if (this.state.host) this.handleConn(conn);
        });
        
        this.state.peer.on('error', (e) => {
            console.error('Erreur Peer:', e);
            if (e.type === 'peer-unavailable') {
                this.notif('‚ùå Erreur', 'Salon introuvable', 'error');
            } else {
                this.notif('‚ùå Erreur r√©seau', e.message, 'error');
            }
        });
    },
    
    // ==================== CR√âATION DE PARTIE ====================
    showCreate() {
        if (!this.check()) return;
        
        this.state.code = this.genCode();
        this.state.host = true;
        
        // Recr√©er le peer avec l'ID de la room
        const roomId = 'ttb-room-' + this.state.code.toLowerCase();
        if (this.state.peer) {
            this.state.peer.destroy();
        }
        
        this.state.peer = new Peer(roomId, {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            },
            debug: 0
        });
        
        this.state.peer.on('open', (id) => {
            this.state.id = id;
            console.log('Room cr√©√©e:', id);
        });
        
        this.state.peer.on('connection', (conn) => {
            this.handleConn(conn);
        });
        
        // Initialiser l'√©tat du jeu
        this.state.game = {
            code: this.state.code,
            hostId: this.state.id,
            state: 'CONFIG',
            config: { 
                lives: 3, 
                timer: 15, 
                diff: 'medium',
                mode: 'classic',
                theme: null
            },
            players: [{
                id: this.state.id,
                name: this.state.user,
                lives: 3,
                out: false,
                host: true,
                ping: 0
            }],
            turn: 0,
            syl: '',
            timer: 0,
            maxTimer: 15,
            words: [],
            conns: new Map(),
            pingData: new Map(),
            roundNumber: 0
        };
        
        document.getElementById('config-code').textContent = this.state.code;
        this.updateConfigPlayers();
        this.show('config');
        
        // D√©marrer le monitoring du ping
        this.startPingMonitoring();
    },
    
    genCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 4; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    },
    
    // ==================== MONITORING PING ====================
    startPingMonitoring() {
        if (!this.state.host || !this.state.game) return;
        
        // Nettoyer l'ancien interval
        if (this.state.game.pingInterval) {
            clearInterval(this.state.game.pingInterval);
        }
        
        this.state.game.pingInterval = setInterval(() => {
            if (!this.state.game) return;
            
            const now = Date.now();
            this.state.game.conns.forEach((conn, id) => {
                try {
                    conn.send({
                        type: 'PING',
                        timestamp: now
                    });
                } catch (e) {
                    console.error('Erreur ping:', e);
                }
            });
        }, 2000);
    },
    
    calculatePing(playerId, responseTime) {
        if (!this.state.game) return;
        
        const pingData = this.state.game.pingData.get(playerId) || [];
        pingData.push(responseTime);
        
        // Garder seulement les 5 derniers pings
        if (pingData.length > 5) {
            pingData.shift();
        }
        
        this.state.game.pingData.set(playerId, pingData);
        
        // Calculer la moyenne
        const avgPing = Math.round(pingData.reduce((a, b) => a + b, 0) / pingData.length);
        
        // Mettre √† jour le joueur
        const player = this.state.game.players.find(p => p.id === playerId);
        if (player) {
            player.ping = avgPing;
        }
        
        return avgPing;
    },
    
    getPingQuality(ping) {
        if (ping < 100) return 'good';
        if (ping < 200) return 'medium';
        return 'bad';
    },
    
    getWifiIcon(quality) {
        const icons = {
            good: 'üì∂',
            medium: 'üì∂',
            bad: 'üìµ'
        };
        return icons[quality] || 'üì∂';
    },
    
    // ==================== GESTION DES PARAM√àTRES ====================
    updateRange(type) {
        const val = document.getElementById(type).value;
        document.getElementById(type + '-val').textContent = val;
        if (this.state.game) {
            if (type === 'lives') this.state.game.config.lives = parseInt(val);
            if (type === 'timer') this.state.game.config.timer = parseInt(val);
        }
    },
    
    copyCode() {
        navigator.clipboard.writeText(this.state.code)
            .then(() => this.notif('‚úì Copi√© !', 'Code copi√© dans le presse-papier', 'success'))
            .catch(() => this.notif('‚ùå Erreur', 'Impossible de copier', 'error'));
    },
    
    updateConfigPlayers() {
        const cont = document.getElementById('config-players');
        const count = document.getElementById('config-count');
        
        if (!this.state.game) return;
        
        count.textContent = this.state.game.players.length;
        cont.innerHTML = '';
        
        this.state.game.players.forEach(p => {
            const div = document.createElement('div');
            div.style = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 8px;';
            
            const pingInfo = this.state.settings.showNetStats && p.ping !== undefined
                ? `<span style="font-size: 11px; color: var(--text-dim);">${p.ping}ms</span>`
                : '';
            
            div.innerHTML = `
                <span style="font-size: 18px;">üë§</span>
                <span style="flex: 1; font-weight: 600;">${this.sanitize(p.name)}</span>
                ${pingInfo}
                ${p.host ? '<span class="badge">H√¥te</span>' : ''}
            `;
            cont.appendChild(div);
        });
        
        document.getElementById('start-btn').disabled = this.state.game.players.length < 2;
    },
    
    cancel() {
        if (confirm('Voulez-vous annuler la cr√©ation de la partie ?')) {
            this.cleanup();
            if (this.state.game) {
                this.state.game.conns.forEach(c => c.close());
                this.state.game = null;
            }
            this.state.host = false;
            this.state.code = '';
            this.show('home');
        }
    },
    
    // ==================== REJOINDRE UNE PARTIE ====================
    showJoin() {
        if (!this.check()) return;
        document.getElementById('join-modal').classList.add('active');
        document.getElementById('join-code').focus();
    },
    
    closeJoin() {
        document.getElementById('join-modal').classList.remove('active');
        document.getElementById('join-code').value = '';
    },
    
    join() {
        const code = document.getElementById('join-code').value.trim().toUpperCase();
        
        if (code.length !== 4) {
            this.notif('‚ùå Code invalide', 'Le code doit contenir 4 caract√®res', 'error');
            return;
        }
        
        this.state.code = code;
        this.state.host = false;
        
        const hostId = 'ttb-room-' + code.toLowerCase();
        const conn = this.state.peer.connect(hostId);
        
        conn.on('open', () => {
            this.state.conn = conn;
            conn.send({
                type: 'JOIN',
                id: this.state.id,
                name: this.state.user
            });
            
            this.closeJoin();
            this.show('lobby');
            this.notif('‚úì Connect√© !', 'Vous avez rejoint la partie', 'success');
        });
        
        conn.on('data', (d) => this.handleClient(d));
        
        conn.on('close', () => {
            this.notif('‚ö† D√©connect√©', 'Connexion perdue avec l\'h√¥te', 'error');
            setTimeout(() => this.home(), 2000);
        });
        
        conn.on('error', (e) => {
            console.error('Erreur connexion:', e);
            this.notif('‚ùå Erreur', 'Impossible de rejoindre la partie', 'error');
            this.closeJoin();
        });
    },
    
    leave() {
        if (confirm('Voulez-vous quitter la partie ?')) {
            if (this.state.conn) {
                this.state.conn.send({ type: 'LEAVE', id: this.state.id });
                this.state.conn.close();
                this.state.conn = null;
            }
            this.home();
        }
    },
    
    // ==================== GESTION DES CONNEXIONS (H√îTE) ====================
    handleConn(conn) {
        conn.on('data', (d) => this.handleHost(d, conn));
        conn.on('close', () => this.disconnect(conn.peer));
        conn.on('error', (e) => {
            console.error('Erreur connexion:', e);
            this.disconnect(conn.peer);
        });
    },
    
    handleHost(d, conn) {
        if (!this.state.game) return;
        
        // Protection contre les injections
        if (typeof d !== 'object') return;
        
        switch (d.type) {
            case 'JOIN':
                this.handleJoin(d, conn);
                break;
            
            case 'WORD':
                this.handleWordSubmission(d);
                break;
            
            case 'LEAVE':
                conn.close();
                break;
            
            case 'PONG':
                // Calculer le ping
                const ping = Date.now() - d.timestamp;
                this.calculatePing(d.id, ping);
                this.broadcast();
                break;
        }
    },
    
    handleJoin(d, conn) {
        if (this.state.game.state !== 'CONFIG') {
            conn.send({ type: 'ERROR', msg: 'Partie d√©j√† commenc√©e' });
            conn.close();
            return;
        }
        
        if (this.state.game.players.length >= 30) {
            conn.send({ type: 'ERROR', msg: 'Partie compl√®te (30 joueurs max)' });
            conn.close();
            return;
        }
        
        // V√©rifier les doublons
        if (this.state.game.players.some(p => p.id === d.id)) {
            conn.send({ type: 'ERROR', msg: 'Vous √™tes d√©j√† connect√©' });
            conn.close();
            return;
        }
        
        this.state.game.players.push({
            id: d.id,
            name: this.sanitize(d.name),
            lives: this.state.game.config.lives,
            out: false,
            host: false,
            ping: 0
        });
        
        this.state.game.conns.set(d.id, conn);
        this.notif('üëã Nouveau joueur', this.sanitize(d.name) + ' a rejoint', 'info');
        
        conn.send({
            type: 'SYNC',
            state: this.serialize()
        });
        
        this.updateConfigPlayers();
        this.broadcast();
    },
    
    handleWordSubmission(d) {
        const current = this.state.game.players[this.state.game.turn];
        if (current && current.id === d.id && !this.state.isExploding) {
            this.validate(this.sanitize(d.word));
        }
    },
    
    disconnect(id) {
        if (!this.state.game) return;
        
        const idx = this.state.game.players.findIndex(p => p.id === id);
        if (idx !== -1) {
            const name = this.state.game.players[idx].name;
            this.state.game.players.splice(idx, 1);
            this.state.game.conns.delete(id);
            this.state.game.pingData.delete(id);
            
            this.notif('üëã Joueur parti', name, 'info');
            
            // Si c'√©tait le tour du joueur d√©connect√©
            if (this.state.game.turn >= this.state.game.players.length) {
                this.state.game.turn = 0;
            }
            
            // Si plus assez de joueurs en jeu
            if (this.state.game.state === 'PLAYING') {
                const alive = this.state.game.players.filter(p => !p.out);
                if (alive.length <= 1 && alive.length > 0) {
                    this.end(alive[0]);
                    return;
                } else if (alive.length === 0) {
                    this.notif('‚ö† Partie annul√©e', 'Plus de joueurs', 'error');
                    setTimeout(() => this.home(), 2000);
                    return;
                }
            }
            
            this.updateConfigPlayers();
            this.broadcast();
        }
    },
    
    // ==================== GESTION DES MESSAGES (CLIENT) ====================
    handleClient(d) {
        if (typeof d !== 'object') return;
        
        switch (d.type) {
            case 'SYNC':
                this.handleSync(d);
                break;
            
            case 'ERROR':
                this.notif('‚ùå Erreur', d.msg, 'error');
                break;
            
            case 'PING':
                // R√©pondre imm√©diatement
                if (this.state.conn) {
                    this.state.conn.send({
                        type: 'PONG',
                        id: this.state.id,
                        timestamp: d.timestamp
                    });
                }
                break;
        }
    },
    
    handleSync(d) {
        const oldState = this.state.game?.state;
        this.state.game = d.state;
        this.state.lastSync = Date.now();
        
        // Transition d'√©tat
        if (oldState !== d.state.state) {
            if (d.state.state === 'PLAYING' && this.state.screen !== 'game') {
                this.show('game');
            }
        }
        
        // Mise √† jour de l'affichage
        if (this.state.screen === 'lobby') {
            this.renderLobby();
        } else if (this.state.screen === 'game') {
            this.renderGame();
        }
    },
    
    // ==================== D√âMARRAGE DE LA PARTIE ====================
    start() {
        if (!this.state.host || !this.state.game) return;
        if (this.state.game.players.length < 2) {
            this.notif('‚ùå Erreur', 'Minimum 2 joueurs requis', 'error');
            return;
        }
        
        // R√©cup√©rer la difficult√©
        const diffs = document.getElementsByName('diff');
        for (let d of diffs) {
            if (d.checked) {
                this.state.game.config.diff = d.value;
                break;
            }
        }
        
        // R√©cup√©rer le mode de jeu
        const modes = document.getElementsByName('mode');
        for (let m of modes) {
            if (m.checked) {
                this.state.game.config.mode = m.value;
                break;
            }
        }
        
        // R√©cup√©rer le th√®me si mode th√©matique
        if (this.state.game.config.mode === 'thematic') {
            this.state.game.config.theme = document.getElementById('theme-select').value;
        }
        
        // Initialiser les joueurs
        this.state.game.players.forEach(p => {
            p.lives = this.state.game.config.lives;
            p.out = false;
        });
        
        this.state.game.state = 'PLAYING';
        this.state.game.maxTimer = this.state.game.config.timer;
        this.state.game.words = [];
        this.state.game.roundNumber = 0;
        
        this.newRound();
        this.show('game');
        this.renderGame();
        this.broadcast();
        this.notif('üöÄ Partie lanc√©e !', 'Bonne chance !', 'success');
        
        // Confetti de d√©marrage
        confetti({
            particleCount: 50,
            spread: 60,
            origin: { y: 0.7 }
        });
    },
    
    // ==================== GESTION DES ROUNDS ====================
    newRound() {
        if (!this.state.game) return;
        
        this.state.game.roundNumber++;
        this.state.isExploding = false;
        
        // S√©lectionner la syllabe selon la difficult√©
        const list = this.syl[this.state.game.config.diff] || this.syl.medium;
        this.state.game.syl = list[Math.floor(Math.random() * list.length)];
        
        // Compensation de latence : utiliser le timestamp de l'h√¥te
        this.state.game.timerStart = Date.now();
        this.state.game.timer = this.state.game.maxTimer;
        
        // Nettoyer l'ancien interval
        if (this.state.game.interval) {
            clearInterval(this.state.game.interval);
        }
        
        // Timer synchronis√© sur l'horloge de l'h√¥te
        this.state.game.interval = setInterval(() => {
            if (!this.state.game || this.state.isExploding) return;
            
            // Calcul bas√© sur le temps √©coul√© depuis le d√©but du round
            const elapsed = (Date.now() - this.state.game.timerStart) / 1000;
            this.state.game.timer = Math.max(0, this.state.game.maxTimer - elapsed);
            
            if (this.state.game.timer <= 0) {
                this.explode();
            } else {
                // Broadcast toutes les 200ms pour synchronisation
                if (Math.floor(elapsed * 5) % 1 === 0) {
                    this.broadcast();
                }
            }
            
            if (this.state.screen === 'game') {
                this.updateTimer();
            }
        }, 100);
        
        this.broadcast();
    },
    
    // ==================== EXPLOSION (PROTECTION RACE CONDITION) ====================
    explode() {
        if (!this.state.game || this.state.isExploding) return;
        
        // Protection contre les explosions multiples
        this.state.isExploding = true;
        
        clearInterval(this.state.game.interval);
        this.state.game.interval = null;
        this.state.game.timer = 0;
        
        const curr = this.state.game.players[this.state.game.turn];
        if (!curr) return;
        
        curr.lives -= 1;
        
        this.notif('üí• BOOM !', curr.name + ' perd une vie !', 'error');
        
        if (curr.lives <= 0) {
            curr.out = true;
            this.notif('‚ò†Ô∏è √âlimin√©', curr.name + ' est √©limin√© !', 'error');
        }
        
        // V√©rifier la victoire
        const alive = this.state.game.players.filter(p => !p.out);
        if (alive.length === 1) {
            setTimeout(() => {
                this.end(alive[0]);
            }, 1500);
            return;
        }
        
        if (alive.length === 0) {
            this.notif('‚ö† √âgalit√©', 'Tous les joueurs sont √©limin√©s', 'info');
            setTimeout(() => this.home(), 2000);
            return;
        }
        
        this.nextTurn();
        this.broadcast();
        
        // Nouveau round apr√®s 2 secondes
        setTimeout(() => {
            if (this.state.game) {
                this.newRound();
            }
        }, 2000);
    },
    
    nextTurn() {
        if (!this.state.game) return;
        
        let tries = 0;
        const maxTries = this.state.game.players.length;
        
        do {
            this.state.game.turn = (this.state.game.turn + 1) % this.state.game.players.length;
            tries++;
        } while (
            this.state.game.players[this.state.game.turn].out &&
            tries < maxTries
        );
    },
    
    // ==================== VALIDATION DES MOTS ====================
    validate(word) {
        if (!this.state.game || this.state.isExploding) return;
        
        word = word.trim().toUpperCase();
        
        // V√©rifier la longueur minimale
        if (word.length < 3) {
            this.notif('‚ùå Trop court', 'Minimum 3 lettres', 'error');
            return;
        }
        
        // Normaliser pour la comparaison
        const norm = word.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const sylNorm = this.state.game.syl.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        
        // Validation selon le mode de jeu
        const mode = this.state.game.config.mode;
        
        if (mode === 'expert') {
            // Mode Expert : syllabe en d√©but ou fin uniquement
            if (!norm.startsWith(sylNorm) && !norm.endsWith(sylNorm)) {
                this.notif('‚ùå Position incorrecte', 'Syllabe doit √™tre au d√©but ou √† la fin', 'error');
                return;
            }
        } else if (mode === 'thematic') {
            // Mode Th√©matique : v√©rifier le th√®me
            const theme = this.state.game.config.theme;
            const themeWords = this.themes[theme] || [];
            const isInTheme = themeWords.some(tw => norm.includes(tw) || tw.includes(norm));
            
            if (!isInTheme) {
                this.notif('‚ùå Hors th√®me', 'Le mot ne correspond pas au th√®me', 'error');
                return;
            }
            
            // V√©rifier aussi la pr√©sence de la syllabe
            if (!norm.includes(sylNorm)) {
                this.notif('‚ùå Syllabe absente', 'La syllabe n\'est pas dans le mot', 'error');
                return;
            }
        } else {
            // Mode Classique et Survival : syllabe n'importe o√π
            if (!norm.includes(sylNorm)) {
                this.notif('‚ùå Syllabe absente', 'La syllabe n\'est pas dans le mot', 'error');
                return;
            }
        }
        
        // V√©rifier si le mot a d√©j√† √©t√© utilis√©
        if (this.state.game.words.includes(word)) {
            this.notif('‚ùå D√©j√† utilis√©', 'Ce mot a d√©j√† √©t√© dit', 'error');
            return;
        }
        
        // V√©rifier dans le dictionnaire
        if (this.state.dict.size > 0) {
            const found = this.state.dict.has(word) || this.state.dict.has(norm);
            if (!found) {
                this.notif('‚ùå Mot introuvable', 'Pas dans le dictionnaire', 'error');
                return;
            }
        }
        
        // Mot valide !
        this.state.isExploding = true;
        this.state.game.words.push(word);
        
        clearInterval(this.state.game.interval);
        this.state.game.interval = null;
        
        // Mode Survival : r√©duire le timer de 10%
        if (mode === 'survival') {
            this.state.game.maxTimer = Math.max(3, this.state.game.maxTimer * 0.9);
        } else {
            // Autres modes : r√©duction progressive standard
            this.state.game.maxTimer = Math.max(3, this.state.game.maxTimer * 0.95);
        }
        
        this.notif('‚úÖ Correct !', word, 'success');
        
        this.nextTurn();
        this.broadcast();
        
        // Nouveau round apr√®s 1.5 secondes
        setTimeout(() => {
            if (this.state.game) {
                this.newRound();
            }
        }, 1500);
    },
    
    // ==================== FIN DE PARTIE ====================
    end(winner) {
        if (!this.state.game) return;
        
        this.state.game.state = 'ENDED';
        this.state.game.winner = winner;
        
        if (this.state.game.interval) {
            clearInterval(this.state.game.interval);
            this.state.game.interval = null;
        }
        
        this.broadcast();
        this.showVictory(winner);
        
        // Super confetti !
        const count = 200;
        const defaults = {
            origin: { y: 0.7 }
        };
        
        function fire(particleRatio, opts) {
            confetti({
                ...defaults,
                ...opts,
                particleCount: Math.floor(count * particleRatio)
            });
        }
        
        fire(0.25, { spread: 26, startVelocity: 55 });
        fire(0.2, { spread: 60 });
        fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
        fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
        fire(0.1, { spread: 120, startVelocity: 45 });
    },
    
    // ==================== SOUMISSION DU MOT ====================
    submit() {
        const input = document.getElementById('word');
        const word = input.value.trim().toUpperCase();
        
        if (!word) return;
        
        if (this.state.host) {
            this.validate(word);
        } else if (this.state.conn) {
            this.state.conn.send({
                type: 'WORD',
                id: this.state.id,
                word: word
            });
        }
        
        input.value = '';
    },
    
    // ==================== RENDU LOBBY ====================
    renderLobby() {
        if (!this.state.game) return;
        
        document.getElementById('lobby-code').textContent = this.state.game.code;
        document.getElementById('lobby-count').textContent = this.state.game.players.length;
        
        const cont = document.getElementById('lobby-players');
        cont.innerHTML = '';
        
        this.state.game.players.forEach(p => {
            const div = document.createElement('div');
            div.className = 'player' + (p.host ? ' host' : '');
            
            const pingHtml = this.state.settings.showNetStats && p.ping !== undefined
                ? `<div class="player-ping">
                     <span class="wifi-icon wifi-${this.getPingQuality(p.ping)}">${this.getWifiIcon(this.getPingQuality(p.ping))}</span>
                     <span>${p.ping}ms</span>
                   </div>`
                : '';
            
            div.innerHTML = `
                <div class="player-avatar">üë§</div>
                <div class="player-name">${this.sanitize(p.name)}</div>
                ${p.host ? '<span class="badge">H√¥te</span>' : ''}
                ${pingHtml}
            `;
            cont.appendChild(div);
        });
    },
    
    // ==================== RENDU JEU ====================
    renderGame() {
        if (!this.state.game) return;
        
        // Mise √† jour des statistiques
        document.getElementById('game-code').textContent = this.state.game.code;
        document.getElementById('game-count').textContent = this.state.game.players.filter(p => !p.out).length;
        document.getElementById('game-words').textContent = this.state.game.words.length;
        
        // Mise √† jour de la syllabe
        document.getElementById('syl').textContent = this.state.game.syl || '...';
        
        // Indicateur de mode
        const modeNames = {
            classic: 'Mode Classique',
            expert: 'Mode Expert',
            survival: 'Mode Survival',
            thematic: 'Mode Th√©matique'
        };
        document.getElementById('game-mode-indicator').textContent = modeNames[this.state.game.config.mode] || 'Mode Classique';
        
        // Mise √† jour du timer
        this.updateTimer();
        
        // Rendu des joueurs avec algorithme optimis√©
        this.renderPlayers();
        
        // Gestion du tour du joueur
        const myTurn = this.state.game.players[this.state.game.turn]?.id === this.state.id &&
                       this.state.game.state === 'PLAYING' &&
                       !this.state.isExploding;
        
        const inputArea = document.getElementById('input-area');
        const status = document.getElementById('game-status');
        
        if (myTurn) {
            inputArea.classList.remove('hide');
            status.textContent = '';
            setTimeout(() => {
                const wordInput = document.getElementById('word');
                if (wordInput) wordInput.focus();
            }, 100);
        } else {
            inputArea.classList.add('hide');
            
            if (this.state.game.state === 'ENDED') {
                status.textContent = 'üèÜ Partie termin√©e !';
            } else if (this.state.game.state === 'PLAYING') {
                const curr = this.state.game.players[this.state.game.turn];
                status.textContent = `Tour de ${this.sanitize(curr.name)}...`;
            } else {
                status.textContent = 'En attente...';
            }
        }
        
        // Affichage des mots utilis√©s
        const words = document.getElementById('used-words');
        words.innerHTML = '';
        
        this.state.game.words.slice().reverse().slice(0, 20).forEach(w => {
            const span = document.createElement('span');
            span.className = 'word';
            span.textContent = this.sanitize(w);
            words.appendChild(span);
        });
        
        // Animation de la bombe
        const bomb = document.getElementById('bomb');
        if (this.state.game.timer < 5 && this.state.game.state === 'PLAYING' && !this.state.isExploding) {
            bomb.classList.add('critical');
        } else {
            bomb.classList.remove('critical');
        }
    },
    
    // ==================== RENDU DES JOUEURS (OPTIMIS√â) ====================
    renderPlayers() {
        const players = document.getElementById('game-players');
        
        // Mise √† jour group√©e du DOM
        const fragment = document.createDocumentFragment();
        
        this.state.game.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'player';
            
            if (i === this.state.game.turn && this.state.game.state === 'PLAYING') {
                div.classList.add('active');
            }
            
            if (p.out) {
                div.classList.add('out');
            }
            
            const hearts = '‚ù§Ô∏è'.repeat(Math.max(0, p.lives));
            
            const pingHtml = this.state.settings.showNetStats && p.ping !== undefined
                ? `<span style="font-size: 10px; color: var(--text-dim);">${p.ping}ms</span>`
                : '';
            
            div.innerHTML = `
                ${i === this.state.game.turn && this.state.game.state === 'PLAYING' ? '<span class="arrow">üëâ</span>' : ''}
                <span style="font-size: 28px;">üë§</span>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis;">${this.sanitize(p.name)}</div>
                    <div style="font-size: 14px; margin-top: 4px; display: flex; gap: 4px; align-items: center;">
                        ${hearts}
                        ${pingHtml}
                    </div>
                </div>
            `;
            
            fragment.appendChild(div);
        });
        
        // Une seule mise √† jour du DOM
        players.innerHTML = '';
        players.appendChild(fragment);
    },
    
    // ==================== MISE √Ä JOUR DU TIMER ====================
    updateTimer() {
        if (!this.state.game) return;
        
        const pct = Math.max(0, (this.state.game.timer / this.state.game.maxTimer) * 100);
        const fill = document.getElementById('timer-fill');
        const text = document.getElementById('timer-text');
        
        if (fill) fill.style.width = pct + '%';
        if (text) text.textContent = Math.max(0, this.state.game.timer).toFixed(1) + 's';
    },
    
    // ==================== AFFICHAGE DE LA VICTOIRE ====================
    showVictory(winner) {
        document.getElementById('winner').textContent = this.sanitize(winner.name);
        document.getElementById('victory').classList.add('active');
    },
    
    // ==================== BROADCAST (H√îTE) ====================
    broadcast() {
        if (!this.state.host || !this.state.game) return;
        
        // √âviter les broadcasts trop fr√©quents
        const now = Date.now();
        if (now - this.state.lastSync < 50) return;
        this.state.lastSync = now;
        
        const msg = {
            type: 'SYNC',
            state: this.serialize()
        };
        
        this.state.game.conns.forEach(c => {
            try {
                c.send(msg);
            } catch (e) {
                console.error('Erreur broadcast:', e);
            }
        });
        
        // Mise √† jour locale
        if (this.state.screen === 'config') {
            this.updateConfigPlayers();
        } else if (this.state.screen === 'lobby') {
            this.renderLobby();
        } else if (this.state.screen === 'game') {
            this.renderGame();
        }
    },
    
    serialize() {
        return {
            code: this.state.game.code,
            hostId: this.state.game.hostId,
            state: this.state.game.state,
            config: this.state.game.config,
            players: this.state.game.players,
            turn: this.state.game.turn,
            syl: this.state.game.syl,
            timer: this.state.game.timer,
            maxTimer: this.state.game.maxTimer,
            timerStart: this.state.game.timerStart,
            words: this.state.game.words,
            winner: this.state.game.winner,
            roundNumber: this.state.game.roundNumber
        };
    },
    
    // ==================== PARAM√àTRES ====================
    toggleSettings() {
        const modal = document.getElementById('settings-modal');
        modal.classList.toggle('active');
    },
    
    toggleTheme() {
        this.state.settings.theme = this.state.settings.theme === 'dark' ? 'light' : 'dark';
        this.applySettings();
        this.saveSettings();
    },
    
    updateVolume() {
        const val = document.getElementById('volume').value;
        document.getElementById('volume-val').textContent = val;
        this.state.settings.volume = parseInt(val);
        this.saveSettings();
    },
    
    togglePowerSave() {
        this.state.settings.powerSave = !this.state.settings.powerSave;
        document.getElementById('power-toggle').classList.toggle('active', this.state.settings.powerSave);
        this.saveSettings();
    },
    
    toggleNetStats() {
        this.state.settings.showNetStats = !this.state.settings.showNetStats;
        document.getElementById('stats-toggle').classList.toggle('active', this.state.settings.showNetStats);
        this.saveSettings();
        
        // Rafra√Æchir l'affichage
        if (this.state.game) {
            if (this.state.screen === 'config') {
                this.updateConfigPlayers();
            } else if (this.state.screen === 'lobby') {
                this.renderLobby();
            } else if (this.state.screen === 'game') {
                this.renderGame();
            }
        }
    },
    
    applySettings() {
        // Th√®me
        document.documentElement.setAttribute('data-theme', this.state.settings.theme);
        document.getElementById('theme-toggle').classList.toggle('active', this.state.settings.theme === 'dark');
        
        // Volume
        document.getElementById('volume').value = this.state.settings.volume;
        document.getElementById('volume-val').textContent = this.state.settings.volume;
        
        // Mode √©conomie d'√©nergie
        document.getElementById('power-toggle').classList.toggle('active', this.state.settings.powerSave);
        if (this.state.settings.powerSave) {
            document.body.style.animationDuration = '10s';
        } else {
            document.body.style.animationDuration = '';
        }
        
        // Statistiques r√©seau
        document.getElementById('stats-toggle').classList.toggle('active', this.state.settings.showNetStats);
    },
    
    saveSettings() {
        localStorage.setItem('ttb_settings', JSON.stringify(this.state.settings));
    },
    
    // ==================== UTILITAIRES ====================
    check() {
        if (!this.state.user || this.state.user.length < 2) {
            this.notif('‚ö† Pseudo requis', 'Minimum 2 caract√®res', 'info');
            document.getElementById('username').focus();
            return false;
        }
        return true;
    },
    
    notif(title, msg, type = 'info') {
        const n = document.createElement('div');
        n.className = 'notif ' + type;
        
        const icons = {
            success: '‚úì',
            error: '‚úó',
            info: '‚Ñπ'
        };
        
        n.innerHTML = `
            <div class="notif-icon">${icons[type] || '‚Ñπ'}</div>
            <div class="notif-content">
                <div class="notif-title">${this.sanitize(title)}</div>
                <div class="notif-msg">${this.sanitize(msg)}</div>
            </div>
        `;
        
        document.body.appendChild(n);
        
        setTimeout(() => {
            n.style.animation = 'slideIn 0.3s reverse';
            setTimeout(() => n.remove(), 300);
        }, 3000);
    },
    
    show(name) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screen = document.getElementById(name);
        if (screen) {
            screen.classList.add('active');
        }
        this.state.screen = name;
    },
    
    home() {
        this.cleanup();
        
        if (this.state.host && this.state.game) {
            this.state.game.conns.forEach(c => c.close());
        }
        
        if (this.state.conn) {
            this.state.conn.close();
            this.state.conn = null;
        }
        
        this.state.game = null;
        this.state.host = false;
        this.state.code = '';
        this.state.isExploding = false;
        
        document.getElementById('victory').classList.remove('active');
        this.show('home');
    }
};

// ==================== D√âMARRAGE ====================
document.addEventListener('DOMContentLoaded', () => Game.init());

// Protection contre les fermetures accidentelles
window.addEventListener('beforeunload', (e) => {
    if (Game.state.game && Game.state.game.state === 'PLAYING') {
        e.preventDefault();
        e.returnValue = 'Partie en cours. √ätes-vous s√ªr de vouloir quitter ?';
    }
});

// Nettoyage lors de la fermeture
window.addEventListener('unload', () => {
    Game.cleanup();
});
</script>
</body>
</html>
