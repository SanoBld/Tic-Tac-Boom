<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tic Tac Boom - √âdition Ultimate Pro</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
    /* =========================================
       1. VARIABLES & TH√àMES
       ========================================= */
    :root {
        /* Palette Neutre (Gris) - Mode Sombre par d√©faut */
        --bg-app: #0f0f0f;
        --bg-surface: #1a1a1a;
        --bg-surface-hover: #252525;
        --bg-overlay: rgba(0, 0, 0, 0.9);
        
        --text-main: #ffffff;
        --text-muted: #9ca3af;
        --text-inverse: #000000;

        --border: #2a2a2a;
        --border-focus: #404040;

        /* Accents color√©s */
        --accent: #6366f1;
        --accent-success: #10b981;
        --accent-danger: #ef4444;
        --accent-warning: #f59e0b;
        --accent-info: #3b82f6;
        --accent-purple: #a855f7;
        --accent-pink: #ec4899;
        --accent-cyan: #06b6d4;

        --radius-sm: 8px;
        --radius-md: 12px;
        --radius-lg: 20px;
        --radius-xl: 28px;
        --radius-full: 9999px;

        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

        --font-main: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        
        /* Animation speeds (modifiable par √©conomie d'√©nergie) */
        --anim-speed: 1;
    }

    /* Mode Clair */
    [data-theme="light"] {
        --bg-app: #f8fafc;
        --bg-surface: #ffffff;
        --bg-surface-hover: #f1f5f9;
        --bg-overlay: rgba(255, 255, 255, 0.95);
        
        --text-main: #0f172a;
        --text-muted: #64748b;
        --text-inverse: #ffffff;

        --border: #e2e8f0;
        --border-focus: #cbd5e1;

        --accent: #4f46e5;
    }

    /* Mode √âconomie d'√ânergie */
    [data-power-saving="true"] {
        --anim-speed: 0;
    }

    /* =========================================
       2. RESET & BASE
       ========================================= */
    * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
        -webkit-tap-highlight-color: transparent; 
    }
    
    body {
        font-family: var(--font-main);
        background: linear-gradient(135deg, var(--bg-app) 0%, #0a0a0a 100%);
        color: var(--text-main);
        line-height: 1.6;
        overflow-x: hidden;
        transition: background-color 0.3s ease, color 0.3s ease;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    button { 
        font-family: inherit; 
        border: none; 
        outline: none; 
        background: none; 
        cursor: pointer;
        user-select: none;
    }
    
    input { 
        font-family: inherit; 
        border: none; 
        outline: none; 
    }

    .hidden { display: none !important; }

    /* Animation globale d√©sactivable */
    .animate {
        animation-duration: calc(0.3s / var(--anim-speed, 1));
    }

    /* =========================================
       3. COMPOSANTS UI AM√âLIOR√âS
       ========================================= */
    
    /* Boutons Modernes Redessin√©s */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.875rem 1.75rem;
        font-size: 0.95rem;
        font-weight: 600;
        border-radius: var(--radius-md);
        background-color: var(--bg-surface);
        color: var(--text-main);
        border: 2px solid var(--border);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1));
        opacity: 0;
        transition: opacity 0.3s;
    }

    .btn:hover:not(:disabled)::before {
        opacity: 1;
    }

    .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
        border-color: var(--border-focus);
    }

    .btn:active:not(:disabled) {
        transform: translateY(0) scale(0.97);
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--accent), var(--accent-purple));
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
    }
    
    .btn-primary:hover:not(:disabled) {
        box-shadow: 0 6px 25px rgba(99, 102, 241, 0.6);
    }

    .btn-danger { 
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)); 
        color: var(--accent-danger); 
        border-color: rgba(239, 68, 68, 0.3); 
    }
    .btn-danger:hover:not(:disabled) { 
        background: var(--accent-danger); 
        color: white; 
        border-color: var(--accent-danger);
    }

    .btn-success { 
        background: linear-gradient(135deg, var(--accent-success), #059669); 
        color: white; 
        border-color: transparent; 
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
    }
    
    .btn-icon { 
        width: 38px; 
        height: 38px; 
        padding: 0; 
        border-radius: 50%; 
        font-size: 1rem; 
    }

    .btn:disabled { 
        opacity: 0.4; 
        cursor: not-allowed; 
        transform: none; 
    }

    /* Inputs am√©lior√©s */
    .input-group { 
        position: relative; 
        width: 100%; 
    }
    
    .input {
        width: 100%;
        padding: 1rem 1.25rem;
        background-color: var(--bg-surface);
        border: 2px solid var(--border);
        border-radius: var(--radius-md);
        color: var(--text-main);
        font-size: 1rem;
        transition: all 0.2s;
    }
    
    .input:focus { 
        border-color: var(--accent); 
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .input::placeholder {
        color: var(--text-muted);
        opacity: 0.6;
    }

    /* Cards am√©lior√©es */
    .card {
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: var(--shadow-lg);
        border-color: var(--border-focus);
    }

    /* Modals */
    .modal {
        position: fixed; 
        inset: 0; 
        z-index: 2000;
        background-color: var(--bg-overlay);
        backdrop-filter: blur(8px);
        display: flex; 
        align-items: center; 
        justify-content: center;
        opacity: 0; 
        pointer-events: none;
        transition: opacity 0.3s;
    }
    
    .modal.active { 
        opacity: 1; 
        pointer-events: auto; 
    }
    
    .modal-content {
        background-color: var(--bg-surface);
        width: 90%; 
        max-width: 520px;
        border-radius: var(--radius-xl);
        border: 1px solid var(--border);
        padding: 2rem;
        transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        max-height: 90vh; 
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
    }
    
    .modal.active .modal-content { 
        transform: scale(1); 
    }

    /* Typography */
    .title-xl { 
        font-size: 2.75rem; 
        font-weight: 900; 
        letter-spacing: -0.05em; 
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, var(--accent), var(--accent-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .title-lg { 
        font-size: 1.75rem; 
        font-weight: 700; 
        letter-spacing: -0.025em; 
        margin-bottom: 1rem; 
    }
    
    .text-muted { 
        color: var(--text-muted); 
        font-size: 0.95rem; 
    }

    /* =========================================
       4. √âCRANS & LAYOUT
       ========================================= */
    .screen {
        display: none;
        flex-direction: column;
        min-height: 100vh;
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
        animation: fadeIn 0.4s ease;
    }
    
    .screen.active { 
        display: flex; 
    }

    @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(15px); } 
        to { opacity: 1; transform: translateY(0); } 
    }

    /* Header Global avec param√®tres et chat int√©gr√©s */
    .app-header {
        position: fixed; 
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        background: rgba(15, 15, 15, 0.8);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        padding: 0.5rem 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .header-logo {
        font-size: 1.1rem;
        font-weight: 800;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .header-right {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    /* Ajuster le padding des screens pour le header */
    .screen {
        padding-top: 3.5rem;
    }

    /* HOME - Layout am√©lior√© */
    #home { 
        align-items: center; 
        justify-content: center; 
        text-align: center; 
    }
    
    .hero-logo { 
        font-size: 6rem; 
        margin-bottom: 1rem; 
        display: inline-block; 
        filter: drop-shadow(0 0 30px rgba(239, 68, 68, 0.5));
    }
    
    [data-power-saving="false"] .hero-logo {
        animation: float 6s ease-in-out infinite; 
    }
    
    @keyframes float { 
        0%, 100% { transform: translateY(0) rotate(0deg); } 
        25% { transform: translateY(-15px) rotate(5deg); }
        50% { transform: translateY(-20px) rotate(0deg); } 
        75% { transform: translateY(-15px) rotate(-5deg); }
    }
    
    /* Menu Grid Revu */
    .menu-grid {
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 1rem;
        width: 100%; 
        max-width: 600px; 
        margin-top: 2.5rem;
    }
    
    .menu-grid-solo {
        grid-column: 1 / -1; /* Full width pour Solo */
    }
    
    .menu-card {
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center;
        padding: 2.5rem 1.5rem; 
        gap: 0.75rem; 
        cursor: pointer;
        text-align: center; 
        height: 100%;
        background: linear-gradient(135deg, var(--bg-surface), var(--bg-app));
        position: relative;
        overflow: hidden;
    }
    
    .menu-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, transparent, rgba(99, 102, 241, 0.1));
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .menu-card:hover::before {
        opacity: 1;
    }
    
    .menu-icon { 
        font-size: 3rem; 
        margin-bottom: 0.5rem; 
        transition: transform 0.3s;
    }
    
    .menu-card:hover .menu-icon {
        transform: scale(1.1);
    }
    
    .menu-card:hover { 
        border-color: var(--accent); 
        transform: translateY(-5px);
    }

    .menu-card h3 {
        font-size: 1.25rem;
        font-weight: 700;
    }

    /* Profile Section am√©lior√©e */
    .profile-setup {
        display: flex; 
        gap: 0.75rem; 
        width: 100%; 
        max-width: 600px; 
        margin: 2.5rem 0;
        padding: 1.5rem;
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
    }
    
    .avatar-btn {
        font-size: 2.25rem; 
        width: 70px; 
        height: 70px; 
        border-radius: var(--radius-md);
        background: var(--bg-app); 
        border: 2px solid var(--border);
        transition: all 0.3s;
        cursor: pointer;
    }
    
    .avatar-btn:hover {
        transform: scale(1.05);
        border-color: var(--accent);
    }
    
    .color-picker-wrap { 
        width: 60px; 
        height: 70px; 
        border-radius: var(--radius-md); 
        overflow: hidden; 
        position: relative; 
        border: 2px solid var(--border);
        cursor: pointer;
    }
    
    input[type="color"] { 
        width: 200%; 
        height: 200%; 
        position: absolute; 
        top: -50%; 
        left: -50%; 
        cursor: pointer; 
        border: none;
    }

    /* LOBBY am√©lior√© */
    .lobby-header { 
        text-align: center; 
        margin-bottom: 2rem; 
    }
    
    .code-display {
        font-family: 'Courier New', monospace; 
        font-size: 4rem; 
        font-weight: 900; 
        letter-spacing: 0.3em;
        color: var(--accent); 
        margin: 1.5rem 0; 
        text-shadow: 0 0 30px rgba(99, 102, 241, 0.5);
        padding: 1rem;
        background: rgba(99, 102, 241, 0.1);
        border-radius: var(--radius-lg);
        border: 2px dashed var(--accent);
    }
    
    .players-grid {
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
        gap: 1rem; 
        margin-bottom: 2rem;
    }
    
    .player-chip {
        background: var(--bg-app); 
        padding: 1.25rem; 
        border-radius: var(--radius-lg);
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: 0.75rem;
        border: 2px solid var(--border); 
        position: relative;
        transition: all 0.3s;
    }
    
    .player-chip:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }
    
    .player-chip.is-host { 
        border-color: var(--accent-warning); 
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
    }
    
    .player-chip.is-me { 
        border-color: var(--accent); 
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent);
    }
    
    .host-crown { 
        position: absolute; 
        top: -12px; 
        right: -12px; 
        font-size: 1.5rem; 
        background: var(--bg-surface); 
        border-radius: 50%; 
        padding: 4px; 
        border: 2px solid var(--accent-warning);
    }

    /* GAME BOARD - Interface am√©lior√©e */
    #game { 
        justify-content: space-between; 
        height: 100vh; 
        overflow: hidden; 
        padding-top: 4rem;
    }
    
    .game-top-bar { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 0.5rem 1rem; 
        background: var(--bg-surface); 
        border-radius: var(--radius-full); 
        margin-bottom: 0.5rem; 
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
    }
    
    .game-stat { 
        display: flex; 
        align-items: center; 
        gap: 0.4rem; 
        padding: 0 0.75rem; 
        font-weight: 700;
        font-size: 0.95rem;
    }
    
    .arena {
        flex: 1; 
        position: relative; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        padding: 1rem 0;
    }
    
    .bomb-container { 
        position: relative; 
        z-index: 10; 
        text-align: center; 
    }
    
    .bomb-emoji { 
        font-size: 3.5rem; 
        display: block; 
        filter: drop-shadow(0 0 15px rgba(239, 68, 68, 0.6)); 
        transition: transform 0.1s;
    }
    
    [data-power-saving="false"] .bomb-emoji.ticking { 
        animation: pulse 0.6s infinite alternate; 
    }
    
    [data-power-saving="false"] .bomb-emoji.critical { 
        animation: shake 0.15s infinite; 
        color: var(--accent-danger); 
        filter: drop-shadow(0 0 30px var(--accent-danger));
    }
    
    @keyframes pulse { 
        from { transform: scale(1); } 
        to { transform: scale(1.15); } 
    }
    
    @keyframes shake { 
        0% { transform: rotate(-8deg) scale(1.05); } 
        50% { transform: rotate(8deg) scale(1.05); } 
        100% { transform: rotate(-8deg) scale(1.05); } 
    }

    .syllable-card {
        margin-top: 1rem; 
        background: linear-gradient(135deg, var(--accent), var(--accent-purple)); 
        padding: 0.5rem 1.5rem;
        border-radius: var(--radius-md); 
        border: 2px solid rgba(255, 255, 255, 0.2);
        font-size: 1.75rem; 
        font-weight: 900; 
        text-transform: uppercase; 
        letter-spacing: 2px;
        color: white;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
    }

    .timer-wrap { 
        width: 100%; 
        max-width: 200px; 
        height: 8px; 
        background: var(--bg-surface); 
        border-radius: 10px; 
        margin: 1rem auto; 
        overflow: hidden;
        border: 2px solid var(--border);
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .timer-bar { 
        height: 100%; 
        background: linear-gradient(90deg, var(--accent-success), var(--accent-warning), var(--accent-danger)); 
        width: 100%; 
        transform-origin: left; 
        transition: width 0.1s linear;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
    }

    /* Players in Circle - Am√©lior√© */
    .player-orbit {
        position: absolute; 
        top: 50%; 
        left: 50%;
        width: min(55vw, 55vh); 
        height: min(55vw, 55vh);
        transform: translate(-50%, -50%); 
        pointer-events: none;
    }
    
    .game-avatar {
        position: absolute; 
        width: 50px; 
        height: 50px;
        transform: translate(-50%, -50%);
        display: flex; 
        flex-direction: column; 
        align-items: center;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .game-avatar-img {
        width: 100%; 
        height: 100%; 
        border-radius: 50%; 
        background: var(--bg-surface);
        border: 2px solid var(--border); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 1.5rem;
        box-shadow: var(--shadow-lg); 
        position: relative; 
        z-index: 2;
        transition: all 0.3s;
    }
    
    .game-avatar.active .game-avatar-img { 
        border-color: var(--accent); 
        box-shadow: 0 0 20px var(--accent), var(--shadow-xl); 
        transform: scale(1.2); 
    }
    
    .game-avatar.eliminated { 
        opacity: 0.3; 
        filter: grayscale(1); 
    }
    
    .lives-dots { 
        display: flex; 
        gap: 2px; 
        margin-top: 3px; 
    }
    
    .life-dot { 
        width: 6px; 
        height: 6px; 
        border-radius: 50%; 
        background: var(--accent-danger);
        box-shadow: 0 0 6px var(--accent-danger);
    }
    
    .player-name-tag {
        background: var(--bg-surface); 
        padding: 1px 6px; 
        border-radius: 4px;
        font-size: 0.65rem; 
        margin-top: 3px; 
        white-space: nowrap; 
        border: 1px solid var(--border);
        font-weight: 600;
    }

    /* Input Zone - Plus visible et ergonomique */
    .input-zone {
        padding: 1rem; 
        background: var(--bg-surface);
        border-top: 2px solid var(--border);
        display: flex; 
        gap: 0.75rem; 
        flex-direction: column;
        border-top-left-radius: var(--radius-lg); 
        border-top-right-radius: var(--radius-lg);
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .big-input { 
        font-size: 1rem; 
        text-align: center; 
        text-transform: uppercase; 
        font-weight: 700; 
        letter-spacing: 1px;
        padding: 0.75rem 1rem;
        border: 2px solid var(--accent);
        background: var(--bg-app);
        box-shadow: 0 0 15px rgba(99, 102, 241, 0.2);
    }
    
    .big-input:focus {
        box-shadow: 0 0 30px rgba(99, 102, 241, 0.4);
        border-color: var(--accent-purple);
    }

    /* CHAT - Int√©gr√© dans header */
    .chat-toggle {
        position: relative;
    }
    
    .chat-badge { 
        position: absolute; 
        top: -5px; 
        right: -5px; 
        background: var(--accent-danger); 
        color: white; 
        border-radius: 50%; 
        width: 20px; 
        height: 20px; 
        font-size: 0.7rem; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        border: 2px solid var(--bg-app);
        font-weight: 700;
    }
    
    .chat-panel {
        position: fixed; 
        top: 60px; 
        right: 1.5rem; 
        width: 360px; 
        height: 480px;
        background: var(--bg-surface); 
        border: 1px solid var(--border); 
        border-radius: var(--radius-lg);
        display: flex; 
        flex-direction: column; 
        z-index: 95;
        box-shadow: var(--shadow-xl); 
        transform: scale(0) translateY(-20px); 
        transform-origin: top right; 
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .chat-panel.active { 
        transform: scale(1) translateY(0); 
    }
    
    .chat-header { 
        padding: 1.25rem; 
        border-bottom: 1px solid var(--border); 
        display: flex; 
        justify-content: space-between; 
        font-weight: 700;
        font-size: 1.1rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), transparent);
    }
    
    .chat-body { 
        flex: 1; 
        overflow-y: auto; 
        padding: 1rem; 
        display: flex; 
        flex-direction: column; 
        gap: 0.75rem; 
    }
    
    .chat-msg { 
        padding: 0.75rem 1rem; 
        border-radius: var(--radius-md); 
        background: var(--bg-app); 
        font-size: 0.95rem; 
        align-self: flex-start; 
        max-width: 85%;
        border: 1px solid var(--border);
    }
    
    .chat-msg.me { 
        align-self: flex-end; 
        background: linear-gradient(135deg, var(--accent), var(--accent-purple)); 
        color: white;
        border-color: transparent;
    }
    
    .chat-msg.sys { 
        align-self: center; 
        background: transparent; 
        font-style: italic; 
        font-size: 0.85rem; 
        color: var(--text-muted);
        border: none;
    }
    
    .chat-footer { 
        padding: 1rem; 
        border-top: 1px solid var(--border); 
        display: flex; 
        gap: 0.75rem; 
    }

    /* NOTIFICATION */
    .toast {
        position: fixed; 
        top: 80px; 
        left: 50%; 
        transform: translateX(-50%) translateY(-120px);
        background: var(--bg-surface); 
        padding: 1rem 2rem; 
        border-radius: var(--radius-full);
        box-shadow: var(--shadow-xl); 
        border: 2px solid var(--border);
        display: flex; 
        align-items: center; 
        gap: 1rem; 
        z-index: 3000;
        transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-weight: 600;
    }
    
    .toast.visible { 
        transform: translateX(-50%) translateY(0); 
    }
    
    .toast.error { 
        border-color: var(--accent-danger); 
        color: var(--accent-danger);
        background: rgba(239, 68, 68, 0.1);
    }
    
    .toast.success { 
        border-color: var(--accent-success); 
        color: var(--accent-success);
        background: rgba(16, 185, 129, 0.1);
    }

    /* SETTINGS dans header */
    .settings-panel {
        position: fixed;
        top: 60px;
        right: 1.5rem;
        width: 340px;
        background: var(--bg-surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        z-index: 95;
        box-shadow: var(--shadow-xl);
        transform: scale(0) translateY(-20px);
        transform-origin: top right;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .settings-panel.active {
        transform: scale(1) translateY(0);
    }
    
    .settings-row { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 1rem 0; 
        border-bottom: 1px solid var(--border); 
    }
    
    .settings-row:last-child {
        border-bottom: none;
    }
    
    .theme-selector { 
        display: flex; 
        background: var(--bg-app); 
        padding: 4px; 
        border-radius: var(--radius-md);
        gap: 4px;
    }
    
    .theme-opt { 
        flex: 1; 
        padding: 6px 12px; 
        border-radius: var(--radius-sm); 
        font-size: 0.85rem; 
        opacity: 0.5;
        transition: all 0.2s;
        font-weight: 600;
    }
    
    .theme-opt.active { 
        background: var(--accent); 
        color: white;
        opacity: 1; 
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        width: 50px;
        height: 28px;
        background: var(--bg-app);
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.3s;
        border: 2px solid var(--border);
    }
    
    .toggle-switch.active {
        background: var(--accent);
        border-color: var(--accent);
    }
    
    .toggle-switch::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: white;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
    }
    
    .toggle-switch.active::after {
        transform: translateX(22px);
    }

    /* Emoji Picker Grid */
    .emoji-grid { 
        display: grid; 
        grid-template-columns: repeat(8, 1fr); 
        gap: 0.5rem; 
        max-height: 300px; 
        overflow-y: auto; 
        margin-top: 1rem;
        padding: 0.5rem;
    }
    
    .emoji-item { 
        font-size: 1.75rem; 
        cursor: pointer; 
        padding: 0.5rem; 
        text-align: center; 
        border-radius: 8px;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    
    .emoji-item:hover { 
        background: var(--bg-surface-hover);
        transform: scale(1.2);
        border-color: var(--accent);
    }

    /* Solo Mode Stats */
    .solo-stats { 
        display: flex; 
        gap: 1.5rem; 
        justify-content: center; 
        margin-bottom: 2rem; 
    }
    
    .stat-box { 
        background: linear-gradient(135deg, var(--bg-surface), var(--bg-app)); 
        padding: 1.5rem; 
        border-radius: var(--radius-lg); 
        min-width: 120px; 
        text-align: center;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
    }
    
    .stat-val { 
        font-size: 2rem; 
        font-weight: 900;
        background: linear-gradient(135deg, var(--accent), var(--accent-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .stat-label { 
        font-size: 0.85rem; 
        color: var(--text-muted); 
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 1px;
    }

    /* Animation shake pour input invalide */
    @keyframes shake-input {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
    
    .shake {
        animation: shake-input 0.3s;
    }

    /* Scrollbar custom */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }
    
    ::-webkit-scrollbar-track {
        background: var(--bg-app);
    }
    
    ::-webkit-scrollbar-thumb {
        background: var(--border-focus);
        border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: var(--accent);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .title-xl { font-size: 1.75rem; }
        .code-display { font-size: 2rem; }
        .bomb-emoji { font-size: 3rem; }
        .syllable-card { font-size: 1.5rem; padding: 0.4rem 1.25rem; }
        .game-avatar { width: 38px; height: 38px; }
        .game-avatar-img { font-size: 1.25rem; border-width: 2px; }
        .player-name-tag { font-size: 0.6rem; padding: 1px 5px; }
        .big-input { font-size: 0.85rem; padding: 0.65rem 0.85rem; }
        .chat-panel, .settings-panel { 
            width: calc(100% - 2rem); 
            right: 1rem; 
        }
        .emoji-grid { grid-template-columns: repeat(6, 1fr); }
        .player-orbit { width: min(60vw, 60vh); height: min(60vw, 60vh); }
        .header-logo { font-size: 1rem; }
        .app-header { padding: 0.4rem 0.75rem; }
        .game-top-bar { padding: 0.4rem 0.75rem; margin-bottom: 0.4rem; }
        .game-stat { font-size: 0.85rem; gap: 0.3rem; padding: 0 0.5rem; }
        .timer-wrap { max-width: 150px; height: 6px; }
        .input-zone { padding: 0.75rem; gap: 0.5rem; }
        .btn-icon { width: 32px; height: 32px; font-size: 0.9rem; }
    }

    </style>
</head>
<body>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastIcon">‚ÑπÔ∏è</span>
        <span id="toastMsg">Message</span>
    </div>

    <!-- Header Global -->
    <div class="app-header">
        <div class="header-left">
            <div class="header-logo">
                üí£ <span>Tic Tac Boom</span>
            </div>
        </div>
        <div class="header-right">
            <button class="btn btn-icon chat-toggle" id="toggleChatBtn" title="Discussion">
                üí¨
                <span class="chat-badge hidden" id="chatUnread">0</span>
            </button>
            <button class="btn btn-icon" id="openSettingsBtn" title="Param√®tres">‚öôÔ∏è</button>
        </div>
    </div>

    <!-- Settings Panel (dans header) -->
    <div class="settings-panel" id="settingsPanel">
        <h3 class="title-lg" style="margin-bottom: 1.5rem;">Param√®tres</h3>
        
        <div class="settings-row">
            <span>Apparence</span>
            <div class="theme-selector">
                <button class="theme-opt" data-theme="light">‚òÄÔ∏è</button>
                <button class="theme-opt" data-theme="auto">üåó</button>
                <button class="theme-opt" data-theme="dark">üåô</button>
            </div>
        </div>

        <div class="settings-row">
            <span>Effets sonores</span>
            <div class="toggle-switch" id="soundToggle">
            </div>
        </div>

        <div class="settings-row">
            <span>√âconomie d'√©nergie</span>
            <div class="toggle-switch" id="powerSavingToggle">
            </div>
        </div>
    </div>

    <!-- Chat Panel (dans header) -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <span>üí¨ Discussion</span>
            <button style="font-size: 1.5rem; opacity: 0.6; transition: opacity 0.2s;" id="closeChatBtn">√ó</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-msg sys">Bienvenue dans le chat ! üëã</div>
        </div>
        <div class="chat-footer">
            <input type="text" id="chatInput" class="input" placeholder="Message..." style="padding: 0.75rem; font-size: 0.9rem;">
            <button class="btn btn-primary" id="chatSendBtn" style="padding: 0.75rem 1.25rem;">‚û§</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <h2 class="title-lg">‚öôÔ∏è Configurer la partie</h2>
            
            <div class="input-group" style="margin-bottom: 1.25rem;">
                <label class="text-muted" style="display: block; margin-bottom: 0.5rem;">‚ù§Ô∏è Vies par joueur</label>
                <input type="number" id="configLives" class="input" value="3" min="1" max="10">
            </div>

            <div class="input-group" style="margin-bottom: 1.25rem;">
                <label class="text-muted" style="display: block; margin-bottom: 0.5rem;">‚è±Ô∏è Temps initial (sec)</label>
                <input type="number" id="configTime" class="input" value="15" min="5" max="60">
            </div>

            <div class="input-group" style="margin-bottom: 2rem;">
                <label class="text-muted" style="display: block; margin-bottom: 0.5rem;">üéØ Difficult√© syllabe</label>
                <select id="configDiff" class="input" style="cursor: pointer;">
                    <option value="2">Facile (2 lettres)</option>
                    <option value="3">Moyen (3 lettres)</option>
                </select>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.75rem;" id="confirmCreateBtn">‚ú® Cr√©er le Salon</button>
            <button class="btn" style="width: 100%;" id="cancelCreateBtn">Annuler</button>
        </div>
    </div>

    <div id="joinModal" class="modal">
        <div class="modal-content">
            <h2 class="title-lg">üöÄ Rejoindre une partie</h2>
            <p class="text-muted" style="margin-bottom: 1.5rem;">Entre le code √† 6 chiffres de l'h√¥te.</p>
            
            <input type="text" id="joinCodeInput" class="input big-input" placeholder="000000" maxlength="6" style="margin-bottom: 2rem;">
            
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.75rem;" id="confirmJoinBtn">üéÆ Entrer dans la partie</button>
            <button class="btn" style="width: 100%;" id="cancelJoinBtn">Annuler</button>
        </div>
    </div>

    <div id="emojiModal" class="modal">
        <div class="modal-content">
            <h2 class="title-lg">üé≠ Choisis ton avatar</h2>
            <div class="emoji-grid" id="emojiGrid"></div>
            <button class="btn" style="width: 100%; margin-top: 1.5rem;" id="closeEmojiBtn">Fermer</button>
        </div>
    </div>

    <div id="rulesModal" class="modal">
        <div class="modal-content">
            <h2 class="title-lg">üìú R√®gles du jeu</h2>
            <div style="line-height: 1.8; color: var(--text-muted);">
                <p style="margin-bottom: 1rem;"><strong>üéØ Objectif :</strong> Trouver un mot contenant la syllabe affich√©e avant que la bombe n'explose !</p>
                
                <p style="margin-bottom: 1rem;"><strong>üéÆ D√©roulement :</strong></p>
                <ol style="margin-left: 1.5rem; margin-bottom: 1rem;">
                    <li>Une syllabe appara√Æt (ex: BA)</li>
                    <li>Trouve rapidement un mot qui la contient (ex: BATEAU)</li>
                    <li>Valide ton mot avant la fin du timer</li>
                    <li>La bombe passe au joueur suivant</li>
                </ol>
                
                <p style="margin-bottom: 1rem;"><strong>üí• Attention :</strong> Si le temps expire, tu perds une vie !</p>
                
                <p style="margin-bottom: 1rem;"><strong>üèÜ Victoire :</strong> Le dernier joueur avec des vies gagne la partie !</p>
                
                <p style="margin-bottom: 1rem;"><strong>üí° Astuce :</strong> Le temps diminue √† chaque tour pour plus d'intensit√© !</p>
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" id="closeRulesBtn">Compris !</button>
        </div>
    </div>

    <!-- HOME SCREEN -->
    <div id="home" class="screen active">
        <div class="hero-logo">üí£</div>
        <h1 class="title-xl">Tic Tac Boom</h1>
        <p class="text-muted" style="font-size: 1.1rem;">Trouve le mot avant que √ßa p√®te ! üí•</p>

        <div class="profile-setup">
            <button class="avatar-btn" id="avatarBtn">üòé</button>
            <div class="input-group" style="flex: 1;">
                <input type="text" id="usernameInput" class="input" placeholder="Ton Pseudo" maxlength="12">
            </div>
            <div class="color-picker-wrap" title="Couleur de ton avatar">
                <input type="color" id="colorInput" value="#6366f1">
            </div>
        </div>

        <div class="menu-grid">
            <div class="card menu-card" id="btnCreate">
                <div class="menu-icon">üëë</div>
                <h3>Cr√©er</h3>
                <span class="text-muted">H√©berger une partie</span>
            </div>
            <div class="card menu-card" id="btnJoin">
                <div class="menu-icon">üöÄ</div>
                <h3>Rejoindre</h3>
                <span class="text-muted">Via code √† 6 chiffres</span>
            </div>
            <div class="card menu-card menu-grid-solo" id="btnSolo">
                <div class="menu-icon">üßò</div>
                <h3>Mode Solo</h3>
                <span class="text-muted">Entra√Ænement et am√©lioration</span>
            </div>
        </div>

        <button class="btn" style="margin-top: 2rem;" id="btnRules">
            üìú Comment jouer ?
        </button>
    </div>

    <!-- LOBBY SCREEN -->
    <div id="lobby" class="screen">
        <div class="lobby-header">
            <h2 class="title-lg">üéÆ Salon d'attente</h2>
            <p class="text-muted">Partage ce code avec tes amis pour qu'ils te rejoignent</p>
            <div class="code-display" id="lobbyCodeDisplay">------</div>
            <button class="btn" id="copyCodeBtn">üìã Copier le code</button>
        </div>

        <div class="card" style="flex: 1; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; align-items: center;">
                <h3>üë• Joueurs connect√©s</h3>
                <span id="playerCountBadge" class="text-muted" style="font-weight: 700; font-size: 1.1rem;">1/30</span>
            </div>
            
            <div class="players-grid" id="lobbyPlayersGrid"></div>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
            <button class="btn btn-danger" style="flex: 1" id="leaveLobbyBtn">‚ùå Quitter</button>
            <button class="btn btn-success" style="flex: 2" id="startGameBtn" disabled>üéÆ Lancer la partie</button>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game" class="screen">
        <div class="game-top-bar">
            <button class="btn-icon" style="width: 32px; height: 32px; font-size: 0.9rem;" id="quitGameBtn" title="Quitter">‚ùå</button>
            <div class="game-stat">üé≤ <span id="gameRoundInfo">Tour 1</span></div>
            <div class="game-stat">üë• <span id="gameAliveCount">0</span></div>
        </div>

        <div class="arena" id="gameArena">
            <div class="bomb-container">
                <div class="bomb-emoji" id="bombEmoji">üí£</div>
                <div class="syllable-card" id="syllableDisplay">???</div>
                <div class="timer-wrap">
                    <div class="timer-bar" id="timerBar"></div>
                </div>
                <div id="gameStatusText" class="text-muted" style="margin-top: 0.75rem; font-weight: bold; font-size: 0.85rem;">En attente...</div>
            </div>

            <div class="player-orbit" id="playersOrbit"></div>
        </div>

        <div class="input-zone" id="inputZone">
            <div style="display: flex; gap: 1rem;">
                <input type="text" id="gameInput" class="input big-input" placeholder="TAPEZ VOTRE MOT..." autocomplete="off">
                <button class="btn btn-success" id="submitWordBtn" style="padding: 0.75rem 1.25rem; font-size: 0.9rem;">‚úì OK</button>
            </div>
        </div>
    </div>

    <!-- SOLO SCREEN -->
    <div id="solo" class="screen">
        <div class="lobby-header">
            <h2 class="title-lg">üßò Mode Solo</h2>
            <p class="text-muted">Entra√Æne-toi et am√©liore ton score !</p>
            <div class="solo-stats">
                <div class="stat-box">
                    <div class="stat-val" id="soloScore">0</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="stat-box">
                    <div class="stat-val" id="soloStreak">0</div>
                    <div class="stat-label">S√©rie</div>
                </div>
            </div>
        </div>

        <div class="arena">
            <div class="bomb-container">
                <div class="syllable-card" id="soloSyllable">...</div>
                <div class="timer-wrap">
                    <div class="timer-bar" id="soloTimerBar"></div>
                </div>
            </div>
        </div>

        <div class="input-zone">
            <div style="display: flex; gap: 1rem;">
                <input type="text" id="soloInput" class="input big-input" placeholder="TON MOT...">
                <button class="btn btn-success" id="soloSubmitBtn" style="padding: 0.75rem 1.25rem; font-size: 0.9rem;">‚úì GO</button>
            </div>
            <button class="btn btn-danger" style="width: 100%;" id="quitSoloBtn">‚ùå Arr√™ter</button>
        </div>
    </div>

    <script>
    /* =========================================
       LOGIQUE JAVASCRIPT PROFESSIONNELLE
       ========================================= */

    // ============================================
    // 1. GESTION DU TH√àME ET PARAM√àTRES
    // ============================================
    const themeManager = {
        init() {
            const saved = localStorage.getItem('theme') || 'dark';
            this.setTheme(saved);
            
            // √âcouteurs pour les boutons
            document.querySelectorAll('.theme-opt').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.setTheme(btn.dataset.theme);
                });
            });

            // √âcouteur syst√®me pour mode auto
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                if (localStorage.getItem('theme') === 'auto') {
                    this.applyToDOM('auto');
                }
            });
        },
        
        setTheme(mode) {
            localStorage.setItem('theme', mode);
            this.updateUI(mode);
            this.applyToDOM(mode);
        },
        
        updateUI(mode) {
            document.querySelectorAll('.theme-opt').forEach(b => {
                b.classList.toggle('active', b.dataset.theme === mode);
            });
        },
        
        applyToDOM(mode) {
            let effective = mode;
            if (mode === 'auto') {
                effective = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            document.documentElement.setAttribute('data-theme', effective);
        }
    };

    // ============================================
    // 2. MODE √âCONOMIE D'√âNERGIE
    // ============================================
    const powerSavingManager = {
        init() {
            const saved = localStorage.getItem('powerSaving') === 'true';
            this.setPowerSaving(saved);
            
            const toggle = document.getElementById('powerSavingToggle');
            toggle.classList.toggle('active', saved);
            toggle.addEventListener('click', () => {
                const newState = !toggle.classList.contains('active');
                this.setPowerSaving(newState);
                toggle.classList.toggle('active', newState);
            });
        },
        
        setPowerSaving(enabled) {
            localStorage.setItem('powerSaving', enabled);
            document.documentElement.setAttribute('data-power-saving', enabled);
            
            // Ajuster la fr√©quence des updates si n√©cessaire
            if (enabled && State.gameLoop) {
                // Ralentir les updates (d√©j√† g√©r√© par CSS pour animations)
                console.log('Mode √©conomie d\'√©nergie activ√©');
            }
        },
        
        isEnabled() {
            return localStorage.getItem('powerSaving') === 'true';
        }
    };

    // ============================================
    // 3. GESTION DES SONS
    // ============================================
    const soundManager = {
        enabled: true,
        
        init() {
            const saved = localStorage.getItem('soundEnabled');
            this.enabled = saved === null ? true : saved === 'true';
            
            const toggle = document.getElementById('soundToggle');
            toggle.classList.toggle('active', this.enabled);
            toggle.addEventListener('click', () => {
                this.enabled = !this.enabled;
                localStorage.setItem('soundEnabled', this.enabled);
                toggle.classList.toggle('active', this.enabled);
            });
        },
        
        playConfetti() {
            if (this.enabled && !powerSavingManager.isEnabled()) {
                confetti({ 
                    particleCount: 100, 
                    spread: 70,
                    origin: { y: 0.6 }
                });
            }
        }
    };

    // ============================================
    // 4. DICTIONNAIRE & SYLLABES
    // ============================================
    const Syllables = {
        easy: ['BA','CA','DA','FA','GA','LA','MA','NA','PA','RA','SA','TA','VA','MI','TI','LI','RI','SI','BO','CO','DO','FO','GO','LO','MO','NO','PO','RO','SO','TO','VO','BU','CU','DU','FU','GU','LU','MU','NU','PU','RU','SU','TU','VU'],
        hard: ['BRA','CRA','DRA','FRA','GRA','PLA','TRA','VRA','BLE','CLE','FLE','GLE','PLE','TRE','PRE','BRI','CRI','DRI','FRI','GRI','PRI','TRI','VRI','CHE','CHI','CHO','CHU','CHA']
    };
    
    // Dictionnaire offline pour le mode solo UNIQUEMENT
    const OfflineDictionary = new Set([
        'MAISON','ARBRE','TABLE','CHAISE','CHIEN','CHAT','LIVRE','ECOLE','VOITURE','FLEUR',
        'SOLEIL','LUNE','MER','MONTAGNE','RIVIERE','ROUTE','VILLE','PAYS','MONDE','TEMPS',
        'HOMME','FEMME','ENFANT','AMOUR','JOIE','PEUR','ROUGE','BLEU','VERT','JAUNE',
        'PETIT','GRAND','BEAU','FORT','VITE','LENT','MANGER','BOIRE','DORMIR','COURIR',
        'MARCHER','PARLER','ECOUTER','REGARDER','JOUER','TRAVAILLER','BATEAU','AVION','TRAIN',
        'VELO','MOTO','POMME','POIRE','BANANE','ORANGE','FRAISE','PAIN','LAIT','EAU',
        'VIN','BIERE','CAFE','THE','SUCRE','SEL','POIVRE','VIANDE','POISSON','OEUF',
        'FROMAGE','YAOURT','GLACE','GATEAU','CHOCOLAT','BONBON','FRUIT','LEGUME','SALADE',
        'TOMATE','CAROTTE','PATATE','FEU','AIR','TERRE','METAL','BOIS','PIERRE','SABLE',
        'VERRE','PAPIER','STYLO','CRAYON','GOMME','CAHIER','SAC','VETEMENT','CHEMISE',
        'PANTALON','ROBE','JUPE','CHAUSSURE','CHAPEAU','LUNETTES','MONTRE','BIJOU','ARGENT',
        'OR','PORTE','FENETRE','MUR','TOIT','SOL','PLAFOND','ESCALIER','ASCENSEUR','JARDIN',
        'PARC','FORET','CHAMP','FERME','ANIMAL','OISEAU','POULE','VACHE','COCHON','CHEVAL',
        'MOUTON','LAPIN','SOURIS','SERPENT','LION','TIGRE','ELEPHANT','GIRAFE','SINGE',
        'OURS','LOUP','RENARD','AIGLE','REQUIN','BALEINE','DAUPHIN','ABEILLE','FOURMI',
        'PAPILLON','ARAIGNEE','MOUCHE','MOUSTIQUE','BUREAU','ORDINATEUR','TELEPHONE','MUSIQUE',
        'RADIO','TELEVISION','CINEMA','THEATRE','SPORT','FOOTBALL','TENNIS','BASKETBALL',
        'NATATION','COURSE','DANSE','CHANSON','PEINTURE','DESSIN','PHOTO','VIDEO','HISTOIRE',
        'GEOGRAPHIE','MATHEMATIQUE','SCIENCE','FRANCAIS','ANGLAIS','ESPAGNOL','ITALIEN',
        'ALLEMAND','CHINOIS','JAPONAIS','RUSSE','ARABE','PORTUGAIS','GREC','TURC','SUEDOIS'
    ]);

    /**
     * R√©cup√®re une syllabe al√©atoire selon la difficult√©
     */
    function getSyllable(difficulty) {
        const list = difficulty === 3 ? Syllables.hard : Syllables.easy;
        return list[Math.floor(Math.random() * list.length)];
    }

    /**
     * Validation des mots - VERSION AM√âLIOR√âE
     * Pour le mode multijoueur : utilise une API dictionnaire
     * Pour le mode solo : utilise le dictionnaire offline
     */
    async function isValidWord(word, syllable, usedWords, isSoloMode = false) {
        const w = word.toUpperCase().trim();
        const syl = syllable.toUpperCase();
        
        // V√©rifications de base
        if (w.length < 2) return { ok: false, msg: "Trop court" };
        if (!w.includes(syl)) return { ok: false, msg: `Doit contenir ${syl}` };
        if (usedWords.includes(w)) return { ok: false, msg: "D√©j√† utilis√©" };
        
        // Mode Solo : dictionnaire offline UNIQUEMENT
        if (isSoloMode) {
            const exists = OfflineDictionary.has(w);
            return exists ? { ok: true } : { ok: false, msg: "Mot inconnu" };
        }
        
        // Mode Multijoueur : utilisation de l'API dictionnaire
        try {
            const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/fr/${w.toLowerCase()}`);
            
            if (response.ok) {
                return { ok: true };
            } else {
                // Si l'API ne trouve pas le mot, on accepte quand m√™me pour ne pas bloquer le jeu
                // (probl√®me de r√©seau, mot valide mais pas dans l'API, etc.)
                console.warn(`API dictionnaire: mot "${w}" non trouv√©, accept√© par d√©faut`);
                return { ok: true };
            }
        } catch (error) {
            // En cas d'erreur r√©seau, on accepte le mot pour ne pas p√©naliser
            console.error('Erreur API dictionnaire:', error);
            return { ok: true };
        }
    }

    // ============================================
    // 5. √âTAT GLOBAL (STORE)
    // ============================================
    const State = {
        me: {
            id: null,
            name: 'Joueur',
            avatar: 'üòé',
            color: '#6366f1'
        },
        peer: null,
        connections: [], // Pour l'h√¥te
        hostConn: null,  // Pour le client
        
        isHost: false,
        gameCode: null,
        
        game: {
            status: 'LOBBY', // LOBBY, PLAYING, ENDED
            players: [],     // {id, name, avatar, color, lives, isHost}
            currentTurnIndex: 0,
            syllable: '',
            timer: 15,
            maxTimer: 15,
            usedWords: [],
            settings: { lives: 3, time: 15, diff: 2 }
        },

        solo: {
            active: false,
            score: 0,
            streak: 0,
            timerObj: null,
            currentSyl: ''
        },

        gameLoop: null,
        pingInterval: null
    };

    // ============================================
    // 6. NAVIGATION & UI
    // ============================================
    
    /**
     * Affiche un √©cran et cache les autres
     */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    /**
     * Affiche une notification toast
     */
    function showToast(msg, type = 'info') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        const text = document.getElementById('toastMsg');
        
        toast.className = `toast ${type}`;
        icon.textContent = type === 'error' ? '‚ö†Ô∏è' : (type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è');
        text.textContent = msg;
        
        toast.classList.add('visible');
        setTimeout(() => toast.classList.remove('visible'), 3500);
    }

    // ============================================
    // 7. R√âSEAU (PEERJS) - MULTIJOUEUR
    // ============================================
    
    /**
     * G√©n√®re un code de salon √† 6 chiffres
     */
    function generateRoomCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }

    /**
     * Devenir h√¥te et cr√©er un salon
     */
    async function becomeHost(config) {
        State.isHost = true;
        State.game.settings = config;
        State.gameCode = generateRoomCode();
        
        // D√©truire l'ancien peer si existant
        if(State.peer) State.peer.destroy();

        const hostId = `ttb-pro-${State.gameCode}`;
        
        State.peer = new Peer(hostId);
        
        State.peer.on('open', () => {
            State.me.id = hostId;
            State.game.players = [{...State.me, lives: config.lives, isHost: true}];
            State.game.status = 'LOBBY';
            updateLobbyUI();
            showScreen('lobby');
            showToast(`Partie cr√©√©e ! Code: ${State.gameCode}`, 'success');
        });

        State.peer.on('error', (err) => {
            if(err.type === 'unavailable-id') {
                // Code d√©j√† pris, on r√©essaie
                becomeHost(config);
            } else {
                console.error('Erreur peer:', err);
                showToast("Erreur cr√©ation salon", 'error');
            }
        });

        State.peer.on('connection', (conn) => {
            handleIncomingConnection(conn);
        });
    }

    /**
     * Rejoindre une partie existante
     */
    async function joinGame(code) {
        State.isHost = false;
        if(State.peer) State.peer.destroy();
        
        // Cr√©er un peer al√©atoire
        State.peer = new Peer();
        
        State.peer.on('open', (myId) => {
            State.me.id = myId;
            const targetHostId = `ttb-pro-${code}`;
            
            showToast("Connexion √† l'h√¥te...", 'info');
            
            const conn = State.peer.connect(targetHostId, {
                metadata: { player: State.me }
            });

            conn.on('open', () => {
                State.hostConn = conn;
                showToast("Connect√© !", 'success');
                setupClientConnection(conn);
            });

            conn.on('close', () => {
                showToast("D√©connect√© de l'h√¥te", 'error');
                showScreen('home');
            });
            
            // Timeout si l'h√¥te n'existe pas
            setTimeout(() => {
                if(!State.hostConn) {
                    showToast("Partie introuvable", 'error');
                }
            }, 5000);
        });
    }

    /**
     * G√©rer une connexion entrante (c√¥t√© h√¥te)
     */
    function handleIncomingConnection(conn) {
        conn.on('open', () => {
            const newPlayer = {
                ...conn.metadata.player,
                id: conn.peer,
                lives: State.game.settings.lives,
                isHost: false
            };

            // V√©rifier si d√©j√† pr√©sent
            if(!State.game.players.find(p => p.id === newPlayer.id)) {
                State.game.players.push(newPlayer);
                State.connections.push(conn);
                
                // Envoyer l'√©tat complet au nouveau
                conn.send({ type: 'SYNC', state: State.game });
                
                // Diffuser √† tous
                broadcastState();
                
                conn.on('data', (data) => handleDataHost(data, conn));
                conn.on('close', () => {
                    State.game.players = State.game.players.filter(p => p.id !== conn.peer);
                    State.connections = State.connections.filter(c => c !== conn);
                    broadcastState();
                    updateLobbyUI();
                });

                updateLobbyUI();
                
                // Notification chat
                broadcastChat(`${newPlayer.name} a rejoint ! üëã`, null, true);
            }
        });
    }

    /**
     * Configurer la connexion (c√¥t√© client)
     */
    function setupClientConnection(conn) {
        conn.on('data', (data) => {
            if(data.type === 'SYNC') {
                State.game = data.state;
                
                // Routage d'√©cran
                if(State.game.status === 'LOBBY') {
                    if(!document.getElementById('lobby').classList.contains('active')) {
                        showScreen('lobby');
                    }
                    updateLobbyUI();
                } else if (State.game.status === 'PLAYING') {
                    if(!document.getElementById('game').classList.contains('active')) {
                        showScreen('game');
                    }
                    updateGameUI();
                }
            } else if (data.type === 'CHAT') {
                addChatMessage(data.msg, data.author, data.isSystem);
            } else if (data.type === 'TOAST') {
                showToast(data.msg, data.kind);
            }
        });
    }

    /**
     * Diffuser l'√©tat √† tous les clients
     */
    function broadcastState() {
        const msg = { type: 'SYNC', state: State.game };
        State.connections.forEach(c => {
            try {
                c.send(msg);
            } catch(e) {
                console.error('Erreur envoi:', e);
            }
        });
        
        // Update local UI pour l'h√¥te
        if(State.game.status === 'LOBBY') {
            updateLobbyUI();
        } else {
            updateGameUI();
        }
    }

    /**
     * G√©rer les donn√©es re√ßues (c√¥t√© h√¥te)
     */
    function handleDataHost(data, conn) {
        if(data.type === 'START_REQ') {
            startGameLoop();
        }
        else if(data.type === 'WORD_SUBMIT') {
            processWordAttempt(data.word, data.playerId);
        }
        else if (data.type === 'CHAT') {
            // Relayer √† tout le monde
            State.connections.forEach(c => {
                try {
                    c.send(data);
                } catch(e) {
                    console.error('Erreur relai chat:', e);
                }
            });
            addChatMessage(data.msg, data.author, data.isSystem);
        }
    }

    // ============================================
    // 8. LOGIQUE DE JEU (H√îTE)
    // ============================================

    /**
     * D√©marrer la partie
     */
    function startGameLoop() {
        State.game.status = 'PLAYING';
        State.game.currentTurnIndex = 0;
        State.game.usedWords = [];
        
        // Reset lives
        State.game.players.forEach(p => p.lives = State.game.settings.lives);

        broadcastState();
        showScreen('game');
        
        setTimeout(() => startRound(), 1000);
    }

    /**
     * D√©marrer un tour
     */
    function startRound() {
        State.game.syllable = getSyllable(State.game.settings.diff);
        State.game.timer = State.game.settings.time;
        State.game.maxTimer = State.game.settings.time;
        
        broadcastState();
        
        if(State.gameLoop) clearInterval(State.gameLoop);
        
        // Adapter la fr√©quence selon √©conomie d'√©nergie
        const updateInterval = powerSavingManager.isEnabled() ? 200 : 100;
        
        State.gameLoop = setInterval(() => {
            State.game.timer -= (updateInterval / 1000);
            
            if(State.game.timer <= 0) {
                handleExplosion();
            } else {
                // Update UI local
                updateGameUI();
                
                // Broadcast p√©riodique (pas √† chaque frame)
                if(Math.floor(State.game.timer * 10) % 10 === 0) {
                    broadcastState();
                }
            }
        }, updateInterval);
    }

    /**
     * G√©rer l'explosion de la bombe
     */
    function handleExplosion() {
        clearInterval(State.gameLoop);
        const loser = State.game.players[State.game.currentTurnIndex];
        loser.lives -= 1;
        
        // Effets
        const msg = { type: 'TOAST', msg: `üí• BOUM ! ${loser.name} perd une vie !`, kind: 'error' };
        State.connections.forEach(c => {
            try {
                c.send(msg);
            } catch(e) {}
        });
        showToast(msg.msg, 'error');
        
        // V√©rifier victoire
        const alive = State.game.players.filter(p => p.lives > 0);
        if(alive.length <= 1 && State.game.players.length > 1) {
            endGame(alive[0]);
            return;
        }

        // Passer au suivant
        nextTurn();
        setTimeout(() => startRound(), 2500);
    }

    /**
     * Passer au tour suivant
     */
    function nextTurn() {
        let attempts = 0;
        do {
            State.game.currentTurnIndex = (State.game.currentTurnIndex + 1) % State.game.players.length;
            attempts++;
        } while (State.game.players[State.game.currentTurnIndex].lives <= 0 && attempts < State.game.players.length);
        
        broadcastState();
    }

    /**
     * Traiter une tentative de mot
     */
    async function processWordAttempt(word, playerId) {
        const currentP = State.game.players[State.game.currentTurnIndex];
        if(currentP.id !== playerId) return;

        const check = await isValidWord(word, State.game.syllable, State.game.usedWords, false);
        
        if(check.ok) {
            State.game.usedWords.push(word.toUpperCase());
            
            // R√©duire le temps progressivement
            if(State.game.settings.time > 5) {
                State.game.settings.time = Math.max(5, State.game.settings.time * 0.95);
            }
            
            clearInterval(State.gameLoop);
            nextTurn();
            
            // Broadcast succ√®s
            const msg = { type: 'TOAST', msg: `‚úÖ ${currentP.name} a trouv√© "${word.toUpperCase()}" !`, kind: 'success' };
            State.connections.forEach(c => {
                try {
                    c.send(msg);
                } catch(e) {}
            });
            showToast(msg.msg, 'success');
            
            setTimeout(() => startRound(), 1500);
        } else {
            // Notifier l'erreur
            const msg = { type: 'TOAST', msg: `‚ùå ${check.msg}`, kind: 'error' };
            
            if(playerId === State.me.id) {
                showToast(msg.msg, 'error');
            } else {
                const conn = State.connections.find(c => c.peer === playerId);
                if(conn) {
                    try {
                        conn.send(msg);
                    } catch(e) {}
                }
            }
        }
    }

    /**
     * Terminer la partie
     */
    function endGame(winner) {
        State.game.status = 'ENDED';
        broadcastState();
        
        if(!powerSavingManager.isEnabled()) {
            soundManager.playConfetti();
        }
        
        showToast(`üèÜ Victoire de ${winner ? winner.name : 'Personne'} !`, 'success');
        
        // Retour au lobby apr√®s 5 secondes
        setTimeout(() => {
            State.game.status = 'LOBBY';
            State.game.usedWords = [];
            State.game.players.forEach(p => p.lives = State.game.settings.lives);
            broadcastState();
        }, 5000);
    }

    // ============================================
    // 9. MISES √Ä JOUR UI
    // ============================================

    /**
     * Mise √† jour de l'UI du lobby
     */
    function updateLobbyUI() {
        document.getElementById('lobbyCodeDisplay').textContent = State.gameCode || '---';
        document.getElementById('playerCountBadge').textContent = `${State.game.players.length}/30`;
        
        const grid = document.getElementById('lobbyPlayersGrid');
        grid.innerHTML = '';
        
        State.game.players.forEach(p => {
            const div = document.createElement('div');
            div.className = `player-chip ${p.isHost ? 'is-host' : ''} ${p.id === State.me.id ? 'is-me' : ''}`;
            div.innerHTML = `
                <div class="avatar-btn" style="font-size: 2rem; background: ${p.color}20; border-color: ${p.color}; width: 60px; height: 60px;">${p.avatar}</div>
                <span style="font-weight:700; font-size:1rem;">${p.name}</span>
                ${p.isHost ? '<span class="host-crown">üëë</span>' : ''}
            `;
            grid.appendChild(div);
        });

        // Bouton start
        const startBtn = document.getElementById('startGameBtn');
        if(State.isHost && State.game.players.length >= 2) {
            startBtn.disabled = false;
            startBtn.textContent = "üéÆ Lancer la partie";
        } else if (State.isHost) {
            startBtn.disabled = true;
            startBtn.textContent = "‚è≥ Attente de joueurs...";
        } else {
            startBtn.disabled = true;
            startBtn.textContent = "‚è≥ En attente de l'h√¥te...";
        }
    }

    /**
     * Mise √† jour de l'UI du jeu
     */
    function updateGameUI() {
        const g = State.game;
        
        // Stats
        const activeCount = g.players.filter(p => p.lives > 0).length;
        document.getElementById('gameAliveCount').textContent = activeCount;
        
        // Bombe & Syllabe
        document.getElementById('syllableDisplay').textContent = g.syllable;
        const bomb = document.getElementById('bombEmoji');
        bomb.className = `bomb-emoji ${g.timer < 5 ? 'critical' : (g.status === 'PLAYING' ? 'ticking' : '')}`;
        
        // Timer
        const pct = Math.max(0, (g.timer / g.maxTimer) * 100);
        document.getElementById('timerBar').style.width = `${pct}%`;

        // Status Text
        const currentPlayer = g.players[g.currentTurnIndex];
        const statusTxt = document.getElementById('gameStatusText');
        
        if(g.status === 'ENDED') {
            statusTxt.textContent = "üèÅ PARTIE TERMIN√âE";
            document.getElementById('inputZone').style.display = 'none';
        } else if(currentPlayer) {
            const isMe = currentPlayer.id === State.me.id;
            statusTxt.textContent = isMe ? "üéØ √Ä TOI DE JOUER !" : `‚è≥ Au tour de ${currentPlayer.name}`;
            statusTxt.style.color = isMe ? 'var(--accent-success)' : 'var(--text-muted)';
            
            // Input Zone
            const inputZone = document.getElementById('inputZone');
            inputZone.style.display = 'flex';
            if(isMe) {
                document.getElementById('gameInput').focus();
            }
        }

        // Orbit
        renderOrbit(g.players, g.currentTurnIndex);
    }

    /**
     * Afficher les joueurs en cercle autour de la bombe
     */
    function renderOrbit(players, currentIndex) {
        const container = document.getElementById('playersOrbit');
        container.innerHTML = '';
        
        const radius = container.offsetWidth / 2;
        const total = players.length;
        const angleStep = (2 * Math.PI) / total;
        
        // Offset pour mettre le joueur actuel en bas
        const offset = (Math.PI / 2) - (currentIndex * angleStep);

        players.forEach((p, i) => {
            const angle = (i * angleStep) + offset;
            const x = 50 + 40 * Math.cos(angle);
            const y = 50 + 40 * Math.sin(angle);
            
            const el = document.createElement('div');
            el.className = `game-avatar ${i === currentIndex ? 'active' : ''} ${p.lives <= 0 ? 'eliminated' : ''}`;
            el.style.left = `${x}%`;
            el.style.top = `${y}%`;
            
            let livesHtml = '';
            for(let l = 0; l < p.lives; l++) {
                livesHtml += '<div class="life-dot"></div>';
            }
            
            el.innerHTML = `
                <div class="game-avatar-img" style="border-color: ${p.color}; background: ${p.color}10;">
                    ${p.avatar}
                </div>
                <div class="lives-dots">${livesHtml}</div>
                <div class="player-name-tag">${p.name}</div>
            `;
            container.appendChild(el);
        });
    }

    // ============================================
    // 10. SYST√àME DE CHAT
    // ============================================
    
    /**
     * Envoyer un message dans le chat
     */
    function sendChat() {
        const input = document.getElementById('chatInput');
        const msg = input.value.trim();
        if(!msg) return;
        
        const packet = { type: 'CHAT', msg: msg, author: State.me, isSystem: false };
        
        if(State.isHost) {
            State.connections.forEach(c => {
                try {
                    c.send(packet);
                } catch(e) {}
            });
            addChatMessage(msg, State.me, false);
        } else if (State.hostConn) {
            try {
                State.hostConn.send(packet);
                addChatMessage(msg, State.me, false);
            } catch(e) {
                showToast('Erreur envoi message', 'error');
            }
        }
        
        input.value = '';
    }

    /**
     * Diffuser un message syst√®me
     */
    function broadcastChat(msg, author = null, isSystem = true) {
        const packet = { type: 'CHAT', msg: msg, author: author, isSystem: isSystem };
        
        if(State.isHost) {
            State.connections.forEach(c => {
                try {
                    c.send(packet);
                } catch(e) {}
            });
        }
        
        addChatMessage(msg, author, isSystem);
    }

    /**
     * Ajouter un message au chat
     */
    function addChatMessage(msg, author, isSystem = false) {
        const body = document.getElementById('chatBody');
        const div = document.createElement('div');
        
        if(isSystem) {
            div.className = 'chat-msg sys';
            div.textContent = msg;
        } else {
            const isMe = author && author.id === State.me.id;
            div.className = `chat-msg ${isMe ? 'me' : ''}`;
            div.innerHTML = `<strong>${isMe ? 'Moi' : (author ? author.name : 'Syst√®me')}</strong>: ${msg}`;
        }
        
        body.appendChild(div);
        body.scrollTop = body.scrollHeight;
        
        // Badge notification
        const panel = document.getElementById('chatPanel');
        if(!panel.classList.contains('active')) {
            const badge = document.getElementById('chatUnread');
            const count = parseInt(badge.textContent) + 1;
            badge.textContent = count;
            badge.classList.remove('hidden');
        }
    }

    // ============================================
    // 11. MODE SOLO
    // ============================================
    
    /**
     * D√©marrer le mode solo
     */
    function startSolo() {
        showScreen('solo');
        State.solo.score = 0;
        State.solo.streak = 0;
        State.solo.active = true;
        updateSoloStats();
        nextSoloRound();
    }
    
    /**
     * Passer au tour suivant en solo
     */
    function nextSoloRound() {
        if(!State.solo.active) return;
        
        const syllable = getSyllable(2);
        document.getElementById('soloSyllable').textContent = syllable;
        document.getElementById('soloInput').value = '';
        document.getElementById('soloInput').focus();
        
        // Timer progressivement plus dur
        let timeLeft = Math.max(4, 15 - (State.solo.score * 0.3));
        const maxTime = timeLeft;
        
        if(State.solo.timerObj) clearInterval(State.solo.timerObj);
        
        const updateInterval = powerSavingManager.isEnabled() ? 200 : 100;
        
        State.solo.timerObj = setInterval(() => {
            timeLeft -= (updateInterval / 1000);
            const pct = (timeLeft / maxTime) * 100;
            document.getElementById('soloTimerBar').style.width = `${pct}%`;
            
            if(timeLeft <= 0) {
                clearInterval(State.solo.timerObj);
                showToast(`üí• Perdu ! Score final: ${State.solo.score}`, 'error');
                State.solo.active = false;
                State.solo.streak = 0;
                updateSoloStats();
            }
        }, updateInterval);
        
        State.solo.currentSyl = syllable;
    }
    
    /**
     * Soumettre un mot en mode solo
     */
    async function submitSolo() {
        if(!State.solo.active) return;
        const input = document.getElementById('soloInput');
        const word = input.value;
        
        // Mode solo utilise le dictionnaire offline
        const check = await isValidWord(word, State.solo.currentSyl, [], true);
        
        if(check.ok) {
            State.solo.score++;
            State.solo.streak++;
            
            if(!powerSavingManager.isEnabled()) {
                soundManager.playConfetti();
            }
            
            updateSoloStats();
            nextSoloRound();
        } else {
            showToast(check.msg, 'error');
            input.classList.add('shake');
            setTimeout(() => input.classList.remove('shake'), 500);
        }
    }
    
    /**
     * Mettre √† jour les stats du mode solo
     */
    function updateSoloStats() {
        document.getElementById('soloScore').textContent = State.solo.score;
        document.getElementById('soloStreak').textContent = State.solo.streak;
    }

    // ============================================
    // 12. INITIALISATION & √âV√âNEMENTS DOM
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
        // Initialiser les managers
        themeManager.init();
        powerSavingManager.init();
        soundManager.init();
        
        // Charger le profil sauvegard√©
        const storedUser = localStorage.getItem('username');
        if(storedUser) {
            document.getElementById('usernameInput').value = storedUser;
            State.me.name = storedUser;
        }
        
        const storedColor = localStorage.getItem('userColor');
        if(storedColor) {
            document.getElementById('colorInput').value = storedColor;
            State.me.color = storedColor;
        }

        // ========== NAVIGATION ==========
        
        // Mode Solo
        document.getElementById('btnSolo').onclick = startSolo;
        document.getElementById('quitSoloBtn').onclick = () => {
            State.solo.active = false;
            if(State.solo.timerObj) clearInterval(State.solo.timerObj);
            showScreen('home');
        };

        // Cr√©er une partie
        document.getElementById('btnCreate').onclick = () => {
            document.getElementById('createModal').classList.add('active');
        };
        
        document.getElementById('cancelCreateBtn').onclick = () => {
            document.getElementById('createModal').classList.remove('active');
        };
        
        document.getElementById('confirmCreateBtn').onclick = () => {
            const user = document.getElementById('usernameInput').value.trim() || 'H√¥te';
            State.me.name = user;
            localStorage.setItem('username', user);
            localStorage.setItem('userColor', State.me.color);
            
            const config = {
                lives: parseInt(document.getElementById('configLives').value),
                time: parseInt(document.getElementById('configTime').value),
                diff: parseInt(document.getElementById('configDiff').value)
            };
            
            document.getElementById('createModal').classList.remove('active');
            becomeHost(config);
        };

        // Rejoindre une partie
        document.getElementById('btnJoin').onclick = () => {
            document.getElementById('joinModal').classList.add('active');
        };
        
        document.getElementById('cancelJoinBtn').onclick = () => {
            document.getElementById('joinModal').classList.remove('active');
        };
        
        document.getElementById('confirmJoinBtn').onclick = () => {
            const user = document.getElementById('usernameInput').value.trim() || 'Invit√©';
            const code = document.getElementById('joinCodeInput').value.trim();
            
            if(code.length !== 6) {
                return showToast("Code invalide (6 chiffres)", 'error');
            }
            
            State.me.name = user;
            localStorage.setItem('username', user);
            localStorage.setItem('userColor', State.me.color);
            
            document.getElementById('joinModal').classList.remove('active');
            joinGame(code);
        };

        // ========== LOBBY ==========
        
        document.getElementById('copyCodeBtn').onclick = () => {
            navigator.clipboard.writeText(State.gameCode).then(() => {
                showToast("üìã Code copi√© !", 'success');
            }).catch(() => {
                showToast("Erreur copie", 'error');
            });
        };
        
        document.getElementById('leaveLobbyBtn').onclick = () => {
            if(confirm("Quitter le salon ?")) {
                location.reload();
            }
        };
        
        document.getElementById('startGameBtn').onclick = () => {
            if(State.isHost) {
                const msg = { type: 'START_REQ' };
                handleDataHost(msg, null);
            }
        };

        // ========== JEU ==========
        
        document.getElementById('submitWordBtn').onclick = () => {
            const input = document.getElementById('gameInput');
            const word = input.value.trim();
            input.value = '';
            
            if(!word) return;
            
            if(State.isHost) {
                processWordAttempt(word, State.me.id);
            } else if(State.hostConn) {
                try {
                    State.hostConn.send({ 
                        type: 'WORD_SUBMIT', 
                        word: word, 
                        playerId: State.me.id 
                    });
                } catch(e) {
                    showToast('Erreur envoi', 'error');
                }
            }
        };
        
        document.getElementById('quitGameBtn').onclick = () => {
            if(confirm("Quitter la partie ?")) {
                location.reload();
            }
        };

        // ========== SOLO ==========
        
        document.getElementById('soloSubmitBtn').onclick = submitSolo;
        
        document.getElementById('soloInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') submitSolo();
        });
        
        document.getElementById('gameInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') {
                document.getElementById('submitWordBtn').click();
            }
        });

        // ========== CHAT ==========
        
        document.getElementById('toggleChatBtn').onclick = () => {
            const panel = document.getElementById('chatPanel');
            const settings = document.getElementById('settingsPanel');
            
            // Fermer settings si ouvert
            settings.classList.remove('active');
            
            // Toggle chat
            panel.classList.toggle('active');
            
            // Reset badge
            if(panel.classList.contains('active')) {
                document.getElementById('chatUnread').textContent = '0';
                document.getElementById('chatUnread').classList.add('hidden');
                document.getElementById('chatInput').focus();
            }
        };
        
        document.getElementById('closeChatBtn').onclick = () => {
            document.getElementById('chatPanel').classList.remove('active');
        };
        
        document.getElementById('chatSendBtn').onclick = sendChat;
        
        document.getElementById('chatInput').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') sendChat();
        });

        // ========== PARAM√àTRES ==========
        
        document.getElementById('openSettingsBtn').onclick = () => {
            const panel = document.getElementById('settingsPanel');
            const chat = document.getElementById('chatPanel');
            
            // Fermer chat si ouvert
            chat.classList.remove('active');
            
            // Toggle settings
            panel.classList.toggle('active');
        };
        
        // Fermer settings en cliquant ailleurs
        document.addEventListener('click', (e) => {
            const settingsPanel = document.getElementById('settingsPanel');
            const settingsBtn = document.getElementById('openSettingsBtn');
            const chatPanel = document.getElementById('chatPanel');
            const chatBtn = document.getElementById('toggleChatBtn');
            
            if(!settingsPanel.contains(e.target) && !settingsBtn.contains(e.target)) {
                settingsPanel.classList.remove('active');
            }
            
            if(!chatPanel.contains(e.target) && !chatBtn.contains(e.target)) {
                chatPanel.classList.remove('active');
            }
        });

        // ========== AVATAR & COULEUR ==========
        
        // G√©n√©rer les emojis avec couleurs pr√©d√©finies
        const emojiData = [
            // Smileys
            { emoji: 'üòÄ', color: '#fbbf24' },
            { emoji: 'üòé', color: '#3b82f6' },
            { emoji: 'ü§©', color: '#f59e0b' },
            { emoji: 'üòá', color: '#60a5fa' },
            { emoji: 'ü•≥', color: '#a855f7' },
            { emoji: 'üòà', color: '#ef4444' },
            { emoji: 'üëª', color: '#e5e7eb' },
            { emoji: 'üëΩ', color: '#10b981' },
            { emoji: 'ü§ñ', color: '#6b7280' },
            { emoji: 'üí©', color: '#92400e' },
            { emoji: 'ü§°', color: '#ec4899' },
            { emoji: 'ü§†', color: '#d97706' },
            { emoji: 'üéÉ', color: '#f97316' },
            { emoji: 'ü¶∏', color: '#3b82f6' },
            { emoji: 'üßô', color: '#8b5cf6' },
            { emoji: 'üßõ', color: '#b91c1c' },
            { emoji: 'üßü', color: '#84cc16' },
            { emoji: 'üßö', color: '#ec4899' },
            // Animaux
            { emoji: 'üê∂', color: '#d97706' },
            { emoji: 'üê±', color: '#f59e0b' },
            { emoji: 'üê≠', color: '#9ca3af' },
            { emoji: 'üêπ', color: '#fbbf24' },
            { emoji: 'üê∞', color: '#e5e7eb' },
            { emoji: 'ü¶ä', color: '#f97316' },
            { emoji: 'üêª', color: '#92400e' },
            { emoji: 'üêº', color: '#000000' },
            { emoji: 'üê®', color: '#9ca3af' },
            { emoji: 'üêØ', color: '#f59e0b' },
            { emoji: 'ü¶Å', color: '#fbbf24' },
            { emoji: 'üêÆ', color: '#78716c' },
            { emoji: 'üê∑', color: '#fca5a5' },
            { emoji: 'üê∏', color: '#22c55e' },
            { emoji: 'üêµ', color: '#92400e' },
            { emoji: 'üêî', color: '#fbbf24' },
            { emoji: 'üêß', color: '#1e293b' },
            { emoji: 'üê¶', color: '#3b82f6' },
            { emoji: 'üê§', color: '#fef08a' },
            { emoji: 'ü¶Ü', color: '#fbbf24' },
            { emoji: 'ü¶Ö', color: '#78716c' },
            { emoji: 'ü¶â', color: '#92400e' },
            { emoji: 'ü¶á', color: '#1e293b' },
            { emoji: 'üê∫', color: '#6b7280' },
            { emoji: 'üêó', color: '#78716c' },
            { emoji: 'üê¥', color: '#92400e' },
            { emoji: 'ü¶Ñ', color: '#ec4899' },
            { emoji: 'üêù', color: '#fbbf24' },
            { emoji: 'üêõ', color: '#84cc16' },
            { emoji: 'ü¶ã', color: '#a855f7' },
            { emoji: 'üêå', color: '#d97706' },
            { emoji: 'üêû', color: '#ef4444' },
            { emoji: 'üêú', color: '#1e293b' },
            { emoji: 'ü¶ó', color: '#84cc16' },
            { emoji: 'üï∑Ô∏è', color: '#1e293b' },
            { emoji: 'ü¶Ç', color: '#991b1b' },
            { emoji: 'üê¢', color: '#16a34a' },
            { emoji: 'üêç', color: '#22c55e' },
            { emoji: 'ü¶é', color: '#84cc16' },
            { emoji: 'ü¶ñ', color: '#22c55e' },
            { emoji: 'ü¶ï', color: '#16a34a' },
            { emoji: 'üêô', color: '#a855f7' },
            { emoji: 'ü¶ë', color: '#ec4899' },
            { emoji: 'ü¶ê', color: '#f97316' },
            { emoji: 'ü¶Ä', color: '#ef4444' },
            { emoji: 'üê°', color: '#fbbf24' },
            { emoji: 'üê†', color: '#06b6d4' },
            { emoji: 'üêü', color: '#3b82f6' },
            { emoji: 'üê¨', color: '#0ea5e9' },
            { emoji: 'üê≥', color: '#3b82f6' },
            { emoji: 'üêã', color: '#1e3a8a' },
            { emoji: 'ü¶à', color: '#475569' },
            { emoji: 'üêä', color: '#15803d' },
            { emoji: 'üêÖ', color: '#f97316' },
            { emoji: 'üêÜ', color: '#fbbf24' },
            { emoji: 'ü¶ì', color: '#1e293b' },
            { emoji: 'ü¶ç', color: '#1c1917' },
            { emoji: 'ü¶ß', color: '#d97706' },
            { emoji: 'üêò', color: '#6b7280' },
            { emoji: 'ü¶õ', color: '#78716c' },
            { emoji: 'ü¶è', color: '#9ca3af' },
            { emoji: 'üê™', color: '#d97706' },
            { emoji: 'üê´', color: '#92400e' },
            { emoji: 'ü¶í', color: '#fbbf24' },
            { emoji: 'ü¶ò', color: '#92400e' },
            { emoji: 'ü¶¨', color: '#78716c' },
            { emoji: 'üêÉ', color: '#78716c' },
            { emoji: 'üêÇ', color: '#92400e' },
            { emoji: 'üêÑ', color: '#1e293b' },
            { emoji: 'üêé', color: '#92400e' },
            { emoji: 'üêñ', color: '#fca5a5' },
            { emoji: 'üêè', color: '#e5e7eb' },
            { emoji: 'üêë', color: '#f3f4f6' },
            { emoji: 'üêê', color: '#6b7280' },
            { emoji: 'ü¶å', color: '#92400e' },
            { emoji: 'üêï', color: '#d97706' },
            { emoji: 'üê©', color: '#e5e7eb' },
            { emoji: 'ü¶Æ', color: '#fbbf24' },
            { emoji: 'üêà', color: '#f59e0b' },
            { emoji: 'üêà‚Äç‚¨õ', color: '#1e293b' },
            { emoji: 'üêì', color: '#ef4444' },
            { emoji: 'ü¶É', color: '#92400e' },
            { emoji: 'ü¶ö', color: '#3b82f6' },
            { emoji: 'ü¶ú', color: '#22c55e' },
            { emoji: 'ü¶¢', color: '#f3f4f6' },
            { emoji: 'ü¶©', color: '#ec4899' },
            { emoji: 'üïäÔ∏è', color: '#e5e7eb' },
            { emoji: 'üêá', color: '#e5e7eb' },
            { emoji: 'ü¶ù', color: '#6b7280' },
            { emoji: 'ü¶®', color: '#1e293b' },
            { emoji: 'ü¶°', color: '#78716c' },
            { emoji: 'ü¶¶', color: '#92400e' },
            { emoji: 'ü¶•', color: '#78716c' },
            { emoji: 'üêÅ', color: '#9ca3af' },
            { emoji: 'üêÄ', color: '#6b7280' },
            { emoji: 'üêøÔ∏è', color: '#d97706' },
            { emoji: 'ü¶î', color: '#92400e' }
        ];
        
        const grid = document.getElementById('emojiGrid');
        emojiData.forEach(data => {
            const el = document.createElement('div');
            el.className = 'emoji-item';
            el.textContent = data.emoji;
            el.onclick = () => {
                State.me.avatar = data.emoji;
                State.me.color = data.color;
                document.getElementById('avatarBtn').textContent = data.emoji;
                document.getElementById('avatarBtn').style.borderColor = data.color;
                document.getElementById('avatarBtn').style.backgroundColor = data.color + '20';
                document.getElementById('colorInput').value = data.color;
                document.getElementById('emojiModal').classList.remove('active');
                localStorage.setItem('userColor', data.color);
            };
            grid.appendChild(el);
        });
        
        document.getElementById('avatarBtn').onclick = () => {
            document.getElementById('emojiModal').classList.add('active');
        };
        
        document.getElementById('closeEmojiBtn').onclick = () => {
            document.getElementById('emojiModal').classList.remove('active');
        };
        
        document.getElementById('colorInput').onchange = (e) => {
            State.me.color = e.target.value;
            document.getElementById('avatarBtn').style.borderColor = e.target.value;
            document.getElementById('avatarBtn').style.backgroundColor = e.target.value + '20';
            localStorage.setItem('userColor', e.target.value);
        };

        // ========== R√àGLES ==========
        
        document.getElementById('btnRules').onclick = () => {
            document.getElementById('rulesModal').classList.add('active');
        };
        
        document.getElementById('closeRulesBtn').onclick = () => {
            document.getElementById('rulesModal').classList.remove('active');
        };

        // ========== FERMETURE MODALS ==========
        
        // Fermer les modals en cliquant en dehors
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if(e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // √âchapper pour fermer les modals
        document.addEventListener('keydown', (e) => {
            if(e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(m => {
                    m.classList.remove('active');
                });
                document.getElementById('settingsPanel').classList.remove('active');
                document.getElementById('chatPanel').classList.remove('active');
            }
        });

        console.log('üéÆ Tic Tac Boom Pro - Pr√™t !');
    });

    </script>
</body>
</html>
