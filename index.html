<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí£ Tic Tac Boom - Jeu de Mots</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
/* ===== VARIABLES ===== */
:root {
    --bg-primary: #0f172a;
    --bg-secondary: #1e293b;
    --bg-tertiary: #334155;
    --bg-overlay: rgba(15, 23, 42, 0.95);
    
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-tertiary: #94a3b8;
    
    --accent-primary: #3b82f6;
    --accent-secondary: #8b5cf6;
    --accent-success: #10b981;
    --accent-warning: #f59e0b;
    --accent-danger: #ef4444;
    
    --border-color: #334155;
    --border-radius: 12px;
    
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
    
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="light"] {
    --bg-primary: #f8fafc;
    --bg-secondary: #ffffff;
    --bg-tertiary: #e2e8f0;
    --bg-overlay: rgba(248, 250, 252, 0.95);
    
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-tertiary: #64748b;
    
    --border-color: #e2e8f0;
    
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.15);
}

/* ===== RESET ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    font-size: 16px;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
    min-height: 100vh;
    transition: background 0.3s, color 0.3s;
}

/* ===== UTILITY CLASSES ===== */
.hidden {
    display: none !important;
}

.screen {
    display: none;
    min-height: 100vh;
    padding: 1rem;
}

.screen.active {
    display: flex;
    flex-direction: column;
}

.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 1rem;
}

.card {
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: var(--border-radius);
    background: var(--accent-primary);
    color: white;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
    font-family: inherit;
    white-space: nowrap;
}

.btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    filter: brightness(1.1);
}

.btn:active:not(:disabled) {
    transform: translateY(0);
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.btn-success {
    background: var(--accent-success);
}

.btn-danger {
    background: var(--accent-danger);
}

.input {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 1rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    color: var(--text-primary);
    font-family: inherit;
    transition: var(--transition);
}

.input:focus {
    outline: none;
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.input::placeholder {
    color: var(--text-tertiary);
}

/* ===== HOME SCREEN ===== */
#home {
    align-items: center;
    justify-content: center;
}

.home-content {
    text-align: center;
    max-width: 600px;
    width: 100%;
}

.logo {
    font-size: 5rem;
    margin-bottom: 1rem;
    animation: bounce 2s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

.title {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.subtitle {
    font-size: 1.125rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.username-section {
    margin-bottom: 2rem;
}

.username-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.username-input-group {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.emoji-select {
    flex-shrink: 0;
    font-size: 2rem;
    cursor: pointer;
    padding: 0.5rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.emoji-select:hover {
    border-color: var(--accent-primary);
}

.color-select {
    flex-shrink: 0;
    width: 50px;
    height: 50px;
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
}

.color-select:hover {
    border-color: var(--accent-primary);
}

.actions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.action-card {
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
}

.action-card:hover {
    border-color: var(--accent-primary);
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
}

.action-card-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

.action-card-title {
    font-size: 1.125rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.action-card-desc {
    font-size: 0.875rem;
    color: var(--text-tertiary);
}

.theme-toggle {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1000;
}

.theme-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    cursor: pointer;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.theme-btn:hover {
    border-color: var(--accent-primary);
    transform: rotate(180deg);
}

/* ===== MODAL ===== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--bg-overlay);
    z-index: 2000;
    backdrop-filter: blur(8px);
    align-items: center;
    justify-content: center;
    padding: 1rem;
    animation: fadeIn 0.3s;
}

.modal.active {
    display: flex;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    padding: 2rem;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    animation: slideUp 0.3s;
}

@keyframes slideUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 700;
}

.modal-close {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--bg-tertiary);
    border: none;
    cursor: pointer;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
}

.modal-close:hover {
    background: var(--accent-danger);
    color: white;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.form-description {
    font-size: 0.875rem;
    color: var(--text-tertiary);
    margin-top: 0.25rem;
}

.range-group {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.range {
    flex: 1;
    height: 6px;
    border-radius: 3px;
    background: var(--bg-tertiary);
    -webkit-appearance: none;
    appearance: none;
}

.range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent-primary);
    cursor: pointer;
}

.range::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent-primary);
    cursor: pointer;
    border: none;
}

.range-value {
    min-width: 60px;
    padding: 0.5rem 1rem;
    background: var(--accent-primary);
    color: white;
    border-radius: var(--border-radius);
    font-weight: 700;
    text-align: center;
}

.radio-group {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.radio-option {
    flex: 1;
    min-width: 100px;
}

.radio-option input {
    display: none;
}

.radio-option label {
    display: block;
    padding: 0.75rem 1rem;
    background: var(--bg-tertiary);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    text-align: center;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 600;
}

.radio-option input:checked + label {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

.checkbox-option {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: var(--transition);
}

.checkbox-option:hover {
    background: var(--bg-secondary);
}

.checkbox-option input {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* ===== LOBBY ===== */
#lobby {
    align-items: center;
    justify-content: center;
}

.lobby-container {
    max-width: 800px;
    width: 100%;
}

.lobby-header {
    text-align: center;
    margin-bottom: 2rem;
}

.lobby-code-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
}

.lobby-code-label {
    font-size: 0.875rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.lobby-code {
    font-size: 3rem;
    font-weight: 800;
    letter-spacing: 0.5rem;
    color: var(--accent-primary);
    font-family: 'Courier New', monospace;
}

.copy-code-btn {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
}

.players-section {
    margin-bottom: 2rem;
}

.players-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.players-count {
    color: var(--text-tertiary);
}

.players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.player-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.player-card.me {
    border-color: var(--accent-primary);
}

.player-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    flex-shrink: 0;
}

.player-info {
    flex: 1;
    min-width: 0;
}

.player-name {
    font-weight: 700;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.player-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    background: var(--accent-primary);
    color: white;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-top: 0.25rem;
}

.lobby-actions {
    display: flex;
    gap: 1rem;
}

.lobby-actions .btn {
    flex: 1;
}

.connection-status {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--bg-tertiary);
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    margin-bottom: 1rem;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--accent-success);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.ping-display {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    margin-left: auto;
}

/* ===== GAME SCREEN ===== */
#game {
    justify-content: center;
    padding: 0;
}

.game-container {
    width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    position: relative;
}

.game-header {
    padding: 1rem;
    background: var(--bg-secondary);
    border-bottom: 2px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.game-info {
    display: flex;
    gap: 2rem;
    align-items: center;
}

.game-stat {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.game-stat-label {
    font-size: 0.75rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
}

.game-stat-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.game-actions {
    display: flex;
    gap: 0.5rem;
}

.game-actions .btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}

.game-board {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.players-circle {
    position: relative;
    width: min(90vw, 90vh);
    height: min(90vw, 90vh);
    max-width: 600px;
    max-height: 600px;
}

.bomb-center {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
}

.bomb {
    font-size: 6rem;
    animation: bombShake 0.5s infinite;
}

.bomb.critical {
    animation: bombShake 0.1s infinite, bombGlow 0.5s infinite;
}

@keyframes bombShake {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
}

@keyframes bombGlow {
    0%, 100% { filter: drop-shadow(0 0 10px #ef4444); }
    50% { filter: drop-shadow(0 0 30px #ef4444); }
}

.syllable-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, calc(-50% + 80px));
    text-align: center;
    z-index: 11;
}

.syllable {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    text-transform: uppercase;
    letter-spacing: 0.2rem;
}

.timer-bar {
    margin-top: 1rem;
    width: 200px;
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
    position: relative;
}

.timer-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-success), var(--accent-warning), var(--accent-danger));
    transition: width 0.1s linear;
}

.timer-text {
    text-align: center;
    margin-top: 0.5rem;
    font-weight: 700;
    font-size: 1.125rem;
}

.game-player {
    position: absolute;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    transition: var(--transition);
}

.game-player-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 3px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    background: var(--bg-secondary);
    transition: var(--transition);
}

.game-player.active .game-player-avatar {
    border-color: var(--accent-primary);
    box-shadow: 0 0 20px var(--accent-primary);
    animation: activePlayer 1s infinite;
}

@keyframes activePlayer {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.game-player.me .game-player-avatar {
    border-color: var(--accent-success);
    border-width: 4px;
}

.game-player.out .game-player-avatar {
    opacity: 0.3;
    filter: grayscale(1);
}

.game-player-name {
    font-size: 0.875rem;
    font-weight: 600;
    background: var(--bg-secondary);
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    border: 1px solid var(--border-color);
    white-space: nowrap;
}

.game-player-lives {
    font-size: 1rem;
}

.player-arrow {
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 2rem;
    animation: arrowBounce 1s infinite;
}

@keyframes arrowBounce {
    0%, 100% { transform: translateX(-50%) translateY(0); }
    50% { transform: translateX(-50%) translateY(-10px); }
}

.game-input-area {
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-top: 2px solid var(--border-color);
    flex-shrink: 0;
}

.input-wrapper {
    display: flex;
    gap: 1rem;
    max-width: 600px;
    margin: 0 auto;
}

.word-input {
    flex: 1;
    font-size: 1.25rem;
    text-transform: uppercase;
    text-align: center;
    font-weight: 700;
    letter-spacing: 0.1rem;
}

.submit-btn {
    padding: 1rem 2rem;
    font-size: 1.125rem;
}

.game-status {
    text-align: center;
    padding: 1rem;
    font-size: 1.125rem;
    color: var(--text-secondary);
}

.used-words-section {
    position: absolute;
    top: 80px;
    left: 1rem;
    max-width: 250px;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    padding: 1rem;
    background: var(--bg-overlay);
    border-radius: var(--border-radius);
    backdrop-filter: blur(8px);
}

.used-words-title {
    font-size: 0.875rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--text-tertiary);
}

.used-words-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.used-word {
    padding: 0.5rem;
    background: var(--bg-secondary);
    border-radius: 6px;
    font-size: 0.875rem;
    text-transform: uppercase;
}

/* ===== CHAT ===== */
.chat-toggle {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 100;
}

.chat-toggle-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--accent-primary);
    border: none;
    cursor: pointer;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-lg);
    transition: var(--transition);
    position: relative;
}

.chat-toggle-btn:hover {
    transform: scale(1.1);
}

.chat-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 24px;
    height: 24px;
    background: var(--accent-danger);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
}

.chat-panel {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 350px;
    max-height: 500px;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-lg);
    display: flex;
    flex-direction: column;
    z-index: 99;
    transform: scale(0);
    transform-origin: bottom right;
    transition: var(--transition);
}

.chat-panel.active {
    transform: scale(1);
}

.chat-header {
    padding: 1rem;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-title {
    font-weight: 700;
}

.chat-close {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.5rem;
    color: var(--text-tertiary);
    transition: var(--transition);
}

.chat-close:hover {
    color: var(--accent-danger);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.chat-message {
    display: flex;
    gap: 0.5rem;
    align-items: flex-start;
}

.chat-message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    flex-shrink: 0;
}

.chat-message-content {
    flex: 1;
    min-width: 0;
}

.chat-message-name {
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.chat-message-text {
    background: var(--bg-tertiary);
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    word-wrap: break-word;
}

.chat-message.system {
    justify-content: center;
}

.chat-message.system .chat-message-text {
    background: none;
    color: var(--text-tertiary);
    font-size: 0.875rem;
    text-align: center;
}

.chat-input-area {
    padding: 1rem;
    border-top: 2px solid var(--border-color);
}

.reactions-bar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    overflow-x: auto;
}

.reaction-btn {
    background: var(--bg-tertiary);
    border: none;
    border-radius: 6px;
    padding: 0.5rem;
    font-size: 1.25rem;
    cursor: pointer;
    transition: var(--transition);
}

.reaction-btn:hover {
    transform: scale(1.2);
}

.chat-input-wrapper {
    display: flex;
    gap: 0.5rem;
}

.chat-input {
    flex: 1;
    padding: 0.75rem;
    font-size: 0.875rem;
}

.chat-send {
    padding: 0.75rem;
    background: var(--accent-primary);
    border: none;
    border-radius: var(--border-radius);
    color: white;
    cursor: pointer;
    font-size: 1.25rem;
    transition: var(--transition);
}

.chat-send:hover {
    background: var(--accent-secondary);
}

/* ===== SOLO MODE ===== */
.solo-container {
    max-width: 800px;
    width: 100%;
    margin: 0 auto;
}

.solo-score-section {
    text-align: center;
    padding: 2rem;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    margin-bottom: 2rem;
}

.solo-score {
    font-size: 4rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.solo-streak {
    font-size: 1.25rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

.streak-fire {
    font-size: 1.5rem;
    display: inline-block;
    animation: fireFlicker 0.5s infinite;
}

@keyframes fireFlicker {
    0%, 100% { transform: scale(1) rotate(-5deg); }
    50% { transform: scale(1.2) rotate(5deg); }
}

.achievements-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.achievement {
    text-align: center;
    padding: 1rem;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.achievement.unlocked {
    border: 2px solid var(--accent-success);
}

.achievement-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    filter: grayscale(1);
    opacity: 0.3;
    transition: var(--transition);
}

.achievement.unlocked .achievement-icon {
    filter: grayscale(0);
    opacity: 1;
    animation: achievementPop 0.5s;
}

@keyframes achievementPop {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.achievement-name {
    font-size: 0.875rem;
    font-weight: 600;
}

.achievement-desc {
    font-size: 0.75rem;
    color: var(--text-tertiary);
}

/* ===== VICTORY SCREEN ===== */
.victory-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 3000;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.5s;
}

.victory-overlay.active {
    display: flex;
}

.victory-content {
    text-align: center;
    padding: 2rem;
    animation: victoryBounce 0.8s;
}

@keyframes victoryBounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.victory-icon {
    font-size: 8rem;
    margin-bottom: 1rem;
}

.victory-title {
    font-size: 3rem;
    font-weight: 800;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
}

.victory-winner {
    font-size: 2rem;
    color: var(--text-primary);
    margin-bottom: 2rem;
}

.victory-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

/* ===== NOTIFICATIONS ===== */
.notification {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    padding: 1rem 1.5rem;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 1rem;
    z-index: 4000;
    animation: slideInRight 0.3s;
    max-width: 400px;
}

@keyframes slideInRight {
    from { transform: translateX(500px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.notification.success {
    border-left: 4px solid var(--accent-success);
}

.notification.error {
    border-left: 4px solid var(--accent-danger);
}

.notification.info {
    border-left: 4px solid var(--accent-primary);
}

.notification-icon {
    font-size: 1.5rem;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.notification-message {
    font-size: 0.875rem;
    color: var(--text-tertiary);
}

/* ===== EMOJI PICKER ===== */
.emoji-picker {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 0.5rem;
    background: var(--bg-secondary);
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: 1rem;
    box-shadow: var(--shadow-lg);
    z-index: 100;
    display: none;
    max-width: 300px;
}

.emoji-picker.active {
    display: block;
}

.emoji-category {
    margin-bottom: 1rem;
}

.emoji-category-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--text-tertiary);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
}

.emoji-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 0.5rem;
}

.emoji-option {
    font-size: 2rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 6px;
    transition: var(--transition);
    text-align: center;
}

.emoji-option:hover {
    background: var(--bg-tertiary);
    transform: scale(1.2);
}

/* ===== LOADING ===== */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid var(--border-color);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .title {
        font-size: 2rem;
    }
    
    .actions-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        padding: 1.5rem;
    }
    
    .players-grid {
        grid-template-columns: 1fr;
    }
    
    .lobby-code {
        font-size: 2rem;
        letter-spacing: 0.3rem;
    }
    
    .bomb {
        font-size: 4rem;
    }
    
    .syllable {
        font-size: 2rem;
    }
    
    .used-words-section {
        position: static;
        max-width: 100%;
        margin-top: 1rem;
    }
    
    .chat-panel {
        width: calc(100% - 2rem);
        max-width: 350px;
    }
    
    .game-info {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
    }
    
    .game-actions {
        flex-direction: column;
        width: 100%;
    }
    
    .game-actions .btn {
        width: 100%;
    }
    
    .input-wrapper {
        flex-direction: column;
    }
    
    .victory-title {
        font-size: 2rem;
    }
    
    .victory-winner {
        font-size: 1.5rem;
    }
}

@media (max-width: 480px) {
    .logo {
        font-size: 3rem;
    }
    
    .game-player-avatar {
        width: 40px;
        height: 40px;
        font-size: 1.5rem;
    }
    
    .game-player-name {
        font-size: 0.75rem;
    }
}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
}

::-webkit-scrollbar-thumb {
    background: var(--accent-primary);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--accent-secondary);
}
    </style>
</head>
<body>

<!-- Theme Toggle -->
<div class="theme-toggle">
    <button class="theme-btn" id="themeToggle">
        <span id="themeIcon">üåô</span>
    </button>
</div>

<!-- Home Screen -->
<div id="home" class="screen active">
    <div class="home-content">
        <div class="logo">üí£</div>
        <h1 class="title">Tic Tac Boom</h1>
        <p class="subtitle">Trouve un mot avant que la bombe n'explose !</p>
        
        <div class="username-section">
            <label class="username-label">Ton pseudo</label>
            <div class="username-input-group">
                <div style="position: relative;">
                    <button class="emoji-select" id="emojiBtn">üòÄ</button>
                    <div class="emoji-picker" id="emojiPicker"></div>
                </div>
                <input type="text" class="input" id="usernameInput" placeholder="Ton pseudo..." maxlength="20">
                <input type="color" class="color-select" id="colorPicker" value="#3b82f6">
            </div>
        </div>
        
        <div class="actions-grid">
            <div class="action-card" id="soloBtn">
                <div class="action-card-icon">üéØ</div>
                <div class="action-card-title">Mode Solo</div>
                <div class="action-card-desc">Entra√Æne-toi seul</div>
            </div>
            <div class="action-card" id="createBtn">
                <div class="action-card-icon">üéÆ</div>
                <div class="action-card-title">Cr√©er</div>
                <div class="action-card-desc">Nouvelle partie</div>
            </div>
            <div class="action-card" id="joinBtn">
                <div class="action-card-icon">üîó</div>
                <div class="action-card-title">Rejoindre</div>
                <div class="action-card-desc">Code √† 6 chiffres</div>
            </div>
            <div class="action-card" id="rulesBtn">
                <div class="action-card-icon">üìñ</div>
                <div class="action-card-title">R√®gles</div>
                <div class="action-card-desc">Comment jouer</div>
            </div>
        </div>
        
        <div id="connectionStatus" class="connection-status hidden">
            <div class="loading-spinner"></div>
            <span>Connexion en cours...</span>
        </div>
    </div>
</div>

<!-- Create Game Modal -->
<div id="createModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Cr√©er une partie</h2>
            <button class="modal-close" id="closeCreateModal">√ó</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">Nombre de vies</label>
            <div class="range-group">
                <input type="range" class="range" id="livesRange" min="1" max="10" value="3">
                <div class="range-value" id="livesValue">3</div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Temps initial (secondes)</label>
            <div class="range-group">
                <input type="range" class="range" id="timeRange" min="5" max="30" value="15">
                <div class="range-value" id="timeValue">15s</div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Position de la syllabe</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="position" id="posAny" value="ANY" checked>
                    <label for="posAny">N'importe o√π</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="position" id="posStart" value="START">
                    <label for="posStart">D√©but</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="position" id="posEnd" value="END">
                    <label for="posEnd">Fin</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Longueur de syllabe</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="sylLength" id="syl2" value="2" checked>
                    <label for="syl2">2 lettres</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="sylLength" id="syl3" value="3">
                    <label for="syl3">3 lettres</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label class="checkbox-option">
                <input type="checkbox" id="strictMode">
                <span>Mode strict (dictionnaire)</span>
            </label>
        </div>
        
        <button class="btn btn-primary" id="confirmCreate" style="width: 100%;">
            Cr√©er la partie
        </button>
    </div>
</div>

<!-- Join Game Modal -->
<div id="joinModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Rejoindre une partie</h2>
            <button class="modal-close" id="closeJoinModal">√ó</button>
        </div>
        
        <div class="form-group">
            <label class="form-label">Code de la partie</label>
            <input type="text" class="input" id="joinCodeInput" placeholder="000000" maxlength="6" style="text-align: center; font-size: 2rem; letter-spacing: 0.5rem; font-weight: 700;">
        </div>
        
        <button class="btn btn-primary" id="confirmJoin" style="width: 100%;">
            Rejoindre
        </button>
    </div>
</div>

<!-- Rules Modal -->
<div id="rulesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">R√®gles du jeu</h2>
            <button class="modal-close" id="closeRulesModal">√ó</button>
        </div>
        
        <div style="line-height: 1.8;">
            <h3 style="margin-top: 1rem; margin-bottom: 0.5rem;">üéØ Objectif</h3>
            <p>Trouve un mot contenant la syllabe affich√©e avant que le temps n'expire !</p>
            
            <h3 style="margin-top: 1rem; margin-bottom: 0.5rem;">üéÆ D√©roulement</h3>
            <p>‚Ä¢ Chaque joueur joue √† tour de r√¥le<br>
            ‚Ä¢ Une syllabe est affich√©e au centre<br>
            ‚Ä¢ Trouve un mot contenant cette syllabe<br>
            ‚Ä¢ Le temps diminue √† chaque tour<br>
            ‚Ä¢ Si le temps expire, tu perds une vie ‚ù§Ô∏è</p>
            
            <h3 style="margin-top: 1rem; margin-bottom: 0.5rem;">üèÜ Victoire</h3>
            <p>Le dernier joueur avec des vies gagne !</p>
            
            <h3 style="margin-top: 1rem; margin-bottom: 0.5rem;">üí° Astuces</h3>
            <p>‚Ä¢ Les mots d√©j√† utilis√©s sont interdits<br>
            ‚Ä¢ Plus tu joues vite, plus le temps diminue<br>
            ‚Ä¢ En mode strict, seuls les mots du dictionnaire sont accept√©s</p>
        </div>
        
        <button class="btn btn-primary" id="closeRulesBtn" style="width: 100%; margin-top: 1rem;">
            Compris !
        </button>
    </div>
</div>

<!-- Lobby Screen -->
<div id="lobby" class="screen">
    <div class="lobby-container">
        <div class="lobby-header">
            <h1 class="title">Salon d'attente</h1>
        </div>
        
        <div class="lobby-code-section">
            <div class="lobby-code-label">Code de la partie</div>
            <div class="lobby-code" id="lobbyCode">000000</div>
            <button class="btn btn-secondary copy-code-btn" id="copyCodeBtn">
                üìã Copier le code
            </button>
        </div>
        
        <div id="lobbyStatus" class="connection-status">
            <div class="status-dot"></div>
            <span>Connect√©</span>
            <div class="ping-display" id="lobbyPing">0ms</div>
        </div>
        
        <div class="players-section">
            <div class="players-header">
                <h2>Joueurs</h2>
                <span class="players-count" id="playersCount">0/30</span>
            </div>
            <div class="players-grid" id="playersGrid"></div>
        </div>
        
        <div class="lobby-actions">
            <button class="btn btn-secondary" id="leaveLobbyBtn">Quitter</button>
            <button class="btn btn-success" id="startGameBtn">D√©marrer la partie</button>
        </div>
    </div>
</div>

<!-- Game Screen -->
<div id="game" class="screen">
    <div class="game-container">
        <div class="game-header">
            <div class="game-info">
                <div class="game-stat">
                    <div class="game-stat-label">Code</div>
                    <div class="game-stat-value" id="gameCode">000000</div>
                </div>
                <div class="game-stat">
                    <div class="game-stat-label">Joueurs</div>
                    <div class="game-stat-value" id="gamePlayers">0</div>
                </div>
                <div class="game-stat">
                    <div class="game-stat-label">Mots</div>
                    <div class="game-stat-value" id="gameWords">0</div>
                </div>
            </div>
            <div class="game-actions">
                <button class="btn btn-danger" id="leaveGameBtn">Quitter</button>
            </div>
        </div>
        
        <div class="game-board">
            <div class="used-words-section">
                <div class="used-words-title">Mots utilis√©s</div>
                <div class="used-words-list" id="usedWordsList"></div>
            </div>
            
            <div class="players-circle" id="playersCircle">
                <div class="bomb-center">
                    <div class="bomb" id="bombIcon">üí£</div>
                </div>
                
                <div class="syllable-display">
                    <div class="syllable" id="syllableText">...</div>
                    <div class="timer-bar">
                        <div class="timer-fill" id="timerFill"></div>
                    </div>
                    <div class="timer-text" id="timerText">0.0s</div>
                </div>
            </div>
        </div>
        
        <div class="game-input-area" id="gameInputArea">
            <div class="input-wrapper">
                <input type="text" class="input word-input" id="wordInput" placeholder="TON MOT...">
                <button class="btn btn-success submit-btn" id="submitWordBtn">Valider</button>
            </div>
        </div>
        
        <div class="game-status hidden" id="gameStatusText"></div>
    </div>
</div>

<!-- Solo Mode Screen -->
<div id="solo" class="screen">
    <div class="container">
        <div class="solo-container">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h1 class="title">Mode Solo</h1>
                <p class="subtitle">Encha√Æne les mots sans limite !</p>
            </div>
            
            <div class="solo-score-section">
                <div class="solo-score" id="soloScore">0</div>
                <div class="solo-streak" id="soloStreak">
                    <span class="streak-fire hidden">üî•</span>
                    <span id="streakText">Commence √† jouer !</span>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 2rem;">
                <div style="text-align: center;">
                    <div class="syllable" id="soloSyllable">...</div>
                    <div class="timer-bar" style="margin: 1rem auto; max-width: 300px;">
                        <div class="timer-fill" id="soloTimerFill"></div>
                    </div>
                    <div class="timer-text" id="soloTimerText">0.0s</div>
                </div>
                
                <div class="input-wrapper" style="margin-top: 1.5rem;">
                    <input type="text" class="input word-input" id="soloWordInput" placeholder="TON MOT...">
                    <button class="btn btn-success submit-btn" id="soloSubmitBtn">Valider</button>
                </div>
            </div>
            
            <div class="achievements-section" id="achievementsGrid"></div>
            
            <div style="text-align: center;">
                <button class="btn btn-secondary" id="quitSoloBtn">Retour √† l'accueil</button>
            </div>
        </div>
    </div>
</div>

<!-- Victory Overlay -->
<div id="victoryOverlay" class="victory-overlay">
    <div class="victory-content">
        <div class="victory-icon">üèÜ</div>
        <div class="victory-title">Victoire !</div>
        <div class="victory-winner" id="victoryWinner"></div>
        <div class="victory-actions">
            <button class="btn btn-secondary" id="victoryHomeBtn">Accueil</button>
            <button class="btn btn-primary" id="victoryRestartBtn">Rejouer</button>
        </div>
    </div>
</div>

<!-- Chat -->
<div class="chat-toggle" id="chatToggle">
    <button class="chat-toggle-btn">
        üí¨
        <span class="chat-badge hidden" id="chatBadge">0</span>
    </button>
</div>

<div class="chat-panel" id="chatPanel">
    <div class="chat-header">
        <div class="chat-title">Chat</div>
        <button class="chat-close" id="chatClose">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
        <div class="reactions-bar" id="reactionsBar">
            <button class="reaction-btn" data-reaction="üëç">üëç</button>
            <button class="reaction-btn" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</button>
            <button class="reaction-btn" data-reaction="üòÇ">üòÇ</button>
            <button class="reaction-btn" data-reaction="üî•">üî•</button>
            <button class="reaction-btn" data-reaction="üëè">üëè</button>
        </div>
        <div class="chat-input-wrapper">
            <input type="text" class="input chat-input" id="chatInput" placeholder="Message...">
            <button class="chat-send" id="chatSend">‚û§</button>
        </div>
    </div>
</div>

<script>
// ===== GAME STATE =====
const GameState = {
    peer: null,
    peerId: null,
    isHost: false,
    username: '',
    emoji: 'üòÄ',
    color: '#3b82f6',
    gameCode: '',
    connection: null,
    connections: [],
    
    game: {
        code: '',
        players: [],
        config: {
            lives: 3,
            initialTime: 15,
            position: 'ANY',
            syllableLength: 2,
            strict: false
        },
        currentPlayer: 0,
        syllable: '',
        timer: 0,
        maxTimer: 15,
        usedWords: [],
        state: 'WAITING', // WAITING, PLAYING, ENDED
        winner: null,
        interval: null
    },
    
    solo: {
        score: 0,
        streak: 0,
        bestStreak: 0,
        syllable: '',
        timer: 0,
        maxTimer: 15,
        usedWords: [],
        interval: null,
        achievements: []
    },
    
    chat: {
        messages: [],
        unread: 0
    },
    
    ping: 0,
    lastPingTime: 0,
    
    theme: 'dark'
};

// ===== DICTIONARY =====
const syllables2 = ['BA','BE','BI','BO','BU','CA','CE','CI','CO','CU','DA','DE','DI','DO','DU','FA','FE','FI','FO','FU','GA','GE','GI','GO','GU','HA','HE','HI','HO','HU','JA','JE','JI','JO','JU','LA','LE','LI','LO','LU','MA','ME','MI','MO','MU','NA','NE','NI','NO','NU','PA','PE','PI','PO','PU','RA','RE','RI','RO','RU','SA','SE','SI','SO','SU','TA','TE','TI','TO','TU','VA','VE','VI','VO','VU','ZA','ZE','ZI','ZO','ZU','CH','PH','QU','AN','EN','IN','ON','UN','OU','OI','AU','EU','AI','EI'];
const syllables3 = ['BAL','BAN','BAR','BAS','BAT','BEL','BEN','BER','BES','BET','BLA','BLE','BON','BOU','BRA','BRE','BRI','BRO','BRU','CAL','CAN','CAR','CAS','CAT','CEL','CER','CHA','CHE','CHI','CHO','CHU','CLA','CLE','COL','CON','COR','COU','CRA','CRE','CRI','CRO','DAN','DEM','DES','DIN','DIS','DON','DOU','DRA','DRE','DRO','FAC','FER','FIL','FIN','FLA','FLE','FOR','FOU','FRA','GAN','GAR','GEN','GLA','GON','GOU','GRA','GRE','GRO','HAL','HAN','HAU','HER','HON','HOU','JAN','JOU','LAC','LAN','LAR','LEM','LEN','LES','LIN','LON','LOU','MAL','MAN','MAR','MAS','MAT','MEN','MER','MIN','MON','MOR','MOU','NAL','NAN','NAT','NEL','NON','NOU','PAL','PAN','PAR','PAS','PAT','PEN','PER','PLA','PLE','PLI','PLO','PLU','POL','PON','POR','POU','PRA','PRE','PRI','PRO','QUA','QUE','QUI','RAL','RAN','RAP','RAT','REC','REN','RES','RIN','RON','ROU','SAL','SAN','SAU','SEC','SEM','SEN','SER','SIN','SON','SOU','TAC','TAN','TAR','TAS','TAT','TEM','TEN','TER','TIN','TON','TOR','TOU','TRA','TRE','TRI','TRO','VAL','VAN','VEN','VER','VIN','VOL','VOU'];

const frenchWords = new Set([
    'AMOUR','MAISON','SOLEIL','JARDIN','OISEAU','FLEUR','MONTAGNE','RIVI√àRE','NUAGE','√âTOILE',
    'BATEAU','CH√ÇTEAU','FOR√äT','PLAGE','CIEL','ROUTE','VILLE','PAIN','FROMAGE','VIN',
    'LIVRE','MUSIQUE','DANSE','CHANT','RIRE','JOIE','BONHEUR','PAIX','ESPOIR','LUMI√àRE',
    'TEMPS','HISTOIRE','M√âMOIRE','R√äVE','VOYAGE','AVENTURE','NATURE','LIBERT√â','SILENCE','PAROLE',
    'ARBRE','PIERRE','EAU','FEU','TERRE','AIR','MER','OC√âAN','LAC','SOURCE',
    'MATIN','SOIR','NUIT','JOUR','SAISON','PRINTEMPS','√âT√â','AUTOMNE','HIVER','ANN√âE',
    'FAMILLE','P√àRE','M√àRE','ENFANT','FR√àRE','S≈íUR','AMI','VOISIN','HOMME','FEMME',
    'TRAVAIL','√âCOLE','BUREAU','ATELIER','USINE','MAGASIN','MARCH√â','RESTAURANT','CAF√â','H√îTEL',
    'VOITURE','TRAIN','AVION','V√âLO','MOTO','CAMION','BUS','M√âTRO','TAXI','TRAM',
    'CHAT','CHIEN','CHEVAL','VACHE','MOUTON','POULE','COCHON','LAPIN','SOURIS','CANARD'
]);

// ===== ACHIEVEMENTS =====
const achievements = [
    { id: 'first', icon: 'üéØ', name: 'Premier mot', desc: 'Trouve ton premier mot', requirement: 1 },
    { id: 'streak5', icon: 'üî•', name: 'En feu', desc: '5 mots d\'affil√©e', requirement: 5 },
    { id: 'streak10', icon: '‚ö°', name: '√âclair', desc: '10 mots d\'affil√©e', requirement: 10 },
    { id: 'streak20', icon: 'üåü', name: '√âtoile', desc: '20 mots d\'affil√©e', requirement: 20 },
    { id: 'score50', icon: 'üèÖ', name: 'Bronze', desc: 'Score de 50', requirement: 50 },
    { id: 'score100', icon: 'ü•à', name: 'Argent', desc: 'Score de 100', requirement: 100 },
    { id: 'score200', icon: 'ü•á', name: 'Or', desc: 'Score de 200', requirement: 200 },
    { id: 'master', icon: 'üëë', name: 'Ma√Ætre', desc: 'Score de 500', requirement: 500 }
];

// ===== UTILITY FUNCTIONS =====
function generateCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
}

function getRandomSyllable(length = 2) {
    const sylls = length === 2 ? syllables2 : syllables3;
    return sylls[Math.floor(Math.random() * sylls.length)];
}

function validateWord(word, syllable, position, usedWords) {
    word = word.toUpperCase().trim();
    
    if (word.length < 3) return { valid: false, error: 'Mot trop court (min 3 lettres)' };
    if (usedWords.includes(word)) return { valid: false, error: 'Mot d√©j√† utilis√©' };
    
    const normalizedWord = word.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    const normalizedSyllable = syllable.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
    
    if (position === 'START') {
        if (!normalizedWord.startsWith(normalizedSyllable)) {
            return { valid: false, error: 'Le mot doit commencer par la syllabe' };
        }
    } else if (position === 'END') {
        if (!normalizedWord.endsWith(normalizedSyllable)) {
            return { valid: false, error: 'Le mot doit finir par la syllabe' };
        }
    } else {
        if (!normalizedWord.includes(normalizedSyllable)) {
            return { valid: false, error: 'Le mot doit contenir la syllabe' };
        }
    }
    
    return { valid: true };
}

function showNotification(title, message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const icons = {
        success: '‚úì',
        error: '‚úó',
        info: '‚Ñπ'
    };
    
    notification.innerHTML = `
        <div class="notification-icon">${icons[type]}</div>
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideInRight 0.3s reverse';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

function calculatePlayerPosition(index, total, centerX, centerY, radius) {
    // Always position current player at bottom center
    const myIndex = GameState.game.players.findIndex(p => p.id === GameState.peerId);
    const adjustedIndex = (index - myIndex + total) % total;
    
    const angle = (adjustedIndex * 2 * Math.PI / total) - Math.PI / 2;
    const x = centerX + radius * Math.cos(angle);
    const y = centerY + radius * Math.sin(angle);
    
    return { x, y };
}

// ===== EMOJI PICKER =====
function initEmojiPicker() {
    const emojiCategories = {
        'Visages': ['üòÄ','üòÅ','üòÇ','ü§£','üòÉ','üòÑ','üòÖ','üòÜ','üòâ','üòä','üòã','üòé','üòç','üòò','ü•∞','üòó','üòô','üòö','‚ò∫Ô∏è','üôÇ','ü§ó','ü§©','ü§î','ü§®','üòê','üòë','üò∂','üôÑ','üòè','üò£','üò•','üòÆ','ü§ê','üòØ','üò™','üò´','üò¥','üòå','üòõ','üòú','üòù'],
        'Animaux': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü','ü¶ó'],
        'Objets': ['‚öΩ','üèÄ','üèà','‚öæ','üéæ','üèê','üèâ','üé±','üèì','üè∏','ü•Ö','üèí','üèë','ü•ç','üèè','‚õ≥','üèπ','üé£','ü•ä','ü•ã','üéΩ','‚õ∏Ô∏è','ü•å','üéø','‚õ∑Ô∏è','üèÇ','ü™Ç','üèãÔ∏è','ü§∫','ü§∏','‚õπÔ∏è','ü§æ','üèåÔ∏è','üèá','üßò','üèÑ','üèä'],
        'Nourriture': ['üçè','üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•¨','ü•í','üå∂Ô∏è','ü´ë','üåΩ','ü•ï','ü´í','üßÑ','üßÖ','ü•î','üç†','ü•ê','ü•Ø','üçû','ü•ñ','ü•®','üßÄ']
    };
    
    const picker = document.getElementById('emojiPicker');
    picker.innerHTML = '';
    
    Object.entries(emojiCategories).forEach(([category, emojis]) => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'emoji-category';
        
        const title = document.createElement('div');
        title.className = 'emoji-category-title';
        title.textContent = category;
        categoryDiv.appendChild(title);
        
        const grid = document.createElement('div');
        grid.className = 'emoji-grid';
        
        emojis.forEach(emoji => {
            const option = document.createElement('div');
            option.className = 'emoji-option';
            option.textContent = emoji;
            option.onclick = () => {
                GameState.emoji = emoji;
                document.getElementById('emojiBtn').textContent = emoji;
                picker.classList.remove('active');
            };
            grid.appendChild(option);
        });
        
        categoryDiv.appendChild(grid);
        picker.appendChild(categoryDiv);
    });
}

// ===== THEME =====
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    GameState.theme = savedTheme;
    applyTheme(savedTheme);
}

function applyTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    document.getElementById('themeIcon').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    localStorage.setItem('theme', theme);
}

function toggleTheme() {
    GameState.theme = GameState.theme === 'dark' ? 'light' : 'dark';
    applyTheme(GameState.theme);
}

// ===== PEER CONNECTION =====
function initPeer() {
    return new Promise((resolve, reject) => {
        document.getElementById('connectionStatus').classList.remove('hidden');
        
        GameState.peer = new Peer({
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        });
        
        GameState.peer.on('open', (id) => {
            GameState.peerId = id;
            console.log('Peer ID:', id);
            document.getElementById('connectionStatus').classList.add('hidden');
            resolve(id);
        });
        
        GameState.peer.on('error', (error) => {
            console.error('Peer error:', error);
            document.getElementById('connectionStatus').classList.add('hidden');
            showNotification('Erreur de connexion', error.message, 'error');
            reject(error);
        });
        
        GameState.peer.on('connection', (conn) => {
            if (!GameState.isHost) return;
            
            setupConnection(conn);
            
            conn.on('open', () => {
                console.log('New player connected:', conn.peer);
            });
        });
    });
}

function setupConnection(conn) {
    conn.on('data', (data) => {
        handleMessage(data, conn);
    });
    
    conn.on('close', () => {
        if (GameState.isHost) {
            const playerIndex = GameState.game.players.findIndex(p => p.id === conn.peer);
            if (playerIndex !== -1) {
                const player = GameState.game.players[playerIndex];
                GameState.game.players.splice(playerIndex, 1);
                GameState.connections = GameState.connections.filter(c => c.peer !== conn.peer);
                
                addChatMessage('system', `${player.name} a quitt√© la partie`);
                broadcast({ type: 'SYNC', game: serializeGame() });
                updateLobby();
            }
        }
    });
    
    if (GameState.isHost) {
        GameState.connections.push(conn);
    } else {
        GameState.connection = conn;
    }
}

function broadcast(data) {
    if (!GameState.isHost) return;
    
    GameState.connections.forEach(conn => {
        try {
            conn.send(data);
        } catch (error) {
            console.error('Error broadcasting to', conn.peer, error);
        }
    });
}

function handleMessage(data, conn) {
    console.log('Received message:', data);
    
    switch (data.type) {
        case 'JOIN':
            if (GameState.isHost) {
                if (GameState.game.players.length >= 30) {
                    conn.send({ type: 'ERROR', message: 'Partie compl√®te (30 joueurs max)' });
                    conn.close();
                    return;
                }
                
                if (GameState.game.state !== 'WAITING') {
                    conn.send({ type: 'ERROR', message: 'Partie d√©j√† commenc√©e' });
                    conn.close();
                    return;
                }
                
                const player = {
                    id: conn.peer,
                    name: data.username,
                    emoji: data.emoji,
                    color: data.color,
                    lives: GameState.game.config.lives,
                    isHost: false,
                    out: false
                };
                
                GameState.game.players.push(player);
                
                conn.send({ type: 'JOINED', game: serializeGame() });
                
                addChatMessage('system', `${player.name} a rejoint la partie`);
                broadcast({ type: 'SYNC', game: serializeGame() });
                updateLobby();
            }
            break;
            
        case 'JOINED':
            GameState.game = deserializeGame(data.game);
            showScreen('lobby');
            updateLobby();
            break;
            
        case 'SYNC':
            GameState.game = deserializeGame(data.game);
            if (document.getElementById('lobby').classList.contains('active')) {
                updateLobby();
            } else if (document.getElementById('game').classList.contains('active')) {
                updateGame();
            }
            break;
            
        case 'START':
            GameState.game = deserializeGame(data.game);
            showScreen('game');
            updateGame();
            break;
            
        case 'WORD':
            if (GameState.isHost) {
                validateAndProcessWord(data.word, data.playerId);
            }
            break;
            
        case 'CHAT':
            addChatMessage(data.playerId, data.message, data.emoji, data.color);
            break;
            
        case 'REACTION':
            showReaction(data.playerId, data.reaction);
            break;
            
        case 'PING':
            if (GameState.isHost) {
                conn.send({ type: 'PONG', timestamp: data.timestamp });
            }
            break;
            
        case 'PONG':
            GameState.ping = Date.now() - data.timestamp;
            updatePing();
            break;
            
        case 'ERROR':
            showNotification('Erreur', data.message, 'error');
            break;
    }
}

// ===== GAME LOGIC =====
function serializeGame() {
    return {
        code: GameState.game.code,
        players: GameState.game.players,
        config: GameState.game.config,
        currentPlayer: GameState.game.currentPlayer,
        syllable: GameState.game.syllable,
        timer: GameState.game.timer,
        maxTimer: GameState.game.maxTimer,
        usedWords: GameState.game.usedWords,
        state: GameState.game.state,
        winner: GameState.game.winner
    };
}

function deserializeGame(data) {
    return {
        code: data.code,
        players: data.players,
        config: data.config,
        currentPlayer: data.currentPlayer,
        syllable: data.syllable,
        timer: data.timer,
        maxTimer: data.maxTimer,
        usedWords: data.usedWords,
        state: data.state,
        winner: data.winner,
        interval: null
    };
}

async function createGame(config) {
    if (!GameState.username || GameState.username.length < 2) {
        showNotification('Pseudo requis', 'Min. 2 caract√®res', 'error');
        return;
    }
    
    if (!GameState.peer) {
        await initPeer();
    }
    
    GameState.isHost = true;
    GameState.gameCode = generateCode();
    
    GameState.game = {
        code: GameState.gameCode,
        players: [{
            id: GameState.peerId,
            name: GameState.username,
            emoji: GameState.emoji,
            color: GameState.color,
            lives: config.lives,
            isHost: true,
            out: false
        }],
        config: config,
        currentPlayer: 0,
        syllable: '',
        timer: 0,
        maxTimer: config.initialTime,
        usedWords: [],
        state: 'WAITING',
        winner: null,
        interval: null
    };
    
    showScreen('lobby');
    updateLobby();
    startPingInterval();
}

async function joinGame(code) {
    if (!GameState.username || GameState.username.length < 2) {
        showNotification('Pseudo requis', 'Min. 2 caract√®res', 'error');
        return;
    }
    
    if (!code || code.length !== 6) {
        showNotification('Code invalide', 'Le code doit contenir 6 chiffres', 'error');
        return;
    }
    
    if (!GameState.peer) {
        await initPeer();
    }
    
    const hostPeerId = `game-${code}`;
    const conn = GameState.peer.connect(hostPeerId);
    
    setupConnection(conn);
    
    conn.on('open', () => {
        conn.send({
            type: 'JOIN',
            username: GameState.username,
            emoji: GameState.emoji,
            color: GameState.color
        });
        startPingInterval();
    });
    
    conn.on('error', (error) => {
        showNotification('Erreur', 'Impossible de rejoindre la partie', 'error');
        console.error('Connection error:', error);
    });
}

function startGame() {
    if (!GameState.isHost) return;
    if (GameState.game.players.length < 1) {
        showNotification('Pas assez de joueurs', 'Min. 1 joueur requis', 'error');
        return;
    }
    
    GameState.game.state = 'PLAYING';
    GameState.game.currentPlayer = 0;
    newRound();
    
    broadcast({ type: 'START', game: serializeGame() });
    showScreen('game');
    updateGame();
}

function newRound() {
    if (!GameState.isHost) return;
    
    GameState.game.syllable = getRandomSyllable(GameState.game.config.syllableLength);
    GameState.game.timer = GameState.game.maxTimer;
    
    if (GameState.game.interval) {
        clearInterval(GameState.game.interval);
    }
    
    GameState.game.interval = setInterval(() => {
        GameState.game.timer -= 0.1;
        
        if (GameState.game.timer <= 0) {
            playerLoseLife();
        }
        
        broadcast({ type: 'SYNC', game: serializeGame() });
        updateGame();
    }, 100);
    
    broadcast({ type: 'SYNC', game: serializeGame() });
    updateGame();
}

function validateAndProcessWord(word, playerId) {
    if (!GameState.isHost) return;
    
    const currentPlayer = GameState.game.players[GameState.game.currentPlayer];
    if (currentPlayer.id !== playerId) {
        return;
    }
    
    const validation = validateWord(
        word,
        GameState.game.syllable,
        GameState.game.config.position,
        GameState.game.usedWords
    );
    
    if (!validation.valid) {
        broadcast({
            type: 'CHAT',
            playerId: 'system',
            message: validation.error
        });
        return;
    }
    
    if (GameState.game.config.strict && !frenchWords.has(word.toUpperCase())) {
        broadcast({
            type: 'CHAT',
            playerId: 'system',
            message: 'Mot non trouv√© dans le dictionnaire'
        });
        return;
    }
    
    GameState.game.usedWords.push(word.toUpperCase());
    
    if (GameState.game.interval) {
        clearInterval(GameState.game.interval);
        GameState.game.interval = null;
    }
    
    GameState.game.maxTimer = Math.max(3, GameState.game.maxTimer * 0.95);
    
    confetti({
        particleCount: 30,
        spread: 60,
        origin: { y: 0.7 }
    });
    
    broadcast({
        type: 'CHAT',
        playerId: 'system',
        message: `‚úÖ ${currentPlayer.name} : ${word.toUpperCase()}`
    });
    
    nextPlayer();
    
    setTimeout(() => {
        newRound();
    }, 1500);
}

function playerLoseLife() {
    if (!GameState.isHost) return;
    
    const currentPlayer = GameState.game.players[GameState.game.currentPlayer];
    currentPlayer.lives--;
    
    if (currentPlayer.lives <= 0) {
        currentPlayer.out = true;
        
        broadcast({
            type: 'CHAT',
            playerId: 'system',
            message: `üí• ${currentPlayer.name} est √©limin√© !`
        });
    }
    
    const activePlayers = GameState.game.players.filter(p => !p.out);
    
    if (activePlayers.length === 1) {
        endGame(activePlayers[0]);
        return;
    }
    
    if (activePlayers.length === 0) {
        endGame(null);
        return;
    }
    
    if (GameState.game.interval) {
        clearInterval(GameState.game.interval);
        GameState.game.interval = null;
    }
    
    nextPlayer();
    
    setTimeout(() => {
        newRound();
    }, 1500);
}

function nextPlayer() {
    if (!GameState.isHost) return;
    
    let nextIndex = (GameState.game.currentPlayer + 1) % GameState.game.players.length;
    let attempts = 0;
    
    while (GameState.game.players[nextIndex].out && attempts < GameState.game.players.length) {
        nextIndex = (nextIndex + 1) % GameState.game.players.length;
        attempts++;
    }
    
    GameState.game.currentPlayer = nextIndex;
    broadcast({ type: 'SYNC', game: serializeGame() });
}

function endGame(winner) {
    if (!GameState.isHost) return;
    
    GameState.game.state = 'ENDED';
    GameState.game.winner = winner;
    
    if (GameState.game.interval) {
        clearInterval(GameState.game.interval);
        GameState.game.interval = null;
    }
    
    broadcast({ type: 'SYNC', game: serializeGame() });
    
    if (winner) {
        document.getElementById('victoryWinner').textContent = `${winner.emoji} ${winner.name}`;
    } else {
        document.getElementById('victoryWinner').textContent = 'Match nul !';
    }
    
    document.getElementById('victoryOverlay').classList.add('active');
    
    confetti({
        particleCount: 150,
        spread: 100,
        origin: { y: 0.6 }
    });
}

// ===== SOLO MODE =====
function startSoloMode() {
    if (!GameState.username || GameState.username.length < 2) {
        showNotification('Pseudo requis', 'Min. 2 caract√®res', 'error');
        return;
    }
    
    GameState.solo = {
        score: 0,
        streak: 0,
        bestStreak: 0,
        syllable: '',
        timer: 0,
        maxTimer: 15,
        usedWords: [],
        interval: null,
        achievements: []
    };
    
    showScreen('solo');
    renderAchievements();
    newSoloRound();
}

function newSoloRound() {
    GameState.solo.syllable = getRandomSyllable(2);
    GameState.solo.timer = GameState.solo.maxTimer;
    
    document.getElementById('soloSyllable').textContent = GameState.solo.syllable;
    document.getElementById('soloWordInput').value = '';
    document.getElementById('soloWordInput').focus();
    
    if (GameState.solo.interval) {
        clearInterval(GameState.solo.interval);
    }
    
    GameState.solo.interval = setInterval(() => {
        GameState.solo.timer -= 0.1;
        updateSoloTimer();
        
        if (GameState.solo.timer <= 0) {
            soloGameOver();
        }
    }, 100);
    
    updateSoloTimer();
}

function submitSoloWord() {
    const input = document.getElementById('soloWordInput');
    const word = input.value.trim().toUpperCase();
    
    if (!word) return;
    
    const validation = validateWord(word, GameState.solo.syllable, 'ANY', GameState.solo.usedWords);
    
    if (!validation.valid) {
        showNotification('Erreur', validation.error, 'error');
        GameState.solo.streak = 0;
        updateSoloStreak();
        return;
    }
    
    GameState.solo.usedWords.push(word);
    GameState.solo.score++;
    GameState.solo.streak++;
    
    if (GameState.solo.streak > GameState.solo.bestStreak) {
        GameState.solo.bestStreak = GameState.solo.streak;
    }
    
    GameState.solo.maxTimer = Math.max(3, GameState.solo.maxTimer * 0.97);
    
    updateSoloScore();
    updateSoloStreak();
    checkAchievements();
    
    confetti({
        particleCount: 20,
        spread: 50,
        origin: { y: 0.6 }
    });
    
    if (GameState.solo.interval) {
        clearInterval(GameState.solo.interval);
    }
    
    setTimeout(() => {
        newSoloRound();
    }, 500);
}

function soloGameOver() {
    if (GameState.solo.interval) {
        clearInterval(GameState.solo.interval);
        GameState.solo.interval = null;
    }
    
    showNotification('Temps √©coul√© !', `Score final : ${GameState.solo.score}`, 'info');
    GameState.solo.streak = 0;
    updateSoloStreak();
}

function updateSoloScore() {
    document.getElementById('soloScore').textContent = GameState.solo.score;
}

function updateSoloStreak() {
    const streakFire = document.querySelector('#soloStreak .streak-fire');
    const streakText = document.getElementById('streakText');
    
    if (GameState.solo.streak >= 5) {
        streakFire.classList.remove('hidden');
        streakText.textContent = `${GameState.solo.streak} mots d'affil√©e !`;
    } else if (GameState.solo.streak > 0) {
        streakFire.classList.add('hidden');
        streakText.textContent = `${GameState.solo.streak} mot${GameState.solo.streak > 1 ? 's' : ''}`;
    } else {
        streakFire.classList.add('hidden');
        streakText.textContent = 'Nouvelle s√©rie !';
    }
}

function updateSoloTimer() {
    const percent = (GameState.solo.timer / GameState.solo.maxTimer) * 100;
    document.getElementById('soloTimerFill').style.width = percent + '%';
    document.getElementById('soloTimerText').textContent = GameState.solo.timer.toFixed(1) + 's';
}

function renderAchievements() {
    const grid = document.getElementById('achievementsGrid');
    grid.innerHTML = '';
    
    achievements.forEach(achievement => {
        const div = document.createElement('div');
        div.className = 'achievement';
        
        const isUnlocked = GameState.solo.achievements.includes(achievement.id);
        if (isUnlocked) {
            div.classList.add('unlocked');
        }
        
        div.innerHTML = `
            <div class="achievement-icon">${achievement.icon}</div>
            <div class="achievement-name">${achievement.name}</div>
            <div class="achievement-desc">${achievement.desc}</div>
        `;
        
        grid.appendChild(div);
    });
}

function checkAchievements() {
    achievements.forEach(achievement => {
        if (GameState.solo.achievements.includes(achievement.id)) return;
        
        let unlock = false;
        
        if (achievement.id === 'first' && GameState.solo.score >= 1) unlock = true;
        if (achievement.id === 'streak5' && GameState.solo.streak >= 5) unlock = true;
        if (achievement.id === 'streak10' && GameState.solo.streak >= 10) unlock = true;
        if (achievement.id === 'streak20' && GameState.solo.streak >= 20) unlock = true;
        if (achievement.id === 'score50' && GameState.solo.score >= 50) unlock = true;
        if (achievement.id === 'score100' && GameState.solo.score >= 100) unlock = true;
        if (achievement.id === 'score200' && GameState.solo.score >= 200) unlock = true;
        if (achievement.id === 'master' && GameState.solo.score >= 500) unlock = true;
        
        if (unlock) {
            GameState.solo.achievements.push(achievement.id);
            showNotification('Succ√®s d√©bloqu√© !', `${achievement.icon} ${achievement.name}`, 'success');
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            renderAchievements();
        }
    });
}

// ===== UI UPDATES =====
function updateLobby() {
    document.getElementById('lobbyCode').textContent = GameState.game.code;
    document.getElementById('playersCount').textContent = `${GameState.game.players.length}/30`;
    
    const grid = document.getElementById('playersGrid');
    grid.innerHTML = '';
    
    GameState.game.players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'player-card';
        if (player.id === GameState.peerId) {
            div.classList.add('me');
        }
        
        div.innerHTML = `
            <div class="player-avatar" style="background-color: ${player.color};">
                ${player.emoji}
            </div>
            <div class="player-info">
                <div class="player-name">${player.name}</div>
                ${player.isHost ? '<span class="player-badge">H√¥te</span>' : ''}
            </div>
        `;
        
        grid.appendChild(div);
    });
    
    const startBtn = document.getElementById('startGameBtn');
    if (GameState.isHost) {
        startBtn.disabled = GameState.game.players.length < 1;
    } else {
        startBtn.style.display = 'none';
    }
}

function updateGame() {
    document.getElementById('gameCode').textContent = GameState.game.code;
    document.getElementById('gamePlayers').textContent = GameState.game.players.filter(p => !p.out).length;
    document.getElementById('gameWords').textContent = GameState.game.usedWords.length;
    document.getElementById('syllableText').textContent = GameState.game.syllable || '...';
    
    const percent = (GameState.game.timer / GameState.game.maxTimer) * 100;
    document.getElementById('timerFill').style.width = percent + '%';
    document.getElementById('timerText').textContent = GameState.game.timer.toFixed(1) + 's';
    
    const bomb = document.getElementById('bombIcon');
    if (GameState.game.timer < 5) {
        bomb.classList.add('critical');
    } else {
        bomb.classList.remove('critical');
    }
    
    updatePlayersCircle();
    updateUsedWords();
    updateInputArea();
}

function updatePlayersCircle() {
    const circle = document.getElementById('playersCircle');
    const existingPlayers = circle.querySelectorAll('.game-player');
    existingPlayers.forEach(p => p.remove());
    
    const rect = circle.getBoundingClientRect();
    const centerX = rect.width / 2;
    const centerY = rect.height / 2;
    const radius = Math.min(centerX, centerY) * 0.7;
    
    GameState.game.players.forEach((player, index) => {
        const pos = calculatePlayerPosition(index, GameState.game.players.length, centerX, centerY, radius);
        
        const div = document.createElement('div');
        div.className = 'game-player';
        if (index === GameState.game.currentPlayer && GameState.game.state === 'PLAYING') {
            div.classList.add('active');
        }
        if (player.id === GameState.peerId) {
            div.classList.add('me');
        }
        if (player.out) {
            div.classList.add('out');
        }
        
        div.style.left = pos.x + 'px';
        div.style.top = pos.y + 'px';
        div.style.transform = 'translate(-50%, -50%)';
        
        div.innerHTML = `
            ${index === GameState.game.currentPlayer && GameState.game.state === 'PLAYING' ? '<div class="player-arrow">üëá</div>' : ''}
            <div class="game-player-avatar" style="background-color: ${player.color};">
                ${player.emoji}
            </div>
            <div class="game-player-name">${player.name}</div>
            <div class="game-player-lives">${'‚ù§Ô∏è'.repeat(player.lives)}</div>
        `;
        
        circle.appendChild(div);
    });
}

function updateUsedWords() {
    const list = document.getElementById('usedWordsList');
    list.innerHTML = '';
    
    const recentWords = GameState.game.usedWords.slice().reverse().slice(0, 20);
    recentWords.forEach(word => {
        const div = document.createElement('div');
        div.className = 'used-word';
        div.textContent = word;
        list.appendChild(div);
    });
}

function updateInputArea() {
    const inputArea = document.getElementById('gameInputArea');
    const statusText = document.getElementById('gameStatusText');
    const wordInput = document.getElementById('wordInput');
    
    const currentPlayer = GameState.game.players[GameState.game.currentPlayer];
    const isMyTurn = currentPlayer && currentPlayer.id === GameState.peerId && GameState.game.state === 'PLAYING';
    
    if (isMyTurn) {
        inputArea.classList.remove('hidden');
        statusText.classList.add('hidden');
        wordInput.focus();
    } else {
        inputArea.classList.add('hidden');
        statusText.classList.remove('hidden');
        
        if (GameState.game.state === 'ENDED') {
            statusText.textContent = 'üèÜ Partie termin√©e !';
        } else if (GameState.game.state === 'PLAYING' && currentPlayer) {
            statusText.textContent = `Tour de ${currentPlayer.name}...`;
        } else {
            statusText.textContent = 'En attente...';
        }
    }
}

function updatePing() {
    const pingDisplay = document.getElementById('lobbyPing');
    if (pingDisplay) {
        pingDisplay.textContent = GameState.ping + 'ms';
    }
}

// ===== CHAT =====
function addChatMessage(playerId, message, emoji = null, color = null) {
    const messages = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = 'chat-message';
    
    if (playerId === 'system') {
        div.classList.add('system');
        div.innerHTML = `
            <div class="chat-message-text">${message}</div>
        `;
    } else {
        const player = GameState.game.players.find(p => p.id === playerId);
        const playerEmoji = player ? player.emoji : emoji || 'üë§';
        const playerColor = player ? player.color : color || '#3b82f6';
        const playerName = player ? player.name : 'Inconnu';
        
        div.innerHTML = `
            <div class="chat-message-avatar" style="background-color: ${playerColor};">
                ${playerEmoji}
            </div>
            <div class="chat-message-content">
                <div class="chat-message-name">${playerName}</div>
                <div class="chat-message-text">${message}</div>
            </div>
        `;
    }
    
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
    
    if (!document.getElementById('chatPanel').classList.contains('active')) {
        GameState.chat.unread++;
        updateChatBadge();
    }
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    const data = {
        type: 'CHAT',
        playerId: GameState.peerId,
        message: message,
        emoji: GameState.emoji,
        color: GameState.color
    };
    
    if (GameState.isHost) {
        addChatMessage(GameState.peerId, message, GameState.emoji, GameState.color);
        broadcast(data);
    } else if (GameState.connection) {
        GameState.connection.send(data);
        addChatMessage(GameState.peerId, message, GameState.emoji, GameState.color);
    }
    
    input.value = '';
}

function sendReaction(reaction) {
    const data = {
        type: 'REACTION',
        playerId: GameState.peerId,
        reaction: reaction
    };
    
    if (GameState.isHost) {
        showReaction(GameState.peerId, reaction);
        broadcast(data);
    } else if (GameState.connection) {
        GameState.connection.send(data);
        showReaction(GameState.peerId, reaction);
    }
}

function showReaction(playerId, reaction) {
    addChatMessage(playerId, reaction, null, null);
}

function updateChatBadge() {
    const badge = document.getElementById('chatBadge');
    if (GameState.chat.unread > 0) {
        badge.textContent = GameState.chat.unread;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
}

function toggleChat() {
    const panel = document.getElementById('chatPanel');
    panel.classList.toggle('active');
    
    if (panel.classList.contains('active')) {
        GameState.chat.unread = 0;
        updateChatBadge();
        document.getElementById('chatInput').focus();
    }
}

// ===== PING MONITORING =====
function startPingInterval() {
    setInterval(() => {
        if (GameState.connection && !GameState.isHost) {
            GameState.lastPingTime = Date.now();
            GameState.connection.send({ type: 'PING', timestamp: GameState.lastPingTime });
        }
    }, 5000);
}

// ===== EVENT LISTENERS =====
document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    initEmojiPicker();
    
    // Theme
    document.getElementById('themeToggle').onclick = toggleTheme;
    
    // Username
    document.getElementById('usernameInput').oninput = (e) => {
        GameState.username = e.target.value;
    };
    
    // Color
    document.getElementById('colorPicker').onchange = (e) => {
        GameState.color = e.target.value;
    };
    
    // Emoji
    document.getElementById('emojiBtn').onclick = () => {
        document.getElementById('emojiPicker').classList.toggle('active');
    };
    
    document.onclick = (e) => {
        const picker = document.getElementById('emojiPicker');
        const btn = document.getElementById('emojiBtn');
        if (!picker.contains(e.target) && e.target !== btn) {
            picker.classList.remove('active');
        }
    };
    
    // Home actions
    document.getElementById('soloBtn').onclick = startSoloMode;
    
    document.getElementById('createBtn').onclick = () => {
        document.getElementById('createModal').classList.add('active');
    };
    
    document.getElementById('joinBtn').onclick = () => {
        document.getElementById('joinModal').classList.add('active');
    };
    
    document.getElementById('rulesBtn').onclick = () => {
        document.getElementById('rulesModal').classList.add('active');
    };
    
    // Create modal
    document.getElementById('closeCreateModal').onclick = () => {
        document.getElementById('createModal').classList.remove('active');
    };
    
    document.getElementById('livesRange').oninput = (e) => {
        document.getElementById('livesValue').textContent = e.target.value;
    };
    
    document.getElementById('timeRange').oninput = (e) => {
        document.getElementById('timeValue').textContent = e.target.value + 's';
    };
    
    document.getElementById('confirmCreate').onclick = () => {
        const config = {
            lives: parseInt(document.getElementById('livesRange').value),
            initialTime: parseInt(document.getElementById('timeRange').value),
            position: document.querySelector('input[name="position"]:checked').value,
            syllableLength: parseInt(document.querySelector('input[name="sylLength"]:checked').value),
            strict: document.getElementById('strictMode').checked
        };
        
        document.getElementById('createModal').classList.remove('active');
        createGame(config);
    };
    
    // Join modal
    document.getElementById('closeJoinModal').onclick = () => {
        document.getElementById('joinModal').classList.remove('active');
    };
    
    document.getElementById('joinCodeInput').oninput = (e) => {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
    };
    
    document.getElementById('confirmJoin').onclick = () => {
        const code = document.getElementById('joinCodeInput').value;
        document.getElementById('joinModal').classList.remove('active');
        joinGame(code);
    };
    
    // Rules modal
    document.getElementById('closeRulesModal').onclick = () => {
        document.getElementById('rulesModal').classList.remove('active');
    };
    
    document.getElementById('closeRulesBtn').onclick = () => {
        document.getElementById('rulesModal').classList.remove('active');
    };
    
    // Lobby
    document.getElementById('copyCodeBtn').onclick = () => {
        navigator.clipboard.writeText(GameState.game.code);
        showNotification('Code copi√© !', 'Le code a √©t√© copi√© dans le presse-papier', 'success');
    };
    
    document.getElementById('leaveLobbyBtn').onclick = () => {
        if (GameState.isHost) {
            broadcast({ type: 'CHAT', playerId: 'system', message: 'L\'h√¥te a quitt√© la partie' });
            GameState.connections.forEach(conn => conn.close());
        } else if (GameState.connection) {
            GameState.connection.close();
        }
        
        showScreen('home');
    };
    
    document.getElementById('startGameBtn').onclick = startGame;
    
    // Game
    document.getElementById('wordInput').onkeypress = (e) => {
        if (e.key === 'Enter') {
            submitWord();
        }
    };
    
    document.getElementById('submitWordBtn').onclick = submitWord;
    
    document.getElementById('leaveGameBtn').onclick = () => {
        if (confirm('√ätes-vous s√ªr de vouloir quitter la partie ?')) {
            if (GameState.isHost) {
                broadcast({ type: 'CHAT', playerId: 'system', message: 'L\'h√¥te a quitt√© la partie' });
                GameState.connections.forEach(conn => conn.close());
            } else if (GameState.connection) {
                GameState.connection.close();
            }
            
            if (GameState.game.interval) {
                clearInterval(GameState.game.interval);
            }
            
            showScreen('home');
        }
    };
    
    // Solo
    document.getElementById('soloWordInput').onkeypress = (e) => {
        if (e.key === 'Enter') {
            submitSoloWord();
        }
    };
    
    document.getElementById('soloSubmitBtn').onclick = submitSoloWord;
    
    document.getElementById('quitSoloBtn').onclick = () => {
        if (GameState.solo.interval) {
            clearInterval(GameState.solo.interval);
        }
        showScreen('home');
    };
    
    // Victory
    document.getElementById('victoryHomeBtn').onclick = () => {
        document.getElementById('victoryOverlay').classList.remove('active');
        showScreen('home');
    };
    
    document.getElementById('victoryRestartBtn').onclick = () => {
        document.getElementById('victoryOverlay').classList.remove('active');
        
        if (GameState.isHost) {
            GameState.game.state = 'WAITING';
            GameState.game.players.forEach(p => {
                p.lives = GameState.game.config.lives;
                p.out = false;
            });
            GameState.game.usedWords = [];
            GameState.game.currentPlayer = 0;
            GameState.game.winner = null;
            
            broadcast({ type: 'SYNC', game: serializeGame() });
            showScreen('lobby');
            updateLobby();
        }
    };
    
    // Chat
    document.getElementById('chatToggle').onclick = toggleChat;
    document.getElementById('chatClose').onclick = toggleChat;
    
    document.getElementById('chatInput').onkeypress = (e) => {
        if (e.key === 'Enter') {
            sendChatMessage();
        }
    };
    
    document.getElementById('chatSend').onclick = sendChatMessage;
    
    document.querySelectorAll('.reaction-btn').forEach(btn => {
        btn.onclick = () => {
            sendReaction(btn.dataset.reaction);
        };
    });
    
    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        };
    });
});

function submitWord() {
    const input = document.getElementById('wordInput');
    const word = input.value.trim().toUpperCase();
    
    if (!word) return;
    
    if (GameState.isHost) {
        validateAndProcessWord(word, GameState.peerId);
    } else if (GameState.connection) {
        GameState.connection.send({
            type: 'WORD',
            playerId: GameState.peerId,
            word: word
        });
    }
    
    input.value = '';
}

// ===== WINDOW EVENTS =====
window.addEventListener('beforeunload', (e) => {
    if (GameState.game.state === 'PLAYING') {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Initialize peer on load
window.addEventListener('load', () => {
    setTimeout(() => {
        initPeer().catch(error => {
            console.error('Failed to initialize peer:', error);
        });
    }, 1000);
});
</script>

</body>
</html>
