<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí£ Tic Tac Boom - Jeu Multijoueur</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Outfit:wght@700;800;900&display=swap" rel="stylesheet">

    <style>
:root {
    --bg: #0a0c14;
    --bg-elevated: #121420;
    --bg-card: #181b28;
    --primary: #00c9ff;
    --primary-dark: #0099cc;
    --secondary: #92fe9d;
    --accent: #ff3d71;
    --text: #e8ecf5;
    --text-dim: #8a92a6;
    --border: rgba(255, 255, 255, 0.06);
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 30%, rgba(0, 201, 255, 0.03), transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(146, 254, 157, 0.03), transparent 50%);
    pointer-events: none;
    z-index: 0;
}

.container {
    position: relative;
    z-index: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

h1, h2, h3 {
    font-family: 'Outfit', sans-serif;
}

.btn {
    padding: 12px 28px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    box-shadow: 0 4px 15px rgba(0, 201, 255, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 201, 255, 0.4);
}

.btn-secondary {
    background: var(--bg-card);
    color: var(--text);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    border-color: var(--primary);
}

.btn-danger {
    background: var(--accent);
    color: white;
}

.input {
    width: 100%;
    padding: 14px 18px;
    font-size: 15px;
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: inherit;
    transition: all 0.2s;
}

.input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 201, 255, 0.1);
}

.card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    box-shadow: var(--shadow);
}

.screen {
    display: none;
    min-height: 100vh;
}

.screen.active {
    display: block;
}

/* Home */
#home {
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 40px 20px;
}

.home-content {
    max-width: 600px;
}

.title {
    font-size: 64px;
    margin-bottom: 16px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.subtitle {
    font-size: 20px;
    color: var(--text-dim);
    margin-bottom: 40px;
}

.actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 32px;
}

.username-box {
    background: var(--bg-elevated);
    padding: 24px;
    border-radius: 16px;
    margin-bottom: 32px;
}

.status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    margin-top: 16px;
}

.status.loading {
    background: rgba(251, 191, 36, 0.1);
    color: #fbbf24;
}

.status.ready {
    background: rgba(146, 254, 157, 0.1);
    color: var(--secondary);
}

.spinner {
    width: 14px;
    height: 14px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Config */
#config .config-wrap {
    max-width: 900px;
    margin: 40px auto;
}

.config-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.option {
    margin-bottom: 20px;
}

.option label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-dim);
    margin-bottom: 8px;
}

.range-group {
    display: flex;
    align-items: center;
    gap: 12px;
}

.range {
    flex: 1;
    height: 6px;
    -webkit-appearance: none;
    background: var(--bg-elevated);
    border-radius: 3px;
}

.range::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px;
    height: 18px;
    background: var(--primary);
    border-radius: 50%;
    cursor: pointer;
}

.range-val {
    min-width: 40px;
    padding: 4px 12px;
    background: var(--primary);
    color: white;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    text-align: center;
}

.radio-group {
    display: flex;
    gap: 12px;
}

.radio-btn input {
    display: none;
}

.radio-btn label {
    display: block;
    padding: 10px 16px;
    background: var(--bg-elevated);
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.radio-btn input:checked + label {
    background: rgba(0, 201, 255, 0.1);
    border-color: var(--primary);
    color: var(--primary);
}

.code-big {
    font-size: 40px;
    font-family: 'Outfit', monospace;
    letter-spacing: 6px;
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, rgba(0, 201, 255, 0.1), rgba(146, 254, 157, 0.1));
    border: 2px solid var(--primary);
    border-radius: 12px;
    margin-bottom: 16px;
}

/* Lobby */
.lobby-wrap {
    max-width: 900px;
    margin: 40px auto;
    text-align: center;
}

.lobby-code {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 16px 32px;
    background: var(--bg-card);
    border: 2px solid var(--primary);
    border-radius: 12px;
    font-size: 28px;
    font-family: 'Outfit', monospace;
    letter-spacing: 4px;
    margin: 20px 0;
}

.players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 16px;
    margin: 24px 0;
}

.player {
    background: var(--bg-card);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    animation: pop 0.3s ease-out;
}

@keyframes pop {
    from { transform: scale(0.9); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
}

.player.host {
    border-color: var(--primary);
}

.player-avatar {
    font-size: 40px;
    margin-bottom: 8px;
}

.player-name {
    font-weight: 600;
    word-break: break-word;
}

.badge {
    display: inline-block;
    padding: 2px 8px;
    background: var(--primary);
    color: white;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    margin-top: 4px;
}

/* Game */
#game .game-wrap {
    height: calc(100vh - 80px);
    display: flex;
    flex-direction: column;
    padding: 20px;
}

.game-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-card);
    border-radius: 12px;
    padding: 16px 24px;
    margin-bottom: 20px;
}

.stats {
    display: flex;
    gap: 24px;
}

.stat {
    display: flex;
    flex-direction: column;
}

.stat-label {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 20px;
    font-weight: 700;
    font-family: 'Outfit', sans-serif;
}

.game-content {
    flex: 1;
    display: grid;
    grid-template-columns: 220px 1fr 220px;
    gap: 20px;
    min-height: 0;
}

.sidebar {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 16px;
    overflow-y: auto;
}

.sidebar-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
}

.game-players .player {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: var(--bg-elevated);
    border: 2px solid var(--border);
    border-radius: 10px;
    margin-bottom: 10px;
    position: relative;
}

.game-players .player.active {
    border-color: var(--primary);
    box-shadow: 0 0 20px rgba(0, 201, 255, 0.2);
}

.game-players .player.out {
    opacity: 0.3;
    filter: grayscale(1);
}

.arrow {
    position: absolute;
    left: -25px;
    font-size: 20px;
    animation: bounce 0.6s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(-5px); }
}

.arena {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 30px;
    background: var(--bg-card);
    border-radius: 16px;
    padding: 40px;
}

.bomb-wrap {
    text-align: center;
}

.bomb {
    font-size: 100px;
    display: block;
    margin-bottom: 20px;
    animation: float 2s ease-in-out infinite;
}

.bomb.critical {
    animation: shake 0.2s infinite, glow 0.5s infinite alternate;
}

@keyframes shake {
    0%, 100% { transform: translate(0, 0); }
    25% { transform: translate(-3px, 0); }
    75% { transform: translate(3px, 0); }
}

@keyframes glow {
    from { filter: drop-shadow(0 0 10px rgba(255, 61, 113, 0.5)); }
    to { filter: drop-shadow(0 0 30px rgba(255, 61, 113, 0.8)); }
}

.syllable {
    font-size: 56px;
    font-weight: 800;
    font-family: 'Outfit', sans-serif;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 6px;
}

.timer-wrap {
    width: 100%;
    max-width: 400px;
}

.timer-bar {
    height: 10px;
    background: var(--bg-elevated);
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 8px;
}

.timer-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--secondary), var(--primary), var(--accent));
    border-radius: 10px;
    transition: width 0.1s linear;
}

.timer-text {
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    font-family: 'Outfit', monospace;
}

.input-area {
    width: 100%;
    max-width: 500px;
}

.input-area.hide {
    display: none;
}

.turn-msg {
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 16px;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.input-group {
    display: flex;
    gap: 12px;
}

.status-msg {
    text-align: center;
    font-size: 15px;
    color: var(--text-dim);
}

.words-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.word {
    padding: 5px 10px;
    background: var(--bg-elevated);
    border-radius: 6px;
    font-size: 13px;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    max-width: 450px;
    width: 100%;
    animation: slideUp 0.3s;
}

@keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.modal-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-elevated);
    border: none;
    border-radius: 8px;
    color: var(--text-dim);
    font-size: 20px;
    cursor: pointer;
}

/* Victory */
.victory {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.victory.active {
    display: flex;
}

.victory-content {
    text-align: center;
    max-width: 600px;
}

.victory-icon {
    font-size: 100px;
    margin-bottom: 20px;
    animation: rotate 2s ease-in-out infinite;
}

@keyframes rotate {
    0%, 100% { transform: rotate(-5deg); }
    50% { transform: rotate(5deg); }
}

.victory-title {
    font-size: 44px;
    margin-bottom: 16px;
}

.victory-winner {
    font-size: 28px;
    color: var(--text-dim);
    margin-bottom: 40px;
}

/* Notif */
.notif {
    position: fixed;
    top: 20px;
    right: 20px;
    max-width: 380px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
    display: flex;
    gap: 12px;
    animation: slideIn 0.3s;
    z-index: 1500;
}

@keyframes slideIn {
    from { transform: translateX(100px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.notif-icon {
    font-size: 20px;
}

.notif-content {
    flex: 1;
}

.notif-title {
    font-weight: 600;
    margin-bottom: 4px;
}

.notif-msg {
    font-size: 14px;
    color: var(--text-dim);
}

.notif.success { border-left: 4px solid var(--secondary); }
.notif.error { border-left: 4px solid var(--accent); }
.notif.info { border-left: 4px solid var(--primary); }

/* Responsive */
@media (max-width: 1024px) {
    .config-grid {
        grid-template-columns: 1fr;
    }
    
    .game-content {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        max-height: 200px;
    }
}

@media (max-width: 768px) {
    .title {
        font-size: 44px;
    }
    
    .actions {
        grid-template-columns: 1fr;
    }
    
    .players-grid {
        grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    }
    
    .code-big {
        font-size: 28px;
    }
    
    .bomb {
        font-size: 70px;
    }
    
    .syllable {
        font-size: 40px;
    }
}

.hide {
    display: none !important;
}

.mb-4 {
    margin-bottom: 16px;
}

.mt-4 {
    margin-top: 16px;
}

.text-center {
    text-align: center;
}

.flex {
    display: flex;
}

.gap-4 {
    gap: 16px;
}
    </style>
</head>
<body>

<div id="home" class="screen active">
    <div class="home-content">
        <h1 class="title">üí£ Tic Tac Boom</h1>
        <p class="subtitle">Jeu de mots explosif multijoueur</p>
        
        <div class="username-box">
            <label style="display: block; margin-bottom: 12px; font-weight: 500;">Votre pseudo</label>
            <input type="text" id="username" class="input" placeholder="Entrez votre pseudo..." maxlength="15">
            <div class="text-center mt-4">
                <span id="dict-status" class="status loading">
                    <span class="spinner"></span>
                    <span>Chargement...</span>
                </span>
            </div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="Game.showCreate()">
                <span>üéÆ Cr√©er</span>
            </button>
            <button class="btn btn-secondary" onclick="Game.showJoin()">
                <span>üö™ Rejoindre</span>
            </button>
        </div>
        
        <p style="font-size: 14px; color: var(--text-dim);">
            Jusqu'√† 30 joueurs ‚Ä¢ Trouvez des mots avant l'explosion !
        </p>
    </div>
</div>

<div id="config" class="screen">
    <div class="container">
        <div class="config-wrap">
            <div class="card mb-4">
                <h2 style="margin-bottom: 8px;">Configuration de la Partie</h2>
                <p style="color: var(--text-dim); font-size: 14px;">Personnalisez votre jeu</p>
            </div>
            
            <div class="config-grid">
                <div class="card">
                    <h3 style="margin-bottom: 20px; font-size: 18px;">‚öôÔ∏è Param√®tres</h3>
                    
                    <div class="option">
                        <label>Vies par joueur</label>
                        <div class="range-group">
                            <input type="range" class="range" id="lives" min="1" max="5" value="3" oninput="Game.updateRange('lives')">
                            <span class="range-val" id="lives-val">3</span>
                        </div>
                    </div>
                    
                    <div class="option">
                        <label>Temps initial (secondes)</label>
                        <div class="range-group">
                            <input type="range" class="range" id="timer" min="5" max="30" value="15" oninput="Game.updateRange('timer')">
                            <span class="range-val" id="timer-val">15</span>
                        </div>
                    </div>
                    
                    <div class="option">
                        <label>Difficult√©</label>
                        <div class="radio-group">
                            <div class="radio-btn">
                                <input type="radio" id="easy" name="diff" value="easy">
                                <label for="easy">üòä Facile</label>
                            </div>
                            <div class="radio-btn">
                                <input type="radio" id="medium" name="diff" value="medium" checked>
                                <label for="medium">üòê Moyen</label>
                            </div>
                            <div class="radio-btn">
                                <input type="radio" id="hard" name="diff" value="hard">
                                <label for="hard">üòà Dur</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="card mb-4">
                        <h3 style="margin-bottom: 16px; font-size: 18px;">üîë Code</h3>
                        <div class="code-big" id="config-code">XXXX</div>
                        <button class="btn btn-secondary" style="width: 100%;" onclick="Game.copyCode()">
                            üìã Copier
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 12px; font-size: 18px;">
                            üë• Joueurs (<span id="config-count">1</span>/30)
                        </h3>
                        <div id="config-players"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-4" style="justify-content: center;">
                <button class="btn btn-primary" id="start-btn" onclick="Game.start()" disabled>
                    üöÄ Lancer
                </button>
                <button class="btn btn-danger" onclick="Game.cancel()">
                    ‚ùå Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<div id="lobby" class="screen">
    <div class="container">
        <div class="lobby-wrap">
            <h2 class="mb-4">Salon d'Attente</h2>
            <div class="lobby-code" id="lobby-code">XXXX</div>
            <p style="color: var(--text-dim); margin-bottom: 24px;">
                En attente du d√©marrage...
            </p>
            
            <div class="card mb-4">
                <h3 class="mb-4">
                    Joueurs (<span id="lobby-count">0</span>/30)
                </h3>
                <div class="players-grid" id="lobby-players"></div>
            </div>
            
            <button class="btn btn-danger" onclick="Game.leave()">
                Quitter
            </button>
        </div>
    </div>
</div>

<div id="game" class="screen">
    <div class="game-wrap">
        <div class="game-header">
            <div class="stats">
                <div class="stat">
                    <span class="stat-label">Code</span>
                    <span class="stat-value" id="game-code">XXXX</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Joueurs</span>
                    <span class="stat-value" id="game-count">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Mots</span>
                    <span class="stat-value" id="game-words">0</span>
                </div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="Game.leave()">Quitter</button>
        </div>
        
        <div class="game-content">
            <div class="sidebar">
                <h4 class="sidebar-title">Joueurs</h4>
                <div id="game-players" class="game-players"></div>
            </div>
            
            <div class="arena">
                <div class="bomb-wrap">
                    <span class="bomb" id="bomb">üí£</span>
                    <div class="syllable" id="syl">...</div>
                </div>
                
                <div class="timer-wrap">
                    <div class="timer-bar">
                        <div class="timer-fill" id="timer-fill"></div>
                    </div>
                    <div class="timer-text" id="timer-text">0.0s</div>
                </div>
                
                <div class="input-area hide" id="input-area">
                    <div class="turn-msg">üî• √Ä VOUS ! üî•</div>
                    <div class="input-group">
                        <input type="text" id="word" class="input" placeholder="Votre mot..." style="text-transform: uppercase;">
                        <button class="btn btn-primary" onclick="Game.submit()">‚úì</button>
                    </div>
                </div>
                
                <div class="status-msg" id="game-status">En attente...</div>
            </div>
            
            <div class="sidebar">
                <h4 class="sidebar-title">Mots</h4>
                <div class="words-wrap" id="used-words"></div>
            </div>
        </div>
    </div>
</div>

<div id="join-modal" class="modal">
    <div class="modal-content card">
        <div class="modal-header">
            <h3>Rejoindre</h3>
            <button class="modal-close" onclick="Game.closeJoin()">√ó</button>
        </div>
        <div class="mb-4">
            <label style="display: block; margin-bottom: 8px; font-size: 14px;">Code du salon</label>
            <input type="text" id="join-code" class="input" placeholder="Ex: ABCD" maxlength="4" style="text-transform: uppercase;">
        </div>
        <button class="btn btn-primary" style="width: 100%;" onclick="Game.join()">
            Rejoindre
        </button>
    </div>
</div>

<div id="victory" class="victory">
    <div class="victory-content">
        <div class="victory-icon">üèÜ</div>
        <h2 class="victory-title">VICTOIRE !</h2>
        <p class="victory-winner" id="winner">Gagnant</p>
        <button class="btn btn-primary" onclick="Game.home()">
            Retour
        </button>
    </div>
</div>

<script>
const Game = {
    state: {
        user: '',
        peer: null,
        id: null,
        host: false,
        code: '',
        conn: null,
        game: null,
        dict: new Set()
    },
    
    syl: {
        easy: ['BA', 'BE', 'BI', 'BO', 'BU', 'CA', 'CO', 'DA', 'DE', 'DI', 'DO', 'FA', 'FE', 'FI', 'FO', 'GA', 'GO', 'LA', 'LE', 'LI', 'LO', 'MA', 'ME', 'MI', 'MO', 'NA', 'NE', 'NI', 'NO', 'PA', 'PE', 'PI', 'PO', 'RA', 'RE', 'RI', 'RO', 'SA', 'SE', 'SI', 'SO', 'TA', 'TE', 'TI', 'TO', 'VA', 'VE', 'VI', 'VO'],
        medium: ['AN', 'EN', 'IN', 'ON', 'UN', 'OU', 'OI', 'AI', 'AU', 'EU', 'IL', 'AR', 'ER', 'IR', 'OR', 'UR', 'CH', 'PH', 'QU', 'TR', 'BR', 'CR', 'DR', 'FR', 'GR', 'PR', 'BL', 'CL', 'FL', 'GL', 'PL'],
        hard: ['TION', 'MENT', 'ABLE', 'ANCE', 'ENCE', 'ESSE', 'ETTE', 'ISME', 'ISTE', 'EUR', 'AGE']
    },
    
    init() {
        const saved = localStorage.getItem('ttb_user');
        if (saved) {
            this.state.user = saved;
            document.getElementById('username').value = saved;
        }
        
        document.getElementById('username').oninput = (e) => {
            this.state.user = e.target.value.trim();
            localStorage.setItem('ttb_user', this.state.user);
        };
        
        document.getElementById('word').onkeypress = (e) => {
            if (e.key === 'Enter') this.submit();
        };
        
        document.getElementById('join-code').onkeypress = (e) => {
            if (e.key === 'Enter') this.join();
        };
        
        this.loadDict();
        this.initPeer();
    },
    
    async loadDict() {
        const st = document.getElementById('dict-status');
        try {
            st.className = 'status loading';
            st.innerHTML = '<span class="spinner"></span><span>Chargement...</span>';
            
            const res = await fetch('https://www.lexique.org/databases/Lexique383/Lexique383.tsv');
            const txt = await res.text();
            const lines = txt.split('\n');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const cols = line.split('\t');
                if (cols.length > 0) {
                    const word = cols[0].toUpperCase().trim();
                    if (word.length >= 3 && /^[A-Z√Ä-√ø]+$/.test(word)) {
                        this.state.dict.add(word);
                    }
                }
            }
            
            st.className = 'status ready';
            st.innerHTML = `<span>‚úì</span><span>${this.state.dict.size.toLocaleString()} mots</span>`;
        } catch (e) {
            console.error('Dict error:', e);
            st.className = 'status ready';
            st.innerHTML = '<span>‚ö†</span><span>Mode hors-ligne</span>';
            this.loadFallback();
        }
    },
    
    loadFallback() {
        const words = ['MAISON', 'VOITURE', 'CHAT', 'CHIEN', 'TABLE', 'ORDINATEUR', 'TELEPHONE', 'FENETRE', 'PORTE', 'SOLEIL', 'LUNE', 'ETOILE', 'ARBRE', 'FLEUR', 'RIVIERE', 'MONTAGNE', 'PLAGE', 'VILLE', 'BONJOUR', 'BONSOIR', 'MERCI', 'PARDON'];
        words.forEach(w => this.state.dict.add(w));
    },
    
    initPeer() {
        const id = 'ttb-' + Math.random().toString(36).substr(2, 12);
        this.state.peer = new Peer(id, {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            },
            debug: 0
        });
        
        this.state.peer.on('open', (id) => {
            this.state.id = id;
            console.log('Connected:', id);
        });
        
        this.state.peer.on('connection', (conn) => {
            if (this.state.host) this.handleConn(conn);
        });
        
        this.state.peer.on('error', (e) => {
            console.error('Peer error:', e);
            this.notif('Erreur de connexion', e.message, 'error');
        });
    },
    
    showCreate() {
        if (!this.check()) return;
        
        this.state.code = this.genCode();
        this.state.host = true;
        
        this.state.game = {
            code: this.state.code,
            hostId: this.state.id,
            state: 'CONFIG',
            config: { lives: 3, timer: 15, diff: 'medium' },
            players: [{
                id: this.state.id,
                name: this.state.user,
                lives: 3,
                out: false,
                host: true
            }],
            turn: 0,
            syl: '',
            timer: 0,
            maxTimer: 15,
            words: [],
            conns: new Map()
        };
        
        document.getElementById('config-code').textContent = this.state.code;
        this.updateConfigPlayers();
        this.show('config');
    },
    
    genCode() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let code = '';
        for (let i = 0; i < 4; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    },
    
    updateRange(type) {
        const val = document.getElementById(type).value;
        document.getElementById(type + '-val').textContent = val;
        if (this.state.game) {
            if (type === 'lives') this.state.game.config.lives = parseInt(val);
            if (type === 'timer') this.state.game.config.timer = parseInt(val);
        }
    },
    
    copyCode() {
        navigator.clipboard.writeText(this.state.code)
            .then(() => this.notif('Copi√© !', 'Code copi√©', 'success'))
            .catch(() => this.notif('Erreur', 'Impossible de copier', 'error'));
    },
    
    updateConfigPlayers() {
        const cont = document.getElementById('config-players');
        const count = document.getElementById('config-count');
        
        if (!this.state.game) return;
        
        count.textContent = this.state.game.players.length;
        cont.innerHTML = '';
        
        this.state.game.players.forEach(p => {
            const div = document.createElement('div');
            div.style = 'display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 8px;';
            div.innerHTML = `
                <span style="font-size: 18px;">üë§</span>
                <span style="flex: 1; font-weight: 600;">${p.name}</span>
                ${p.host ? '<span class="badge">H√¥te</span>' : ''}
            `;
            cont.appendChild(div);
        });
        
        document.getElementById('start-btn').disabled = this.state.game.players.length < 2;
    },
    
    cancel() {
        if (confirm('Annuler la cr√©ation ?')) {
            if (this.state.game) {
                this.state.game.conns.forEach(c => c.close());
                this.state.game = null;
            }
            this.state.host = false;
            this.state.code = '';
            this.show('home');
        }
    },
    
    showJoin() {
        if (!this.check()) return;
        document.getElementById('join-modal').classList.add('active');
        document.getElementById('join-code').focus();
    },
    
    closeJoin() {
        document.getElementById('join-modal').classList.remove('active');
        document.getElementById('join-code').value = '';
    },
    
    join() {
        const code = document.getElementById('join-code').value.trim().toUpperCase();
        
        if (code.length !== 4) {
            this.notif('Code invalide', '4 caract√®res requis', 'error');
            return;
        }
        
        this.state.code = code;
        this.state.host = false;
        
        const hostId = 'ttb-room-' + code.toLowerCase();
        const conn = this.state.peer.connect(hostId);
        
        conn.on('open', () => {
            this.state.conn = conn;
            conn.send({
                type: 'JOIN',
                id: this.state.id,
                name: this.state.user
            });
            
            this.closeJoin();
            this.show('lobby');
            this.notif('Connect√© !', 'Vous avez rejoint', 'success');
        });
        
        conn.on('data', (d) => this.handleClient(d));
        conn.on('close', () => {
            this.notif('D√©connect√©', 'Connexion perdue', 'error');
            this.home();
        });
        
        conn.on('error', (e) => {
            console.error('Conn error:', e);
            this.notif('Erreur', 'Impossible de rejoindre', 'error');
            this.closeJoin();
        });
    },
    
    leave() {
        if (confirm('Quitter ?')) {
            if (this.state.conn) {
                this.state.conn.send({ type: 'LEAVE', id: this.state.id });
                this.state.conn.close();
                this.state.conn = null;
            }
            this.home();
        }
    },
    
    handleConn(conn) {
        conn.on('data', (d) => this.handleHost(d, conn));
        conn.on('close', () => this.disconnect(conn.peer));
    },
    
    handleHost(d, conn) {
        if (d.type === 'JOIN') {
            if (this.state.game.state !== 'CONFIG') {
                conn.send({ type: 'ERROR', msg: 'Partie commenc√©e' });
                conn.close();
                return;
            }
            
            if (this.state.game.players.length >= 30) {
                conn.send({ type: 'ERROR', msg: 'Complet' });
                conn.close();
                return;
            }
            
            this.state.game.players.push({
                id: d.id,
                name: d.name,
                lives: this.state.game.config.lives,
                out: false,
                host: false
            });
            
            this.state.game.conns.set(d.id, conn);
            this.notif('Nouveau joueur', d.name + ' a rejoint', 'info');
            
            conn.send({
                type: 'SYNC',
                state: this.serialize()
            });
            
            this.updateConfigPlayers();
            this.broadcast();
        }
        
        if (d.type === 'WORD') {
            const current = this.state.game.players[this.state.game.turn];
            if (current && current.id === d.id) {
                this.validate(d.word);
            }
        }
        
        if (d.type === 'LEAVE') {
            conn.close();
        }
    },
    
    disconnect(id) {
        if (!this.state.game) return;
        
        const idx = this.state.game.players.findIndex(p => p.id === id);
        if (idx !== -1) {
            const name = this.state.game.players[idx].name;
            this.state.game.players.splice(idx, 1);
            this.state.game.conns.delete(id);
            
            this.notif('Joueur parti', name, 'info');
            this.updateConfigPlayers();
            this.broadcast();
        }
    },
    
    handleClient(d) {
        if (d.type === 'SYNC') {
            this.state.game = d.state;
            
            if (d.state.state === 'PLAYING' && this.state.screen !== 'game') {
                this.show('game');
            }
            
            if (this.state.screen === 'lobby') {
                this.renderLobby();
            } else if (this.state.screen === 'game') {
                this.renderGame();
            }
        }
        
        if (d.type === 'ERROR') {
            this.notif('Erreur', d.msg, 'error');
        }
    },
    
    start() {
        if (!this.state.host || !this.state.game) return;
        if (this.state.game.players.length < 2) {
            this.notif('Erreur', 'Min. 2 joueurs', 'error');
            return;
        }
        
        const diffs = document.getElementsByName('diff');
        for (let d of diffs) {
            if (d.checked) {
                this.state.game.config.diff = d.value;
                break;
            }
        }
        
        this.state.game.players.forEach(p => {
            p.lives = this.state.game.config.lives;
            p.out = false;
        });
        
        this.state.game.state = 'PLAYING';
        this.state.game.maxTimer = this.state.game.config.timer;
        
        this.newRound();
        this.show('game');
        this.renderGame();
        this.broadcast();
        this.notif('Partie lanc√©e !', 'Bonne chance !', 'success');
    },
    
    newRound() {
        if (!this.state.game) return;
        
        const list = this.syl[this.state.game.config.diff] || this.syl.medium;
        this.state.game.syl = list[Math.floor(Math.random() * list.length)];
        this.state.game.timer = this.state.game.maxTimer;
        
        if (this.state.game.interval) {
            clearInterval(this.state.game.interval);
        }
        
        this.state.game.interval = setInterval(() => {
            this.state.game.timer -= 0.1;
            
            if (this.state.game.timer <= 0) {
                this.explode();
            } else {
                if (Math.floor(this.state.game.timer * 10) % 5 === 0) {
                    this.broadcast();
                }
            }
            
            if (this.state.screen === 'game') {
                this.updateTimer();
            }
        }, 100);
        
        this.broadcast();
    },
    
    explode() {
        if (!this.state.game) return;
        
        clearInterval(this.state.game.interval);
        this.state.game.interval = null;
        
        const curr = this.state.game.players[this.state.game.turn];
        curr.lives -= 1;
        
        this.notif('üí• BOOM !', curr.name + ' perd une vie', 'error');
        
        if (curr.lives <= 0) {
            curr.out = true;
            this.notif('‚ò†Ô∏è √âlimin√©', curr.name, 'error');
        }
        
        const alive = this.state.game.players.filter(p => !p.out);
        if (alive.length === 1) {
            this.end(alive[0]);
            return;
        }
        
        this.nextTurn();
        this.broadcast();
        
        setTimeout(() => {
            this.newRound();
        }, 2000);
    },
    
    nextTurn() {
        if (!this.state.game) return;
        
        let tries = 0;
        do {
            this.state.game.turn = (this.state.game.turn + 1) % this.state.game.players.length;
            tries++;
        } while (
            this.state.game.players[this.state.game.turn].out &&
            tries < this.state.game.players.length
        );
    },
    
    validate(word) {
        if (!this.state.game) return;
        
        word = word.trim().toUpperCase();
        const norm = word.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const sylNorm = this.state.game.syl.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        
        if (!norm.includes(sylNorm)) {
            this.notif('‚ùå Invalide', 'Syllabe absente', 'error');
            return;
        }
        
        if (this.state.game.words.includes(word)) {
            this.notif('‚ùå D√©j√† utilis√©', '', 'error');
            return;
        }
        
        if (this.state.dict.size > 0 && !this.state.dict.has(word)) {
            const unaccent = word.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            if (!this.state.dict.has(unaccent)) {
                this.notif('‚ùå Introuvable', 'Pas dans le dico', 'error');
                return;
            }
        }
        
        this.state.game.words.push(word);
        
        clearInterval(this.state.game.interval);
        this.state.game.interval = null;
        
        this.state.game.maxTimer = Math.max(3, this.state.game.maxTimer * 0.95);
        
        this.notif('‚úÖ Correct !', word, 'success');
        
        this.nextTurn();
        this.broadcast();
        
        setTimeout(() => {
            this.newRound();
        }, 1500);
    },
    
    end(winner) {
        if (!this.state.game) return;
        
        this.state.game.state = 'ENDED';
        this.state.game.winner = winner;
        
        if (this.state.game.interval) {
            clearInterval(this.state.game.interval);
            this.state.game.interval = null;
        }
        
        this.broadcast();
        this.showVictory(winner);
        
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
        });
    },
    
    submit() {
        const input = document.getElementById('word');
        const word = input.value.trim().toUpperCase();
        
        if (!word) return;
        
        if (this.state.host) {
            this.validate(word);
        } else if (this.state.conn) {
            this.state.conn.send({
                type: 'WORD',
                id: this.state.id,
                word: word
            });
        }
        
        input.value = '';
    },
    
    renderLobby() {
        if (!this.state.game) return;
        
        document.getElementById('lobby-code').textContent = this.state.game.code;
        document.getElementById('lobby-count').textContent = this.state.game.players.length;
        
        const cont = document.getElementById('lobby-players');
        cont.innerHTML = '';
        
        this.state.game.players.forEach(p => {
            const div = document.createElement('div');
            div.className = 'player' + (p.host ? ' host' : '');
            div.innerHTML = `
                <div class="player-avatar">üë§</div>
                <div class="player-name">${p.name}</div>
                ${p.host ? '<span class="badge">H√¥te</span>' : ''}
            `;
            cont.appendChild(div);
        });
    },
    
    renderGame() {
        if (!this.state.game) return;
        
        document.getElementById('game-code').textContent = this.state.game.code;
        document.getElementById('game-count').textContent = this.state.game.players.filter(p => !p.out).length;
        document.getElementById('game-words').textContent = this.state.game.words.length;
        
        document.getElementById('syl').textContent = this.state.game.syl || '...';
        
        this.updateTimer();
        
        const players = document.getElementById('game-players');
        players.innerHTML = '';
        
        this.state.game.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'player';
            
            if (i === this.state.game.turn && this.state.game.state === 'PLAYING') {
                div.classList.add('active');
            }
            
            if (p.out) {
                div.classList.add('out');
            }
            
            const hearts = '‚ù§Ô∏è'.repeat(p.lives);
            
            div.innerHTML = `
                ${i === this.state.game.turn && this.state.game.state === 'PLAYING' ? '<span class="arrow">üëâ</span>' : ''}
                <span style="font-size: 28px;">üë§</span>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 14px; overflow: hidden; text-overflow: ellipsis;">${p.name}</div>
                    <div style="font-size: 14px; margin-top: 4px;">${hearts}</div>
                </div>
            `;
            
            players.appendChild(div);
        });
        
        const myTurn = this.state.game.players[this.state.game.turn]?.id === this.state.id &&
                       this.state.game.state === 'PLAYING';
        const inputArea = document.getElementById('input-area');
        const status = document.getElementById('game-status');
        
        if (myTurn) {
            inputArea.classList.remove('hide');
            status.textContent = '';
            document.getElementById('word').focus();
        } else {
            inputArea.classList.add('hide');
            
            if (this.state.game.state === 'ENDED') {
                status.textContent = 'üèÜ Termin√© !';
            } else if (this.state.game.state === 'PLAYING') {
                const curr = this.state.game.players[this.state.game.turn];
                status.textContent = `Tour de ${curr.name}...`;
            } else {
                status.textContent = 'En attente...';
            }
        }
        
        const words = document.getElementById('used-words');
        words.innerHTML = '';
        
        this.state.game.words.slice().reverse().slice(0, 20).forEach(w => {
            const span = document.createElement('span');
            span.className = 'word';
            span.textContent = w;
            words.appendChild(span);
        });
        
        const bomb = document.getElementById('bomb');
        if (this.state.game.timer < 5 && this.state.game.state === 'PLAYING') {
            bomb.classList.add('critical');
        } else {
            bomb.classList.remove('critical');
        }
    },
    
    updateTimer() {
        if (!this.state.game) return;
        
        const pct = (this.state.game.timer / this.state.game.maxTimer) * 100;
        document.getElementById('timer-fill').style.width = pct + '%';
        document.getElementById('timer-text').textContent = this.state.game.timer.toFixed(1) + 's';
    },
    
    showVictory(winner) {
        document.getElementById('winner').textContent = winner.name;
        document.getElementById('victory').classList.add('active');
    },
    
    broadcast() {
        if (!this.state.host || !this.state.game) return;
        
        const msg = {
            type: 'SYNC',
            state: this.serialize()
        };
        
        this.state.game.conns.forEach(c => {
            try {
                c.send(msg);
            } catch (e) {
                console.error('Send error:', e);
            }
        });
        
        if (this.state.screen === 'config') {
            this.updateConfigPlayers();
        } else if (this.state.screen === 'lobby') {
            this.renderLobby();
        } else if (this.state.screen === 'game') {
            this.renderGame();
        }
    },
    
    serialize() {
        return {
            code: this.state.game.code,
            hostId: this.state.game.hostId,
            state: this.state.game.state,
            config: this.state.game.config,
            players: this.state.game.players,
            turn: this.state.game.turn,
            syl: this.state.game.syl,
            timer: this.state.game.timer,
            maxTimer: this.state.game.maxTimer,
            words: this.state.game.words,
            winner: this.state.game.winner
        };
    },
    
    check() {
        if (!this.state.user || this.state.user.length < 2) {
            this.notif('Pseudo requis', 'Min. 2 caract√®res', 'info');
            document.getElementById('username').focus();
            return false;
        }
        return true;
    },
    
    notif(title, msg, type = 'info') {
        const n = document.createElement('div');
        n.className = 'notif ' + type;
        
        const icons = {
            success: '‚úì',
            error: '‚úó',
            info: '‚Ñπ'
        };
        
        n.innerHTML = `
            <div class="notif-icon">${icons[type] || '‚Ñπ'}</div>
            <div class="notif-content">
                <div class="notif-title">${title}</div>
                <div class="notif-msg">${msg}</div>
            </div>
        `;
        
        document.body.appendChild(n);
        
        setTimeout(() => {
            n.style.animation = 'slideIn 0.3s reverse';
            setTimeout(() => n.remove(), 300);
        }, 3000);
    },
    
    show(name) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        this.state.screen = name;
    },
    
    home() {
        if (this.state.host && this.state.game) {
            this.state.game.conns.forEach(c => c.close());
        }
        
        if (this.state.conn) {
            this.state.conn.close();
            this.state.conn = null;
        }
        
        this.state.game = null;
        this.state.host = false;
        this.state.code = '';
        
        document.getElementById('victory').classList.remove('active');
        this.show('home');
    }
};

document.addEventListener('DOMContentLoaded', () => Game.init());

window.addEventListener('beforeunload', (e) => {
    if (Game.state.game && Game.state.game.state === 'PLAYING') {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>
</body>
</html>